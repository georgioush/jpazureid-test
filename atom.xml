<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Identity Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。</subtitle>
  <link href="https://georgioush.github.io/jpazureid-test/atom.xml" rel="self"/>
  
  <link href="https://georgioush.github.io/jpazureid-test/"/>
  <updated>2021-02-27T19:13:43.912Z</updated>
  <id>https://georgioush.github.io/jpazureid-test/</id>
  
  <author>
    <name>Azure Identity Support Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure AD サポートが提供する [深刻度 A の対応について]</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/support-sevA/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/support-sevA/</id>
    <published>2021-02-28T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.912Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure &amp; Identity サポート チームの関口です。</p><p>今回は、お客様が弊社サポートにお問い合わせする際にご指定いただく「深刻度 (重要度 / 緊急度) A」の詳細について紹介します。</p><p>本記事は Azure ＆ Identity (Azure AD) サポートを念頭に置いてまとめたものですが、基本的には Azure サポート全般に当てはまります。<br>どのような状況の際に「深刻度 A」での対応となるか、サポートをご利用いただく際の助けになれば幸いです。</p><br><p>Azure のサポートでは、深刻度を A ~ C に分類しています。</p><p>通常深刻度 (深刻度 B、もしくは C) は、日本時間の営業時間内 平日 9:00 ～ 17:30 (<em>) の対応のみ承っています。<br>(</em>) 土日祝日、年末年始、事前に <a href="https://aka.ms/JSupport">日本マイクロソフト サポート情報 (aka.ms/JSupport)</a> にてお知らせするサポート休業日を除く</p><p>深刻度 A の支援を提供する際の条件・対応範囲については、以下の公開情報に詳細がありますので参照ください。</p><p><a href="https://azure.microsoft.com/ja-jp/support/plans/response/">サポート プラン—サポート内容と応答性 | Microsoft Azure</a></p><p><a href="https://www.microsoft.com/ja-jp/services/professional-supportqa.aspx">プロフェッショナル サポートをご利用の皆様へ - Microsoft Services</a></p><p>深刻度 A は限定された範囲や条件での対応となるため、お客様のご状況に対して最適な深刻度 (B または C) を弊社より案内させていただく可能性がありますことをご了承いただければ幸いです。深刻度 A の対応に関する詳細な説明は以下をご参照ください。</p><br><h2 id="▼-深刻度-A-の定義"><a href="#▼-深刻度-A-の定義" class="headerlink" title="▼ 深刻度 A の定義"></a>▼ 深刻度 A の定義</h2><p>「事業に重要な影響が及ぶ場合」の案件に対するご支援が該当します。</p><p>「事業に重要な影響が及ぶ場合」とは、サーバーダウン、データベース破損やメールの滞留、多数のユーザーがログインできない等、ビジネスに多大な影響を及ぼすような危機的状況を示します。製造業であれば生産ラインが止まる、金融業であれば取引システムダウン、医療関係であれば医療行為の妨げとなるなど、お客様のビジネスに大規模な損失や影響が発生している状態です。</p><p>たとえば、以下のようなご状況は深刻度 A として対応を実施します。</p><h3 id="パターン-1"><a href="#パターン-1" class="headerlink" title="パターン 1"></a>パターン 1</h3><p>Microsoft 365 を利用しているが、 Azure AD を利用したユーザー認証に失敗し、メールを使うことができない。</p><p>⇒ 深刻度 A で対応します。なお、この場合は、大規模なデータセンター障害の可能性もありますので、先に <a href="https://status.azure.com/ja-jp/status">Azure の状態</a> や <a href="https://status.office.com/">Microsoft 365 Service health status (office.com)</a> を参照し、お客様のテナントに依存しない問題が発生していないかの確認もお勧めします。</p><h3 id="パターン-2"><a href="#パターン-2" class="headerlink" title="パターン 2"></a>パターン 2</h3><p>オンプレミスで運用しているフェデレーション サーバー (AD FS) がダウンし、 AD FS に依存する認証に失敗する。</p><p>⇒ 深刻度 A で対応します。なお、深刻度 A は復旧を目的としたご支援となるため、バックアップが存在する場合はバックアップからの復元、バックアップを利用できない場合はサーバーの再構築での対応を進め、復旧後の原因調査などは、深刻度 B または C での通常営業時間内での調査となります。</p><h3 id="パターン-3"><a href="#パターン-3" class="headerlink" title="パターン 3"></a>パターン 3</h3><p>Azure AD Connect でオンプレミスから Azure AD に同期を構成している環境で、大量のユーザー / グループを削除・変更してしまい、メールが届かなくなるなどの障害が発生した。</p><p>⇒ 深刻度 A で対応します。削除したオブジェクトの復元などは必ずしもできない場合がありますが、復旧のための支援を深刻度 A で対応します。復旧後の原因、再発防止などの支援については、深刻度 B または C での通常営業時間内での調査となります。</p><p>一方、事象が既に解消されており原因究明を目的とした調査をご希望される場合や、設定方法の How To などのアドバイザリ要素を含む支援は 深刻度 A として承ることができません。以下のような例では、深刻度 B または C での通常営業時間内の対応とさせていただいております。</p><h3 id="パターン-4"><a href="#パターン-4" class="headerlink" title="パターン 4"></a>パターン 4</h3><p>Azure AD を利用したユーザー認証に失敗する事象が発生したが、理由はわからないものの現在は解消されているように見受けられる。今のうちに原因究明を行い、再発する可能性がないことを保証したい。</p><p>⇒ 明確に事象の再発が予期されるご状況ではない場合は、深刻度 A として承ることはできません。</p><h3 id="パターン-5"><a href="#パターン-5" class="headerlink" title="パターン 5"></a>パターン 5</h3><p>Azure AD を利用した多数のユーザー認証が失敗してしまう事象が発生した。Azure AD の特定の機能が原因であることは把握しており、無効にすれば事象の回避を行うことができるが、設定変更は避けたい。</p><p>⇒ 事象の回避策がある場合は深刻度 A での対応継続はできず、基本的にはその対応による回避をお願いしております。事象回避策を実施することで、お客様の事業に重大な影響が生じることが想定される場合は、具体的な影響についてヒアリングの上、支援の判断をさせていただきます。</p><h3 id="パターン-6"><a href="#パターン-6" class="headerlink" title="パターン 6"></a>パターン 6</h3><p>プロジェクトのスケジュールの関係上、すぐに事象の原因を究明したい または 仕様の確認を行いたい。特定の日までに構築を完了させる必要があるため、本日中の解決を依頼したい。</p><p>⇒ 基本的に深刻度 A での対応を承ることはできません。このような場合、案内の時刻や日付のお約束はできませんが、通常営業時間内で可能な限り早期に案内を差し上げることができるように善処します。</p><br><h2 id="▼-支援時間"><a href="#▼-支援時間" class="headerlink" title="▼ 支援時間"></a>▼ 支援時間</h2><p>弊社営業時間以外の深夜や休日であっても、24 時間 365 日エンジニアが対応します。</p><br><h2 id="▼-支援範囲"><a href="#▼-支援範囲" class="headerlink" title="▼ 支援範囲"></a>▼ 支援範囲</h2><p>正常な状態で稼働していたサービスを危機的状況から脱却させるまでの復旧、問題回避を目的とした支援となります。仕様確認、危機的状況から脱却したあとの原因究明などは含まれません。事象の回避や復旧が完了した場合は、以降の支援は翌営業日以降での通常営業時間内での対応とさせていただきます。</p><br><h2 id="▼-支援条件"><a href="#▼-支援条件" class="headerlink" title="▼ 支援条件"></a>▼ 支援条件</h2><p>お客様がマイクロソフトの担当と常に電話で連絡が取れる状態であることが条件となります。</p><p>また、上述の通り、お客様環境を危機的状況から脱却させることを目的とした対応が深刻度 A の支援範囲となりますので、原則として、マイクロソフトの担当が依頼する切り分けや回避策の実施に全面的にご協力いただく必要があります。</p><p>なお、お客様と連絡が取れないなどの理由で、支援を満足にご提供できないと弊社が判断した場合、または、お問い合わせ内容が深刻度 A に該当しない場合、お問い合わせの深刻度を B または C に変更の上、通常営業時間内での対応とさせていただくことがあります。</p><br><h2 id="▼-その他"><a href="#▼-その他" class="headerlink" title="▼ その他"></a>▼ その他</h2><p>• お客様の問題がお客様側の設定ミスに起因する問題であり、その解消のために、弊社データ センター側へエスカレーションを実施の上、データ センター側で対応が必要な場合 (例 条件付きアクセスによる管理者のブロック) は、緊急対応による即日の対応は困難となります。</p><p>• 問題の原因が、お客様もしくはサードパーティー製のアプリケーション (モジュール) にある可能性が高いとエンジニアが判断した場合、継続の調査を承ることができません。</p><p>• Azure データ センター側に起因した問題の原因は、基本的に <a href="https://status.azure.com/ja-jp/status/history/">Azure の状態の履歴 | Microsoft Azure</a> に記載されている以上の情報開示はできません。<br>生じていた問題について問題解決の過程で判明したものであればお伝え可能ですが、原因究明それ自体を目的とした調査を承ることはできません。<br>(オンプレミス製品の原因の調査は、<a href="https://www.microsoft.com/ja-jp/services/Microsoft-Unified-Support.aspx">マイクロソフト ユニファイドサポート (旧 Premier サポート)</a> をご利用いただいている場合のみご支援が可能です)</p><p>• Professional Developer サポートは、開発環境を想定しているため、深刻度 A もしくは B をご利用いただくことはできません。</p><br><p>以上の通り、深刻度 A は限定的な支援のご提供となりますが、深刻度 B や C では、お客様の状況や実現されたい内容をしっかりとヒアリングした上で腰を据えてよりきめ細かなご支援を提供することができます。また、深刻度の差異にかかわらず、どのようなお問い合わせにつきましても、サポート担当一人ひとりが誠心誠意をもってお客様の助けになるように努めてまいりますので、どうぞよろしくお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure &amp;amp; Identity サポート チームの関口です。&lt;/p&gt;
&lt;p&gt;今回は、お客様が弊社サポートにお問い合わせする際にご指定いただく「深刻度 (重要度 / 緊急度) A」の詳細について紹介します。&lt;/p&gt;
&lt;p&gt;本記事は Azure ＆ Ide</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>条件付きアクセスで 「準拠済み」 でブロックされる場合の対処法 (iOS / Android 編)</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/conditional-access-compliant-ios-android/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/conditional-access-compliant-ios-android/</id>
    <published>2021-02-18T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.819Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure &amp; Identity サポート チームの関口です。</p><p>今回は、ご利用の端末が 「準拠済み」にもかかわらず、条件付きアクセスの「準拠済み」の設定でブロックされてしまった場合の原因と対処方法をご紹介します。</p><p>&lt;エラー コード例&gt;</p><blockquote><p>“errorCode”: 53000, “failureReason”: “Device is not in required device state: {state}. Conditional Access policy requires a compliant device, and the device is not compliant. The user must enroll their device with an approved MDM provider like Intune.”, “additionalDetails”: “Your administrator might have configured a conditional access policy that allows access to your organization’s resources only from compliant devices. To be compliant, your device must be either joined to your on-premises Active Directory or joined to your Azure Active Directory.            More details available at <a href="https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation">https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation</a></p></blockquote><blockquote><p>“errorCode”: 530003, “failureReason”: “Your device is required to be managed to access this resource.”<br>“additionalDetails”: “The requested resource can only be accessed using a compliant device. The user is either using a device not managed by a Mobile-Device-Management (MDM) agent like Intune, or it’s using an application that doesn’t support device authentication. The user could enroll their devices with an approved MDM provider, or use a different app to sign in, or find the app vendor and ask them to update their app. More details available at <a href="https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation">https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation</a></p></blockquote><br><h2 id="lt-なぜブロックされるのか？-gt"><a href="#lt-なぜブロックされるのか？-gt" class="headerlink" title="&lt;なぜブロックされるのか？&gt;"></a>&lt;なぜブロックされるのか？&gt;</h2><p>条件付きアクセスの「準拠済み」の設定は、デバイス ベースのアクセス制御となるため、”どの端末からのアクセスか？” を Azure AD が判断する必要があります。この判断のために、ご利用のデバイスは Azure AD に対して ”デバイス情報” を提示する必要があります。</p><p>ご利用の端末がデバイス情報を Azure AD に提示できない場合、Azure AD は ”どの端末からのアクセスか？” を判断することができません。つまり「準拠済み」であるかも判断することができず、ブロックされてしまいます。</p><p>ブロックされたアクセスをサインイン ログで確認すると、以下のようにデバイス ID の情報が表示されていないことがわかります。</p><p><img src="/jpazureid-test/azure-active-directory/conditional-access-compliant-ios-android/deviceid-not-displayed.png"></p><br><p>ご利用の端末の状況に応じて、以下の二つの観点で確認を行うのがスムーズです。</p><p><strong>”デバイス情報を提示できているかどうか”</strong></p><p><strong>”デバイス情報を提示できていない場合は、なぜ提示できていないのか”</strong></p><br><h2 id="lt-対処方法-gt"><a href="#lt-対処方法-gt" class="headerlink" title="&lt;対処方法&gt;"></a>&lt;対処方法&gt;</h2><p>iOS / Android でデバイス情報が提示できない原因としては、以下が挙げられます。</p><p>それぞれの項目ごとに解説します。</p><table><thead><tr><th>No.</th><th>確認ポイント</th></tr></thead><tbody><tr><td>A</td><td>準拠済み？</td></tr><tr><td>B</td><td>サポートされたブラウザーを使用している？</td></tr><tr><td>C</td><td>Edge Chromium を使用している場合、ブラウザーにサインインできている？</td></tr><tr><td>D</td><td>旧 Edge を利用している場合</td></tr><tr><td>E</td><td>証明書を提示できていない</td></tr><tr><td>F</td><td>Microsoft Authenticator をインストールしていない</td></tr><tr><td>G</td><td>アプリの実装によりデバイス情報を提示できないこともある</td></tr><tr><td>H</td><td>その他</td></tr></tbody></table><br><br><br><h2 id="A-準拠済み？"><a href="#A-準拠済み？" class="headerlink" title="A. 準拠済み？"></a>A. 準拠済み？</h2><p>利用している端末が準拠済みとなっているかを確認します。<br>Azure Portal のデバイス一覧で、対象の端末の「準拠している」の列が「はい」にセットされていれば OK です。</p><p><img src="/jpazureid-test/azure-active-directory/conditional-access-compliant-ios-android/compliant-set.png"></p><p>対象の端末が準拠していない場合は、Microsoft Endpoint Manager (Intune) の観点で、なぜ準拠済みとならないのかを調査する必要があります。</p><br><br><h2 id="B-サポートされたブラウザーを使用している？"><a href="#B-サポートされたブラウザーを使用している？" class="headerlink" title="B. サポートされたブラウザーを使用している？"></a>B. サポートされたブラウザーを使用している？</h2><p>以下の表は OS に対応したサポート ブラウザーの一覧です。(情報がアップデートされる可能性があるため、正確な情報は公開情報をご確認ください)</p><p>OS によってサポートされるブラウザーは異なるため、ご利用の端末の OS でサポートされているブラウザーを利用されているかご確認をお願いします。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-conditional-access-conditions#supported-browsers">サポートされているブラウザー - Azure Active Directory | Microsoft Docs</a></p><br><br><h2 id="C-Edge-Chromium-を使用している場合、ブラウザーにサインインしている？"><a href="#C-Edge-Chromium-を使用している場合、ブラウザーにサインインしている？" class="headerlink" title="C. Edge Chromium を使用している場合、ブラウザーにサインインしている？"></a>C. Edge Chromium を使用している場合、ブラウザーにサインインしている？</h2><p>Microsoft Edge Chromium を利用してデバイス情報を提示するためには、ブラウザーにサインインしている必要があります。</p><p><a href="https://docs.microsoft.com/ja-jp/deployedge/ms-edge-security-conditional-access">Microsoft Edge と条件付きアクセス - Azure Active Directory | Microsoft Docs</a></p><blockquote><p>エンタープライズ Azure AD 資格情報を使用して Microsoft Edge プロファイルにサインインすると、条件付きアクセスを使用して保護されたエンタープライズ クラウド リソースへのシームレスなアクセスが、Microsoft Edge によって許可されます。</p></blockquote><p>なお、旧 Edge (Microsoft Edge HTML) の場合は、プロファイルにサインインを行う機能はありません。あくまで Microsoft Edge Chromium をご利用の場合の確認となります。</p><br><br><h2 id="D-旧-Edge-を利用している場合"><a href="#D-旧-Edge-を利用している場合" class="headerlink" title="D. 旧 Edge を利用している場合"></a>D. 旧 Edge を利用している場合</h2><p>旧 Edge (Microsoft Edge HTML) を使用している場合、デバイス情報を Azure AD に適切に提示できない場合があることを確認しています。残念ながら、Microsoft Edge HTML は既に開発が終了しており、2021 年 3 月 9 日 にサポートが終了することが予定されているため、Microsoft Edge Chromium を利用いただくことを推奨しています。</p><br><br><h2 id="E-証明書を提示できていない"><a href="#E-証明書を提示できていない" class="headerlink" title="E. 証明書を提示できていない"></a>E. 証明書を提示できていない</h2><p>iOS / Android がデバイス情報を提示する仕組みは、ブラウザー アクセスの場合と、クライアント アプリの場合で異なります。</p><p>ブラウザー アクセスの場合は、iOS も Android も Azure AD に証明書を提示することでデバイス情報を渡します。</p><br><p>Android の場合、以下のように端末内に保持している証明書一覧が表示されて、どの証明書を使用するのか促されます。(既に使用する証明書が決まっていると判断されれば促されない場合もあります)</p><p>ここで適切な証明書を選択すれば、証明書の中に保存されているデバイス情報を提示し、Azure AD でデバイス ベースの条件付きアクセスの制御が可能となります。</p><p><img src="/jpazureid-test/azure-active-directory/conditional-access-compliant-ios-android/device-cert.png"></p><p>なお、ここで使用する証明書 (上記画面の証明書) は、Microsoft Endpoint Manager (Intune) ポータル サイトからインストール可能です。以下の公開情報をご参照の上、記載された画面と同様のメッセージが表示されている状況であれば、本公開情報の「ブラウザー アクセスを有効にする」手順をお試しください。</p><p><a href="https://docs.microsoft.com/ja-jp/mem/intune/user-help/your-device-is-missing-an-it-required-certificate-android">不足している必要な証明書をインストールする | Microsoft Docs</a></p><br><p>iOS の場合、Intune によるプロファイル設定が行われる際に証明書もあわせてインストールされるはずです。</p><p>iOS の [プロファイルとデバイス管理] から、Intune 用のプロファイルが既に設定されているかご確認ください。</p><p><img src="/jpazureid-test/azure-active-directory/conditional-access-compliant-ios-android/device-profile1.png"></p><p><img src="/jpazureid-test/azure-active-directory/conditional-access-compliant-ios-android/device-profile2.png"></p><p>iOS / Android を使用したブラウザー アクセスは、上記のように証明書を使用したデバイス情報の提示が可能となります。</p><p>一方で、モバイル アプリ (クライアント アプリ) の場合は、Microsoft Authenticator を使用して PRT を Azure AD に提示する必要があります。詳細は 「F. Microsoft Authenticator をインストールしていない」で説明します。</p><br><br><h2 id="F-Microsoft-Authenticator-をインストールしていない"><a href="#F-Microsoft-Authenticator-をインストールしていない" class="headerlink" title="F. Microsoft Authenticator をインストールしていない"></a>F. Microsoft Authenticator をインストールしていない</h2><p>iOS / Android を使用してモバイル アプリ (ネイティブ アプリ) にアクセスする際は、基本的に Microsoft Authenticator を使用して PRT を Azure AD に提示する必要があります。アプリの実装によっては、ブラウザーを経由してデバイス情報を提示する場合もあるため、その場合は Microsoft Authenticator  を用いずにデバイス情報を提示可能です。</p><p>以下は iPad を使用した動作サンプルとなりますが、こちらを見ていただくと Microsoft Authenticator を使用してデバイス情報を提示するシナリオのイメージが湧くかと思います。</p><p>Microsoft Teams のモバイル アプリにサインインするために資格情報を入力すると、パスワード入力画面に遷移しています。画面左上に Teams の表示がありますが、これは Microsoft Teams が呼び出した画面ではないことがわかります。なぜなら、このパスワード入力画面が Microsoft Teams が呼び出した画面であれば、画面左側に Teams への切り替えを促す表示は出ないからです。</p><p><img src="/jpazureid-test/azure-active-directory/conditional-access-compliant-ios-android/authenticator-screen1.png"></p><p>実際に、起動アプリを確認すると Microsoft Authenticator がパスワード入力画面を呼び出していることが確認できます。</p><p><img src="/jpazureid-test/azure-active-directory/conditional-access-compliant-ios-android/authenticator-screen2.png"></p><p>このことから、Microsoft Teams から Microsoft Authenticator にリダイレクトされ、この動作でパスワード入力、および PRT を Azure AD に渡しているように思われます。</p><p>※ なお、Android の場合は、このような画面遷移が行われていることを明示的に確認できませんが、同様の動作が行われているとお考えください。</p><br><br><h2 id="G-アプリの実装によりデバイス情報を提示できないこともある"><a href="#G-アプリの実装によりデバイス情報を提示できないこともある" class="headerlink" title="G. アプリの実装によりデバイス情報を提示できないこともある"></a>G. アプリの実装によりデバイス情報を提示できないこともある</h2><p>3rd Party 製のアプリケーションの場合、デバイス情報を直接 Azure AD に提示できるような実装か、Microsoft Authenticator 経由で提示できるように実装されている必要があります。3rd Party 製のアプリケーションでこのような実装が行われているかどうかは、アプリケーション ベンダーに直接ご確認いただく必要があります。</p><p>基本的に、Microsoft 製のアプリケーションは Microsoft Authenticator を使用してデバイス情報を提示するとお考え下さい。(Outlook などは Microsoft Authenticator を使用しなくてもデバイス情報を提示できるシナリオがあることを確認していますが、基本的には Microsoft Authenticator が使用されるとお考えください)</p><p>なお、モバイル デバイスに Microsoft Authenticator をインストールするだけでは不十分で、アプリケーション側が Microsoft Authenticator を使用するように実装がされている必要があります。上記の動作については、以下のアプリケーション開発者用の公開情報に記載がありますのでご参照ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/scenario-mobile-app-configuration#configure-the-application-to-use-the-broker">ブローカーを使用するようにアプリケーションを構成する - Azure Active Directory | Microsoft Docs</a></p><p>こちらは iOS / Android 端末を利用時の場合の説明となりますが、Windows 端末を使用する場合も類似の動作があります。Windows 10 端末上のデスクトップ アプリ (ネイティブ アプリ) を使用してアプリケーションにアクセスする場合、Microsoft Authenticator ではなく、Web Account Manager (WAM) と呼ばれる Windows 10 に既定で実装されているトークン ブローカーを使用して PRT を Azure AD に提示します。</p><p>Microsoft のアプリケーションは基本的に WAM に対応しているため問題ありませんが、3rd Party 製のアプリケーションは WAM に対応した実装となっていないことが考えられ、PRT を提示できないことが想定されます。こちらも正確な実装はアプリケーション ベンダーに確認いただく必要がありますが、このような動作処理が行われるために、Azure AD 側でデバイスを判断できない結果になることがあります。</p><br><br><h2 id="H-その他"><a href="#H-その他" class="headerlink" title="H. その他"></a>H. その他</h2><p>その他サポート チームで確認できている事象や仕様についてです。</p><p>・ 3rd Party 製品によってデバイス情報が提示できない</p><p>クライアント端末から Azure AD にデバイス情報を提示する経路上に、プロキシなど一部 3rd Party 製品の動作 (仕様) によって、デバイス情報が提示できない場合があることを確認しております。<br>もし切り分けの結果、ご利用の 3rd Party 製品を経由する場合のみ事象が発生するということであれば、該当のベンダーに確認のお問い合わせをいただければと思います。</p><br><br><h2 id="関連ブログ"><a href="#関連ブログ" class="headerlink" title="関連ブログ"></a>関連ブログ</h2><p><a href="https://jpazureid.github.io/blog/azure-active-directory/conditional-access-compliant-windows">Japan Azure Identity Support Blog: 条件付きアクセスで 「準拠済み」 や 「Hybrid Azure AD 参加が必要」 でブロックされる場合の対処法 (Windows 編)</a></p><p>上記内容が少しでも参考となれば幸いです。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひサポートサービスまでお問い合わせください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure &amp;amp; Identity サポート チームの関口です。&lt;/p&gt;
&lt;p&gt;今回は、ご利用の端末が 「準拠済み」にもかかわらず、条件付きアクセスの「準拠済み」の設定でブロックされてしまった場合の原因と対処方法をご紹介します。&lt;/p&gt;
&lt;p&gt;&amp;lt;エラ</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="Conditional Access" scheme="https://georgioush.github.io/jpazureid-test/tags/Conditional-Access/"/>
    
    <category term="Compliant" scheme="https://georgioush.github.io/jpazureid-test/tags/Compliant/"/>
    
  </entry>
  
  <entry>
    <title>条件付きアクセスで「準拠済み」や「Hybrid Azure AD 参加が必要」でブロックされる場合の対処法 (Windows 編)</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/conditional-access-compliant-windows/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/conditional-access-compliant-windows/</id>
    <published>2021-02-18T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.822Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure &amp; Identity サポート チームの関口です。</p><p>今回は、ご利用の端末が 「準拠済み」もしくは「Hybrid Azure AD 参加を構成済み」にもかかわらず、条件付きアクセスの「準拠済み」や「Hybrid Azure AD 参加が必要」の設定でブロックされてしまった場合の原因と対処方法をご紹介します。</p><p>&lt;エラー コード例&gt;</p><blockquote><p>“errorCode”: 53000, “failureReason”: “Device is not in required device state: {state}. Conditional Access policy requires a compliant device, and the device is not compliant. The user must enroll their device with an approved MDM provider like Intune.”, “additionalDetails”: “Your administrator might have configured a conditional access policy that allows access to your organization’s resources only from compliant devices. To be compliant, your device must be either joined to your on-premises Active Directory or joined to your Azure Active Directory.            More details available at <a href="https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation">https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation</a></p></blockquote><blockquote><p>“errorCode”: 530003, “failureReason”: “Your device is required to be managed to access this resource.”<br>“additionalDetails”: “The requested resource can only be accessed using a compliant device. The user is either using a device not managed by a Mobile-Device-Management (MDM) agent like Intune, or it’s using an application that doesn’t support device authentication. The user could enroll their devices with an approved MDM provider, or use a different app to sign in, or find the app vendor and ask them to update their app. More details available at <a href="https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation">https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-device-remediation</a></p></blockquote><br><h2 id="lt-なぜブロックされるのか？-gt"><a href="#lt-なぜブロックされるのか？-gt" class="headerlink" title="&lt;なぜブロックされるのか？&gt;"></a>&lt;なぜブロックされるのか？&gt;</h2><p>条件付きアクセスの「準拠済み」と「Hybrid Azure AD 参加が必要」の設定は、デバイス ベースのアクセス制御となるため、”どの端末からのアクセスか？” を Azure AD が判断する必要があります。この判断のために、ご利用のデバイスは Azure AD に対して ”デバイス情報” を提示する必要があります。</p><p>ご利用の端末がデバイス情報を Azure AD に提示できない場合、Azure AD は ”どの端末からのアクセスか？” を判断することができません。つまり「準拠済み」であるかも「Hybrid Azure AD 参加を構成済み」であるかも判断することができず、ブロックされてしまいます。</p><p>ブロックされたアクセスをサインイン ログで確認すると、以下のようにデバイス ID の情報が表示されていないことがわかります。</p><p><img src="/jpazureid-test/azure-active-directory/conditional-access-compliant-windows/deviceid-not-displayed.png"></p><br><p>ご利用の端末の状況に応じて、以下の二つの観点で確認を行うのがスムーズです。</p><p><strong>”デバイス情報を提示できているかどうか”</strong></p><p><strong>”デバイス情報を提示できていない場合は、なぜ提示できていないのか”</strong></p><br><h2 id="lt-対処方法-gt"><a href="#lt-対処方法-gt" class="headerlink" title="&lt;対処方法&gt;"></a>&lt;対処方法&gt;</h2><p>Windows でデバイス情報が提示できない原因としては、以下が挙げられます。</p><p>それぞれの項目ごとに解説します。</p><table><thead><tr><th>No.</th><th>確認ポイント</th></tr></thead><tbody><tr><td>A</td><td>Hybrid Azure AD 参加が構成済み？</td></tr><tr><td>B</td><td>準拠済み？</td></tr><tr><td>C</td><td>PRT 取得済み？</td></tr><tr><td>D</td><td>サポートされたブラウザーを使用している？</td></tr><tr><td>E</td><td>Chrome を使用している場合、Windows 10 Accounts 拡張機能をインストールしている？</td></tr><tr><td>F</td><td>Edge Chromium を使用している場合、ブラウザーにサインインできている？</td></tr><tr><td>G</td><td>旧 Edge を利用している場合</td></tr><tr><td>H</td><td>アプリの実装によりデバイス情報を提示できないこともある</td></tr><tr><td>I</td><td>その他</td></tr></tbody></table><br><br><h2 id="A-Hybrid-Azure-AD-参加が構成済み？"><a href="#A-Hybrid-Azure-AD-参加が構成済み？" class="headerlink" title="A. Hybrid Azure AD 参加が構成済み？"></a>A. Hybrid Azure AD 参加が構成済み？</h2><p>利用している端末が Hybrid Azure AD 参加構成済みとなっているかを確認します。<br>Azure Portal のデバイス一覧で、対象の端末の「登録済み」の列に登録日時がセットされていれば OK です。</p><p><img src="/jpazureid-test/azure-active-directory/conditional-access-compliant-windows/registered-set.png"></p><p>構成が完了していない場合は、「登録済み」の列に「保留中」と表示がされることになります。この場合は、まずは Hybrid Azure AD 参加の構成を完了させることから始めてください。</p><p>(ここでは、Hybrid Azure AD 参加の構成方法は割愛します)</p><br><br><h2 id="B-準拠済み？"><a href="#B-準拠済み？" class="headerlink" title="B. 準拠済み？"></a>B. 準拠済み？</h2><p>利用している端末が準拠済みとなっているかを確認します。<br>Azure Portal のデバイス一覧で、対象の端末の「準拠している」の列が「はい」にセットされていれば OK です。</p><p><img src="/jpazureid-test/azure-active-directory/conditional-access-compliant-windows/compliant-set.png"></p><p>対象の端末が準拠していない場合は、Microsoft Endpoint Manager (Intune) の観点で、なぜ準拠済みとならないのかを調査する必要があります。</p><br><br><h2 id="C-PRT-取得済み？"><a href="#C-PRT-取得済み？" class="headerlink" title="C. PRT 取得済み？"></a>C. PRT 取得済み？</h2><p>[A. Hybrid Azure AD 参加が構成済み？] で Hybrid Azure AD 参加が構成済み、もしくは [B. 準拠済み？] で 準拠済み となっていても、Primary Refresh Token (PRT) を取得できていないと Azure AD にデバイス情報を提示することができません。</p><p>PRT の中にはデバイス情報が含まれており、Azure AD 側が、どの端末からのアクセスなのかを判断するために使用されます。そのため、ご利用の端末で正常に PRT を取得できているか確認してください。<br>以下のコマンドの実行結果で [AzureAdPrt : NO] となっている場合は、PRT が取得できていないことになります。</p><p>dsregcmd /status</p><pre><code>+------- SSO State -------+            AzureAdPrt : NO   AzureAdPrtAuthority : NO         EnterprisePrt : NOEnterprisePrtAuthority : NO</code></pre><p>この場合は、なぜ PRT が取得できていないのか？という観点で調査を行う必要があります。</p><p>PRT が取得できない場合の対処方法としては、以下の記事をご参考ください。また、サポートによる支援も可能ですので、ご希望の場合はお問い合わせください。</p><p><a href="/blog/azure-active-directory/troubleshoot-hybrid-azure-ad-join-managed/">Hybrid Azure AD Join 失敗時の初動調査方法について (マネージド編) | Japan Azure Identity Support Blog</a>)</p><p><a href="/blog/azure-active-directory/troubleshoot-hybrid-azure-ad-join-federated/">Hybrid Azure AD Join 失敗の初動調査方法について (フェデレーション編) | Japan Azure Identity Support Blog</a>)</p><br><br><h2 id="D-サポートされたブラウザーを使用している？"><a href="#D-サポートされたブラウザーを使用している？" class="headerlink" title="D. サポートされたブラウザーを使用している？"></a>D. サポートされたブラウザーを使用している？</h2><p>OS によってサポートされるブラウザーは異なるため、以下の公開情報を元にご利用のブラウザーがサポートされているかご確認をお願いします。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-conditional-access-conditions#supported-browsers">サポートされているブラウザー - Azure Active Directory | Microsoft Docs</a></p><br><br><h2 id="E-Chrome-を使用している場合、Windows-10-Accounts-拡張機能をインストールしている？"><a href="#E-Chrome-を使用している場合、Windows-10-Accounts-拡張機能をインストールしている？" class="headerlink" title="E. Chrome を使用している場合、Windows 10 Accounts 拡張機能をインストールしている？"></a>E. Chrome を使用している場合、Windows 10 Accounts 拡張機能をインストールしている？</h2><p>Windows 10 バージョン 1703 以降で Chrome を利用してデバイス情報を提示するためには、Windows 10 Accounts 拡張機能をインストールする必要があります。Chrome をご利用の場合は、以下の公開情報の案内に沿ってインストールが可能です。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-conditional-access-conditions#chrome-support">Chrome のサポート - Azure Active Directory | Microsoft Docs</a></p><blockquote><p>Windows 10 Creators Update (バージョン 1703) 以降で Chrome をサポートするには、Windows 10 Accounts 拡張機能をインストールしてください。 条件付きアクセス ポリシーでデバイス固有の詳細が必要な場合は、この拡張機能が必要です。</p></blockquote><br><br><h2 id="F-Edge-Chromium-を使用している場合、ブラウザーにサインインしている？"><a href="#F-Edge-Chromium-を使用している場合、ブラウザーにサインインしている？" class="headerlink" title="F. Edge Chromium を使用している場合、ブラウザーにサインインしている？"></a>F. Edge Chromium を使用している場合、ブラウザーにサインインしている？</h2><p>Microsoft Edge Chromium を利用してデバイス情報を提示するためには、ブラウザーにサインインしている必要があります。</p><p><a href="https://docs.microsoft.com/ja-jp/deployedge/ms-edge-security-conditional-access">Microsoft Edge と条件付きアクセス - Azure Active Directory | Microsoft Docs</a></p><blockquote><p>エンタープライズ Azure AD 資格情報を使用して Microsoft Edge プロファイルにサインインすると、条件付きアクセスを使用して保護されたエンタープライズ クラウド リソースへのシームレスなアクセスが、Microsoft Edge によって許可されます。</p></blockquote><p>なお、旧 Edge (Microsoft Edge HTML) の場合は、プロファイルにサインインを行う機能はありません。あくまで Microsoft Edge Chromium をご利用の場合の確認となります。</p><br><br><h2 id="G-旧-Edge-を利用している場合"><a href="#G-旧-Edge-を利用している場合" class="headerlink" title="G. 旧 Edge を利用している場合"></a>G. 旧 Edge を利用している場合</h2><p>旧 Edge (Microsoft Edge HTML) を使用している場合、デバイス情報を Azure AD に適切に提示できない場合があることを確認しています。残念ながら、Microsoft Edge HTML は既に開発が終了しており、2021 年 3 月 9 日 にサポートが終了することが予定されているため、Microsoft Edge Chromium を利用いただくことを推奨しています。</p><br><br><h2 id="H-アプリの実装によりデバイス情報を提示できないこともある"><a href="#H-アプリの実装によりデバイス情報を提示できないこともある" class="headerlink" title="H. アプリの実装によりデバイス情報を提示できないこともある"></a>H. アプリの実装によりデバイス情報を提示できないこともある</h2><p>3rd Party 製のアプリケーションの場合、デバイス情報を直接 Azure AD に提示できるような実装か、Microsoft Authenticator 経由で提示できるように実装されている必要があります。3rd Party 製のアプリケーションでこのような実装が行われているかどうかは、アプリケーション ベンダーに直接ご確認いただく必要があります。</p><p>基本的に、Microsoft 製のアプリケーションは Microsoft Authenticator を使用してデバイス情報を提示するとお考え下さい。(Outlook などは Microsoft Authenticator を使用しなくてもデバイス情報を提示できるシナリオがあることを確認していますが、基本的には Microsoft Authenticator が使用されるとお考えください)</p><p>なお、モバイル デバイスに Microsoft Authenticator をインストールするだけでは不十分で、アプリケーション側が Microsoft Authenticator を使用するように実装がされている必要があります。上記の動作については、以下のアプリケーション開発者用の公開情報に記載がありますのでご参照ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/scenario-mobile-app-configuration#configure-the-application-to-use-the-broker">ブローカーを使用するようにアプリケーションを構成する - Azure Active Directory | Microsoft Docs</a></p><p>こちらは iOS / Android 端末を利用時の場合の説明となりますが、Windows 端末を使用する場合も類似の動作があります。Windows 10 端末上のデスクトップ アプリ (ネイティブ アプリ) を使用してアプリケーションにアクセスする場合、Microsoft Authenticator ではなく、Web Account Manager (WAM) と呼ばれる Windows 10 に既定で実装されているトークン ブローカーを使用して PRT を Azure AD に提示します。</p><p>Microsoft のアプリケーションは基本的に WAM に対応しているため問題ありませんが、3rd Party 製のアプリケーションは WAM に対応した実装となっていないことが考えられ、PRT を提示できないことが想定されます。こちらも正確な実装はアプリケーション ベンダーに確認いただく必要がありますが、このような動作処理が行われるために、Azure AD 側でデバイスを判断できない結果になることがあります。</p><br><br><h2 id="I-その他"><a href="#I-その他" class="headerlink" title="I. その他"></a>I. その他</h2><p>その他サポート チームで確認できている事象や仕様についてです。</p><p>・ 3rd Party 製品によってデバイス情報が提示できない</p><p>クライアント端末から Azure AD にデバイス情報を提示する経路上に、プロキシなど一部 3rd Party 製品の動作 (仕様) によって、デバイス情報が提示できない場合があることを確認しております。<br>もし切り分けの結果、ご利用の 3rd Party 製品を経由する場合のみ事象が発生するということであれば、該当のベンダーに確認のお問い合わせをいただければと思います。</p><br><br><h2 id="関連ブログ"><a href="#関連ブログ" class="headerlink" title="関連ブログ"></a>関連ブログ</h2><p><a href="https://jpazureid.github.io/blog/azure-active-directory/conditional-access-compliant-ios-android">Japan Azure Identity Support Blog: 条件付きアクセスで「準拠済み」でブロックされる場合の対処法 (iOS / Android 編)</a></p><p>上記内容が少しでも参考となれば幸いです。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひサポートサービスまでお問い合わせください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure &amp;amp; Identity サポート チームの関口です。&lt;/p&gt;
&lt;p&gt;今回は、ご利用の端末が 「準拠済み」もしくは「Hybrid Azure AD 参加を構成済み」にもかかわらず、条件付きアクセスの「準拠済み」や「Hybrid Azure AD </summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="Conditional Access" scheme="https://georgioush.github.io/jpazureid-test/tags/Conditional-Access/"/>
    
    <category term="Hybrid Azure AD Join" scheme="https://georgioush.github.io/jpazureid-test/tags/Hybrid-Azure-AD-Join/"/>
    
    <category term="Compliant" scheme="https://georgioush.github.io/jpazureid-test/tags/Compliant/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD Connect をご利用のお客様に対して予定されている多要素認証に関する変更</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/</id>
    <published>2021-02-17T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.924Z</updated>
    
    <content type="html"><![CDATA[<p>皆さんこんにちは。Azure &amp; Identity サポート チームの高田です。</p><p>本日は Azure AD Connect を利用しオンプレミス AD から Azure AD にユーザーを同期しているお客様において影響が生じる可能性のある多要素認証の動作変更についてお知らせいたします。この内容は、<a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/ba-p/1994722">Azure Active Directory Identity Blog</a> で公開されたものであり、本記事ではその内容についてより分かりやすく解説いたします。</p><h2 id="影響を受ける可能性のあるお客様"><a href="#影響を受ける可能性のあるお客様" class="headerlink" title="影響を受ける可能性のあるお客様"></a>影響を受ける可能性のあるお客様</h2><p>本記事で解説する内容で影響を受ける可能性があるのは、以下のすべての点に該当するお客様です。</p><ul><li>オンプレミス AD 上のユーザー属性に多要素認証用の電話番号を設定している。</li><li>Azure AD Connect などのアカウント同期ソリューションを利用してオンプレミス AD から Azure AD にユーザーを同期している。</li><li>管理者が PowerShell を用いて電話で多要素認証を行うようユーザー属性 (StrongAuthenticationMethods 属性) を変更をしている。</li></ul><p>上記のような状態は、ユーザーの多要素認証設定を管理者が行う場合に相当します。つまり、管理者が PowerShell を用いて多要素認証の方法 (電話番号を用いた認証）を指定し、認証に使用する電話番号はオンプレミス AD の属性から設定するという方法です。この方法をとると、ユーザーが自身で多要素認証をセットアップせずとも、管理者から多要素認証 (電話番号を用いた認証) を構成できます。</p><p>なお、Azure AD Connect などアカウント同期ソリューションを利用して電話番号を Azure AD に同期していても、管理者が各ユーザーに対して電話認証の利用を設定してない場合は本記事の影響を受けません。ただし、多要素認証用の電話番号について正しい運用方法を確認するため、いずれのお客様でも後述します対応内容をご覧いただくことをお勧めします。</p><h2 id="変更前の動作"><a href="#変更前の動作" class="headerlink" title="変更前の動作"></a>変更前の動作</h2><p>現在 Azure AD ユーザーは以下の 2 種類の電話番号を利用しています。</p><ul><li>パブリックな電話番号: ユーザーのプロファイルの一部として管理されている連絡先電話番号</li><li>認証用の電話番号: 他のユーザー (管理者を除く) からは参照できない認証専用の電話番号</li></ul><p>前述のとおり、本変更の影響を受ける可能性のあるお客様では、オンプレミス AD 上のユーザーが電話番号を保持しており、この電話番号が Azure AD Connect を利用することで Azure AD 上のユーザーにも同期される状態となります。このようにして同期された電話番号は、パブリックな電話番号として Azure AD 上に設定されます。つまり、Azure ポータルや Outlook のアドレス帳などから確認可能な電話番号として表示されます。</p><p>一方、認証用の電話番号は、ユーザーが多要素認証のセットアップを使用するか、管理者が認証方法のブレードなどを使用することで設定されます。これらの操作を明示的に行わない限りは、認証用の電話番号はユーザーに未設定の状態です。</p><p>現在の動作では、このようにして同期されたユーザーがパブリックな電話番号のみを持ち、さらに認証用の電話番号を保持していない状態で管理者が PowerShell から電話認証の利用を有効化した場合、条件付きアクセスで多要素認証が要求されると、ユーザーに設定されているパブリックな電話番号に電話認証が試行されます。つまり、Azure AD はユーザーの認証用の電話番号が未設定の場合は、代わりにパブリックな電話番号を使用して多要素認証を試行します。</p><table><thead><tr><th>パブリックな電話番号</th><th>認証用の電話番号</th></tr></thead><tbody><tr><td>携帯電話: +81 123456789</td><td>電話番号: (未設定)</td></tr><tr><td></td><td>認証方法 (StrongAuthenticationMethods): 電話認証</td></tr></tbody></table><p>例えば、ユーザーが上記のような属性を持つ状態の場合、認証用の電話番号には多要素認証の方法として電話認証の設定のみが行われており、多要素認証に使用する電話番号は設定されていません。しかしこの場合でも現状の動作では、ユーザーに多要素認証が求められるとパブリックな電話番号 (+81 123456789) が代わりに多要素認証に使用され、+81 123456789 に SMS などが送信されます。</p><h2 id="予定されている動作変更の内容"><a href="#予定されている動作変更の内容" class="headerlink" title="予定されている動作変更の内容"></a>予定されている動作変更の内容</h2><p>マイクロソフトでは、継続してユーザービリティとセキュリティに対する改善を進めており、その一環として Azure AD が保持する電話番号の扱いについてよりシンプルなモデルを採用することを検討しています。</p><p>今回予定されているのは、上記のようにパブリックな電話番号と認証方法 (電話認証) の設定を持つ一方で認証用の電話番号が未設定の同期ユーザーに対し、オンプレミス AD から同期されたパブリックな電話番号を認証用の電話番号にコピーするという対応です。また、パブリックな電話番号が認証用の電話番号にコピーされ認証用の電話番号が構成されると、Azure AD はそれ以降、認証用の電話番号に多要素認証を試行するように動作が変化します。つまり、パブリックな電話番号が代わりに多要素認証に使用されるという動作はなくなります。</p><table><thead><tr><th>パブリックな電話番号</th><th>認証用の電話番号</th></tr></thead><tbody><tr><td>携帯電話: +81 123456789</td><td>電話番号: +81 123456789 (パブリックな電話番号からコピー)</td></tr><tr><td></td><td>認証方法 (StrongAuthenticationMethods): 電話認証</td></tr></tbody></table><p>マイクロソフトでは、このように多要素認証には認証用の電話番号のみを使用する用動作を変更します。これに際し、上記条件に合致するお客様に影響が生じないようこのコピー処理を 5 月 1 日まで順次各テナントで実施します。ただし、コピー処理がいつどのタイミングで行われるかはデータセンター側での対応となり事前に確認することはできません。このためお客様におかれましては上記の変更についてご理解の上、速やかに後述する対応 (運用方法の変更) を実施くださいますようお願い申し上げます。</p><h2 id="動作変更に伴い必要となる対応"><a href="#動作変更に伴い必要となる対応" class="headerlink" title="動作変更に伴い必要となる対応"></a>動作変更に伴い必要となる対応</h2><p>以上の動作変更に伴い、多要素認証に使用する電話番号を現在オンプレミス AD 上で管理されているお客様においては、管理方法を変更いただく必要がございます。多要素認証に使用する電話番号を変更したい場合は、管理者がオンプレミス AD 上のユーザー属性 (電話番号) を変更するという方法ではなく、後述するいずれかの方法で認証用の電話番号を設定および更新するようご対応ください。</p><h3 id="Azure-ポータルからユーザーの「認証方法」ブレードを使用する"><a href="#Azure-ポータルからユーザーの「認証方法」ブレードを使用する" class="headerlink" title="Azure ポータルからユーザーの「認証方法」ブレードを使用する"></a>Azure ポータルからユーザーの「認証方法」ブレードを使用する</h3><p>管理者がユーザーの認証用電話番号を構成したい場合、Azure ポータルの Azure Active Directory ブレードから行うのが簡単です。Azure Active Directory ブレードより対象のユーザーを選択し、認証方法のブレードへお進みください。<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-userdevicesettings#add-authentication-methods-for-a-user">この方法</a> によりポータルの画面からユーザーの認証用電話番号を直接変更いただけます。</p><p><img src="/jpazureid-test/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/bh1.png"></p><h3 id="Microsoft-Graph-API-の-authentication-methods-エンドポイントを使用する"><a href="#Microsoft-Graph-API-の-authentication-methods-エンドポイントを使用する" class="headerlink" title="Microsoft Graph API の authentication/methods エンドポイントを使用する"></a>Microsoft Graph API の authentication/methods エンドポイントを使用する</h3><p>管理者がユーザーの認証用電話番号を構成する方法としては、直接 <a href="https://docs.microsoft.com/ja-jp/graph/authenticationmethods-get-started">Microsoft Graph API の authentication/methods エンドポイント</a> を使用する方法もございます。API を直接操作したい場合は本方法をご利用ください。</p><p><img src="/jpazureid-test/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/bh2.png"></p><h3 id="Microsoft-Graph-Identity-Signins-PowerShell-を使用する"><a href="#Microsoft-Graph-Identity-Signins-PowerShell-を使用する" class="headerlink" title="Microsoft.Graph.Identity.Signins PowerShell を使用する"></a>Microsoft.Graph.Identity.Signins PowerShell を使用する</h3><p>Microsoft Graph API を直接操作することが難しい場合は、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-userdevicesettings#manage-methods-using-powershell">Microsoft.Graph.Identity.Signins PowerShell コマンド</a> から同様の操作を実施いただけます。</p><p><img src="/jpazureid-test/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/bh3.png"></p><h3 id="ユーザーが自ら-MyAccount-ページから設定する"><a href="#ユーザーが自ら-MyAccount-ページから設定する" class="headerlink" title="ユーザーが自ら MyAccount ページから設定する"></a>ユーザーが自ら MyAccount ページから設定する</h3><p>エンドユーザーが自ら認証用電話番号を構成することも可能です。この場合は、ユーザー自ら <a href="http://myaccount.microsoft.com/">MyAccount</a> にアクセスし、セキュリティ情報のタブから認証用電話番号を追加ください。</p><p><img src="/jpazureid-test/azure-active-directory/upcoming-changes-to-managing-mfa-methods-for-hybrid-customers/bh4.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;皆さんこんにちは。Azure &amp;amp; Identity サポート チームの高田です。&lt;/p&gt;
&lt;p&gt;本日は Azure AD Connect を利用しオンプレミス AD から Azure AD にユーザーを同期しているお客様において影響が生じる可能性のある多要素認証の動</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="MFA" scheme="https://georgioush.github.io/jpazureid-test/tags/MFA/"/>
    
    <category term="Azure AD Connect" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD-Connect/"/>
    
  </entry>
  
  <entry>
    <title>条件付きアクセスによりディレクトリ同期が失敗する場合の対処方法について</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory-connect/directory-synchronization-accounts/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory-connect/directory-synchronization-accounts/</id>
    <published>2021-02-17T01:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.642Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの田中です。</p><p> <br>今回は、比較的多くのお客様からお問い合わせをいただく、条件付きアクセスの利用を開始した環境において、ディレクトリ同期が失敗するという事象の対処方法の一例を紹介します。 </p><p><strong>読者のターゲット</strong> : テナントのグローバル管理者。条件付きアクセスおよび Azure AD Connect を操作できることが前提となります。 </p><p>Azure AD Connect は、オンプレミス AD から Azure AD に情報を同期するため、Azure AD 側に Azure AD コネクタ アカウントと呼ばれる (既定では UPN が “Sync_” から始まるアカウント)、Azure AD Connect が同期に使用するための専用アカウントがあります。   </p><p>この Azure AD コネクタ アカウントが条件付きアクセスでブロックされると、Azure AD Connect によるディレクトリ同期が行われなくなります。 </p><p>そのため、Azure AD 側では、Azure AD コネクタ アカウントが条件付きアクセスでブロックされないように、本アカウントを意味する “ディレクトリ同期アカウント” というロールを個別に用意し、条件付きアクセスの適用対象外ロールとして選択できるようになっています。 </p><p>具体的には、お客様環境における条件付きアクセス ポリシーにて、下記の手順をもとにディレクトリロールの観点で設定を行います。</p><h2 id="条件付きアクセスの適用「対象外」に-Azure-AD-コネクタ-アカウントのディレクトリ-ロールを指定する方法"><a href="#条件付きアクセスの適用「対象外」に-Azure-AD-コネクタ-アカウントのディレクトリ-ロールを指定する方法" class="headerlink" title="条件付きアクセスの適用「対象外」に Azure AD コネクタ アカウントのディレクトリ ロールを指定する方法"></a>条件付きアクセスの適用「対象外」に Azure AD コネクタ アカウントのディレクトリ ロールを指定する方法</h2><p>▼手順</p><ol><li><p>Azure ポータル (<a href="https://portal.azure.com/">https://portal.azure.com</a>) に、グローバル管理者 (全体管理者) でサインインをします。 </p></li><li><p>[Azure Active Directory] &gt; [セキュリティ] &gt; [条件付きアクセス] の順にクリックします。 </p></li><li><p>変更を行う条件付きアクセスのポリシーをクリックします。 </p></li><li><p>[割り当て] 配下にある [ユーザーとグループ] をクリックし、下記の設定を追加します。 </p><p>[対象] : 特に追加の設定は不要です。 </p><p>[対象外] : [ディレクトリ ロール] にチェックを入れた後、[ディレクトリ同期アカウント] にチェックを入れるという追加の設定を行います。</p><p><img src="/jpazureid-test/azure-active-directory-connect/directory-synchronization-accounts/image01.png"></p></li><li><p>[保存] をクリックします。 </p></li></ol><p>設定手順は以上となります。 </p><h2 id="どのようなときに、Azure-AD-コネクタ-アカウントのサインインに問題が発生していると判断すればいいのか"><a href="#どのようなときに、Azure-AD-コネクタ-アカウントのサインインに問題が発生していると判断すればいいのか" class="headerlink" title="どのようなときに、Azure AD コネクタ アカウントのサインインに問題が発生していると判断すればいいのか"></a>どのようなときに、Azure AD コネクタ アカウントのサインインに問題が発生していると判断すればいいのか</h2><p>Azure AD コネクタ アカウントのサインインは、Azure AD Connect 新規インストール時からその後の定期的な同期処理においても発生します。</p><p>そのため、Azure AD コネクタ アカウントによるサインインに問題が発生している場合は、Azure AD Connect 構成ウィザードにおける画面がしばらくしても進まない動作や、Azure AD のサインイン ログにおいて当該アカウントによるサインインの失敗状況が確認される可能性が考えられます。 </p><p>なお、Azure AD コネクタ アカウントについては、明示的に管理者などのユーザーがサインインを行うものではなく、Azure AD Connect 新規インストール時やその後の定期的な同期処理のタイミングで、自動で当該アカウントによるサインインが行われるものとお考えください。 </p><p>下記では、Azure AD コネクタ アカウントに対して MFA が要求されるようにポリシーを構成している場合の確認例について、Azure AD Connect 構成ウィザードにおける画面、および Azure AD 対話型サインイン ログの観点でご紹介します。 </p><p><strong>▼ Azure AD Connect 構成ウィザードにおける画面</strong></p><p>例えば、Azure AD Connect 新規インストール時、下記のような “構成中” の画面で、しばらく時間が経過しても画面が変わらない (“接続の検証” 画面に進まない) 場合は、Azure AD Connect 構成ウィザード画面とは別のウィンドウにて、Azure AD コネクタ アカウントに対して、ユーザー名とパスワード &amp; MFA による認証が求められている可能性があります。</p><p>その場合は、画面上でパスワードを入力するなどの対処を行うことはできません。</p><p><img src="/jpazureid-test/azure-active-directory-connect/directory-synchronization-accounts/image02.png"></p><p><strong>▼ Azure AD 対話型サインイン ログ</strong></p><p>例えば、ユーザー名が “Sync_” から始まる値で検索フィルターをかけると (通常は Azure AD コネクタ アカウントが検索対象として表示されるのが想定されます)、下記のように Azure AD コネクタ アカウントに対して MFA が要求されているために、当該アカウントによるサインインに失敗していることが確認できます。</p><p><img src="/jpazureid-test/azure-active-directory-connect/directory-synchronization-accounts/image03.png"></p><p>本エラーが確認できた場合は、条件付きアクセスにて対処を実施します。 </p><p>上記内容が少しでも参考となりますと幸いです。</p><p>なお、製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポート サービスをご利用ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの田中です。&lt;/p&gt;
&lt;p&gt; &lt;br&gt;今回は、比較的多くのお客様からお問い合わせをいただく、条件付きアクセスの利用を開始した環境において、ディレクトリ同期が失敗するという事象の対処方法の一例を紹介します。
 &lt;/p&gt;</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="Conditional Access" scheme="https://georgioush.github.io/jpazureid-test/tags/Conditional-Access/"/>
    
    <category term="Azure AD Connect" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD-Connect/"/>
    
    <category term="Directory Synchronization Accounts" scheme="https://georgioush.github.io/jpazureid-test/tags/Directory-Synchronization-Accounts/"/>
    
  </entry>
  
  <entry>
    <title>AD FS 証明書利用者信頼 に登録している Office 365 のフェデレーション メタデータの更新が検知された場合の対処方法について</title>
    <link href="https://georgioush.github.io/jpazureid-test/active-directory-federation-service/adfs-federation-metadata/"/>
    <id>https://georgioush.github.io/jpazureid-test/active-directory-federation-service/adfs-federation-metadata/</id>
    <published>2021-02-14T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.563Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。 Azure Identity チームの山口です。</p><p>2021 年 1 月中旬頃より AD FS と信頼関係を結んでいる Office 365 (Azure AD) の証明書利用者信頼の「監視」のタブに下記画面ショットのようにフェデレーション メタデータの更新が検知されたことを知らせる警告メッセージに関するお問い合わせを多くいただいております。</p><p><img src="/jpazureid-test/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-001.jpg"></p><p>本 Blog の記事ではフェデレーション メタデータに関する説明と更新影響の有無、また、お客様よりよくいただいておりますご質問内容について Q&amp;A 形式で記載いたします。</p><h2 id="このメッセージの意味"><a href="#このメッセージの意味" class="headerlink" title="このメッセージの意味"></a>このメッセージの意味</h2><p>AD FS 側ではなく、連携している証明書利用者信頼 (サービス側) のフェデレーション メタデータが更新されたことを示します。<br>本記事では、証明書利用者信頼が  Office 365 (Azure AD) の場合についてご案内いたします。</p><h2 id="このフェデレーション-メタデータは何に使われているのか"><a href="#このフェデレーション-メタデータは何に使われているのか" class="headerlink" title="このフェデレーション メタデータは何に使われているのか"></a>このフェデレーション メタデータは何に使われているのか</h2><p>Office 365 (Azure AD)  のフェデレーション メタデータの実体は、 URL 「 <a href="https://nexus.microsoftonline-p.com/federationmetadata/2007-06/federationmetadata.xml">https://nexus.microsoftonline-p.com/federationmetadata/2007-06/federationmetadata.xml</a> 」  になり、ブラウザーで URL をクリックすると XML 形式のメタデータの中身を実際に確認できます。</p><p>このフェデレーションメタデータには、Azure AD が AD FS など別の IdP と認証連携をする場合に必要となる、Azure AD 側の情報が含まれています。<br>具体的には、IdP で認証を行った後にトークンを送信するエンドポイントや、発行されたトークンで利用できるサービスの識別子、また IdP に送信する認証リクエストの署名に利用される証明書などが含まれています。</p><p>AD FS などの IdP 側でも同様の情報をメタデータとして保持しており、認証連携する際には、お互いにデータの交換をして相手の情報を保持します。<br>つまり、AD FS のフェデレーションメタデータは Office 365 (Azure AD) 側にインポートし、Office 365 (Azure AD) 側のフェデレーションメタデータは AD FS 側にインポートして、お互いの情報を交換することで認証連携を行います。</p><p>今回の警告メッセージは、Office 365 (Azure AD) 側のフェデレーションメタデータが更新されたことを AD FS が検知して表示しているものです。</p><p>ここからは、上述の内容を踏まえまして、お客様より多くいただいておりますご質問内容についてそれぞれ Q&amp;A 形式で回答いたします。</p><h2 id="Q-なぜ警告が検知されたのか"><a href="#Q-なぜ警告が検知されたのか" class="headerlink" title="Q. なぜ警告が検知されたのか"></a>Q. なぜ警告が検知されたのか</h2><p>A. Azure AD Connect を利用したり、Powershell モジュールを利用して Office 365 (Azure AD) と AD FS の間にフェデレーション信頼を結んだ場合、「証明書利用者を監視する」にチェックが自動的に入ります。</p><p>このチェックが入っている場合、24 時間に 1 回の頻度で対象のフェデレーション メタデータに更新があるかどうかのチェックを行います。</p><p>逆に申し上げますと、「証明書利用者を監視する」にチェックが入っていない場合は、 Azure AD フェデレーション メタデータに更新があったとしても検知できないので、警告が表示されることもありません。<br>また、監視のチェックに加えて「証明書利用者を自動的に更新する」にチェックが入っている場合には、更新を検知すると自動的に AD FS は変更を反映する動作となり、この場合にも警告が表示されることはありません。</p><h2 id="Q-更新すると影響が出るのか。"><a href="#Q-更新すると影響が出るのか。" class="headerlink" title="Q. 更新すると影響が出るのか。"></a>Q. 更新すると影響が出るのか。</h2><p>A. 原則、影響はございません。<br>影響が及ぶような大きな変更がなされる場合には、事前に情報公開されることが想定されます。<br>基本的には、常に最新のメタデータに更新されることをお勧めいたします。</p><h2 id="Q-更新する方法-警告を解消する方法-について教えてください"><a href="#Q-更新する方法-警告を解消する方法-について教えてください" class="headerlink" title="Q. 更新する方法 (警告を解消する方法) について教えてください"></a>Q. 更新する方法 (警告を解消する方法) について教えてください</h2><p>A. フェデレーション メタデータの更新方法は、手動と自動 2 通りの方法があります。</p><p>手動で更新する場合は、証明書利用者信頼の一覧から「Microsoft Office 365 Identity Platform」を右クリックすることで表示される「フェデレーションメタデータから更新」を選択します。</p><p><img src="/jpazureid-test/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-002.jpg"></p><p>下記画面がポップアップ表示されますので「更新」をクリックします。</p><p><img src="/jpazureid-test/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-003.jpg"></p><p>フェデレーション メタデータからの最終更新日が手動更新を行った日時に更新されていることを確認します。</p><p><img src="/jpazureid-test/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-004.jpg"></p><p>自動で更新を行いたい場合には、下記画面ショットにあります「証明書利用者を自動的に更新する」にチェックを入れ「適用」をクリックすることで、AD FS サーバーが 24 時間に 1 回の頻度で Azure AD フェデレーション メタデータの構成を確認し、構成の内容が変更されている場合に、自動的にフェデレーション メタデータの内容に沿って更新を行います。</p><p><img src="/jpazureid-test/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-005.jpg"></p><h2 id="Q-更新しなくても問題はないのか"><a href="#Q-更新しなくても問題はないのか" class="headerlink" title="Q. 更新しなくても問題はないのか"></a>Q. 更新しなくても問題はないのか</h2><p>A. これまでに、更新しないことで影響が出るようなメタデータの変更は行われたことがございません。<br>影響が及ぶような大きな変更がなされる場合には、事前に情報公開をする予定です。<br>実際に、「証明書利用者を監視する」のチェックを外して監視を行わずに、クローズドな環境で運用されているお客様もいらっしゃいます。<br>ただし、可能な場合には、Azure AD フェデレーションメタデータの更新を検知できるようにし、更新を検知した際には更新ができるようにする運用を推奨いたします。</p><h2 id="Q-AD-FS-のトークン署名証明書などとの関連はないのか"><a href="#Q-AD-FS-のトークン署名証明書などとの関連はないのか" class="headerlink" title="Q. AD FS のトークン署名証明書などとの関連はないのか"></a>Q. AD FS のトークン署名証明書などとの関連はないのか</h2><p>A.  今回ご案内している警告は、AD FS と連携している証明書利用者信頼 (Azure AD) 側のメタデータが変更されたことを検知しているもので、AD FS 側のトークン署名証明書とは関連はありません。<br>以下の「トークン署名証明書」、「トークン暗号化解除証明書」は、AD FS 側のフェデレーションメタデータに含まれるものであり、Office 365 (Azure AD) などのサービス側でインポート、更新が必要となるものです。</p><p><img src="/jpazureid-test/active-directory-federation-service/adfs-federation-metadata/adfs-federation-metadata-006.jpg"></p><h2 id="Q-今後も-Azure-AD-フェデレーション-メタデータが更新される可能性はあるのか。"><a href="#Q-今後も-Azure-AD-フェデレーション-メタデータが更新される可能性はあるのか。" class="headerlink" title="Q. 今後も Azure AD  フェデレーション メタデータが更新される可能性はあるのか。"></a>Q. 今後も Azure AD  フェデレーション メタデータが更新される可能性はあるのか。</h2><p>A. ございます。<br>AD FS 側で更新されないことで影響が出るような大きな変更の場合には、事前に情報公開する予定ではありますが、可能な場合には更新を検知し、最新の状態に反映していただく運用をお勧めいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。 Azure Identity チームの山口です。&lt;/p&gt;
&lt;p&gt;2021 年 1 月中旬頃より AD FS と信頼関係を結んでいる Office 365 (Azure AD) の証明書利用者信頼の「監視」のタブに下記画面ショットのようにフェデレーション メタデ</summary>
      
    
    
    
    
    <category term="AD FS" scheme="https://georgioush.github.io/jpazureid-test/tags/AD-FS/"/>
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>条件付きアクセスの 検索 / 並び替え/ 絞り込み 機能がパブリック プレビューとなりました !</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/search-sort-and-filter-for-ca/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/search-sort-and-filter-for-ca/</id>
    <published>2021-02-09T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.903Z</updated>
    
    <content type="html"><![CDATA[<p>本記事は、 2021 年 2 月 1 日に Azure Active Directory Identity Blog に公開された記事 (Search, Sort, and Filter for Conditional Access is now in public preview!) の抄訳です。原文は <a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/search-sort-and-filter-for-conditional-access-is-now-in-public/ba-p/1994699">こちら</a> より参照ください。</p><hr><p>Azure ポータル上で Azure AD  条件付きアクセス ポリシーを検索、並び替え、絞り込みする機能がパブリック プレビューとなりました。これは Azure AD のフィードバック フォーラムで最もリクエストされていたものの 1 つであり、ポリシーの管理が一段と楽になります。この機能は 2021 年 2 月 1 日から全テナントに順次展開され、数週間後には全テナントで利用できるようになる予定です。</p><br><h2 id="検索-Search"><a href="#検索-Search" class="headerlink" title="検索 (Search)"></a>検索 (Search)</h2><p>条件付きアクセス ポリシーの一覧ページに検索バーが追加され、特定のポリシーをすばやく簡単に名前から見つけることができるようになりました。検索では、ポリシー名のリストに対して、「～から始まる (starts-with)」と部分文字列検索が自動的に実行されます。部分文字列検索は、全単語、部分単語に対して実行され、特殊文字のサポートが含まれています。検索は大文字小文字を区別しません。<br>例えば、「Devices」を検索すると、「Devices」をポリシー名に含む「compliant devices」と「managed devices」の両方のポリシーが検索結果として表示されます。</p><p><img src="/jpazureid-test/azure-active-directory/search-sort-and-filter-for-ca/001.png"></p><br><h2 id="並び替え-Sort"><a href="#並び替え-Sort" class="headerlink" title="並び替え (Sort)"></a>並び替え (Sort)</h2><p>ポリシーのリストを、ポリシー名、状態、作成日、および更新日で並べ替えることができます。各列の見出しの右側にある矢印を使用して、昇順または降順でリストを並べ替えることができます。</p><p><img src="/jpazureid-test/azure-active-directory/search-sort-and-filter-for-ca/002.png"></p><br><h2 id="絞り込み-Filter"><a href="#絞り込み-Filter" class="headerlink" title="絞り込み (Filter)"></a>絞り込み (Filter)</h2><p>検索やソートだけでなく、状態、作成時刻、変更時刻でポリシーリストを絞り込みすることもできます。</p><p><img src="/jpazureid-test/azure-active-directory/search-sort-and-filter-for-ca/003.png"></p><br><p>最後に、ポリシーの一覧ページでポリシー数を表示するように改善しました。これにより、設定したポリシーの総数を確認できるようになりました。また、検索または絞り込みを適用した場合、全ポリシー数のうちいくつのポリシーが該当したかを確認いただけます。</p><p><img src="/jpazureid-test/azure-active-directory/search-sort-and-filter-for-ca/004.png"></p><br><p>世界中で、過去 30 日間で 18,000 を超えるポリシーが作成されました。条件付きアクセスの検索、並び替え、絞り込み機能を活用し、多くのポリシーの中から目的のポリシーを見つけていただければ幸いです。</p><p>これまでの数々のフィードバックを提供いただいたことに Azure  AD チームを代表してお礼申し上げます。Azure AD 条件付きアクセスの管理エクスペリエンスを弊社が改善できるよう引き続きフィードバックの共有にご協力いただけますと幸いです。</p><p>いつものように、<a href="https://feedback.azure.com/forums/169401-azure-active-directory">Azure フォーラム</a> や Twitter @AzureAD を通じて、この機能に関する質問やフィードバックを共有いただければと思います。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本記事は、 2021 年 2 月 1 日に Azure Active Directory Identity Blog に公開された記事 (Search, Sort, and Filter for Conditional Access is now in public pre</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="Conditional Access" scheme="https://georgioush.github.io/jpazureid-test/tags/Conditional-Access/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD B2C のキホンとよくある質問</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/azure-ad-b2c-fundamentals/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/azure-ad-b2c-fundamentals/</id>
    <published>2021-01-14T01:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.781Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity サポートの埴山です。</p><p>Azure AD B2C は非常に多機能な ID 基盤ですが、誤った利用方法を検討いただいていたり、本来利用方法として想定されない構成についてご質問いただいたりすることがございます。本記事では Azure AD B2C をご利用いただくにあたり、抑えていただきたい Azure AD B2C の基本的な考え方をご案内し、併せてよくあるご質問について回答します。</p><h2 id="Azure-AD-B2C-のキホン"><a href="#Azure-AD-B2C-のキホン" class="headerlink" title="Azure AD B2C のキホン"></a>Azure AD B2C のキホン</h2><p>まず、Azure AD B2C は Microsoft が提供する ID 管理基盤で、いわゆる IDaaS と呼ばれるサービスです。Azure AD がエンタープライズ (企業など組織で働くユーザー) 向けの ID 管理基盤であるのに対し、Azure AD <strong>B2C</strong> は、コンシューマー (ショッピング サイトの利用者など一般ユーザー) の ID 管理を目的としている点が大きく異なります。</p><p>さて、コンシューマーのアカウントといわれても、想像がしづらいと思いますので、Azure AD B2C のドキュメントにある以下の例で具体的に考えていきましょう。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/overview#example-woodgrove-groceries">Azure Active Directory B2C とは | Microsoft Docs</a></li></ul><p><img src="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/media/overview/woodgrove-overview.png"></p><h3 id="サンプル-シナリオ"><a href="#サンプル-シナリオ" class="headerlink" title="サンプル シナリオ"></a>サンプル シナリオ</h3><p>WoodGrove 社はあるスーパーマーケット WoodGrove Groceries を経営する会社です。WoodGrove Groceries のオンライン ショッピング サイトに利用者をサインインさせたり、利用者の ID を管理したりするために Azure AD B2C を利用しています。ユーザーはサインアップ ページより、Google アカウントや Facebbok アカウントなどのソーシャル アカウントまたはメール アドレスでサインアップを行い、ショッピングを楽しめます。</p><p>同時に、WoodGrove 社では従業員のユーザー管理に Azure AD を利用しています。Azure AD B2C と Azure AD を使い分ける理由とは何でしょうか。</p><h3 id="Azure-AD-と-Azure-AD-B2C-の違い"><a href="#Azure-AD-と-Azure-AD-B2C-の違い" class="headerlink" title="Azure AD と Azure AD B2C の違い"></a>Azure AD と Azure AD B2C の違い</h3><p>それぞれのサービスを利用するユーザーはこのようになっています。</p><table><thead><tr><th></th><th>対象のシステム</th><th>対象ユーザー</th></tr></thead><tbody><tr><td>Azure AD</td><td>WoodGrove 社の社内システム</td><td>WoodGrove 社の社員や派遣社員</td></tr><tr><td>Azure AD B2C</td><td>WoodGrove Groceries のショッピング サイト</td><td>オンライン ショッピングの利用ユーザー</td></tr></tbody></table><p>もう少しそれぞれのサービスに求められる特徴を考えてみます。</p><h4 id="Azure-AD-に求められる特徴"><a href="#Azure-AD-に求められる特徴" class="headerlink" title="Azure AD に求められる特徴"></a>Azure AD に求められる特徴</h4><p>まず WoodGrove 社のユーザーを管理できるという観点では、会社の管理者がテナントのあらゆる設定を管理できることが望ましいでしょう。さらに、管理部門や人事部門には、ユーザー管理の権限を適切に割り当てられる必要があります。また、Office 365 や SaaS アプリをユーザーに使わせることや、オンプレミスの Active Directory との同期も必要かもしれません。</p><p>外部ユーザーとの連携を行いたい場合には、その外部ユーザーをゲスト ユーザーとして招待することで自社の Azure AD で管理されるサービスを、外部ユーザーに利用させるシーンもあるかもしれません。</p><p>このため、WoodGrove 社の ID 管理基盤に求められる機能は以下のとおりとなります。</p><ul><li>管理権限の適切な委譲</li><li>Microsoft 365 サービスの利用</li><li>組織が管理する SaaS アプリとの連携</li><li>オンプレミスの Active Directory との連携</li><li>ゲスト ユーザーを招待する B2B 機能</li></ul><p>このように、Azure AD には、会社組織の中で適切に権限を設定し委任できるような管理機能が提供されています。また、各ユーザーは既定でお互いのユーザーを参照し連携できるなど、利用者が同一組織のメンバーであることを前提に設計されています。</p><h4 id="Azure-AD-B2C-に求められる特徴"><a href="#Azure-AD-B2C-に求められる特徴" class="headerlink" title="Azure AD B2C に求められる特徴"></a>Azure AD B2C に求められる特徴</h4><p>一方で、WoodGrove Groceries (ショッピング サイト) の会員管理サービスに必要な機能は何でしょうか。まずサービスを利用するにあたり、サインイン画面やサインアップ画面のカスタマイズが必要です。また、ユーザー自身が属性情報を変更できるプロフィール編集画面やパスワード リセット機能、ユーザー属性を外部の身分確認サービスと連携する API 連携といった機能が必要となる場合もあるでしょう。</p><p>このため、WoodGrove Groceries の ID 管理基盤に求められる機能は以下のとおりとなります。</p><ul><li>ユーザーが自身で会員登録を行えるセルフサインアップ機能</li><li>サインアップ時に名前や住所、電話番号などのユーザー属性を収集する機能</li><li>ブランド イメージに合わせたサインイン画面のカスタマイズ</li><li>ユーザーが自身で行えるプロフィールやパスワード変更 (リセット) 機能</li><li>本人確認や身分確認のためのサービスとの連携機能</li></ul><p>Azure AD B2C では上述のとおり、コンシューマー ユーザーを管理することが目的であり、会社組織のアカウント管理で有用な機能は利用できない、あるいはコンシューマー ユーザーには適用できない場合がございます。</p><p>もし、あなたが自社組織の ID を管理しようとしており、その管理のための機能が必要な場合、Azure AD B2C は適切なソリューションではない可能性があります。つまり、求める機能は Azure AD B2C では実現できない、あるいは自身で細かい実装が必要になる可能性がありますのでご注意ください。</p><h4 id="Azure-AD-B2C-以外に自テナントのリソースを他者に利用させるソリューション"><a href="#Azure-AD-B2C-以外に自テナントのリソースを他者に利用させるソリューション" class="headerlink" title="Azure AD B2C 以外に自テナントのリソースを他者に利用させるソリューション"></a>Azure AD B2C 以外に自テナントのリソースを他者に利用させるソリューション</h4><p>Azure AD B2C を利用せず自テナントのリソースを他者に利用させたい場合、Azure AD の以下の方法が代替策になる可能性があります。</p><ul><li>既存の Azure AD テナントに外部ユーザーを B2B ユーザーとしてゲスト招待し、組織内のアプリケーションにサインインをさせる (シングル テナント アプリ)</li><li>マルチテナント アプリケーションを作成し、すべての Azure AD テナントのユーザーがサインイン可能なアプリを作る</li></ul><p>たとえば、自組織内の Office 365 のリソースを外部ユーザーにも参照させたいときには Azure AD B2B を使用し、また Azure AD を利用する他社組織へのサービス提供 (SaaS アプリの開発) を考えている場合には、マルチテナント アプリケーションを構成するのが適切でしょう。</p><p>以下に、外部のユーザーをアプリにサインアップ、サインインさせる際のソリューションについて簡単な比較表を作成しましたので参考にしてください。</p><p><img src="/jpazureid-test/azure-active-directory/azure-ad-b2c-fundamentals/compare-external-identities.png"></p><p>詳しくは、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/external-identities/compare-with-b2c">外部 ID の比較 - Azure Active Directory | Microsoft Docs</a> をご確認ください。</p><h3 id="Azure-AD-B2C-の機能"><a href="#Azure-AD-B2C-の機能" class="headerlink" title="Azure AD B2C の機能"></a>Azure AD B2C の機能</h3><p>ここからは、もう少し詳しく Azure AD B2C の動作について確認していきます。</p><p><a href="https://woodgrovedemo.com/Account/LogIn">WoodGrove Groceries</a> では新規ユーザーの登録時に、Google や Facebook などのソーシャル アカウントまたは、既存のメール アドレスを指定してセルフサインアップを行えます。</p><p><img src="/jpazureid-test/azure-active-directory/azure-ad-b2c-fundamentals/woodgrove-signup.png"></p><p>この際、ユーザー フローに設定された属性値をもとに、サインアップと同時に氏名、メールアドレス、規約への同意情報などを収集します。</p><p><img src="/jpazureid-test/azure-active-directory/azure-ad-b2c-fundamentals/woodgrove-signup-local-account.png"></p><p>現実世界のネット ショップでは、生年月日、電話番号、住所などの属性も収集が必要でしょう。また Azure AD B2C が標準で対応している本人確認はメールアドレスの確認のみですが、必要に応じて外部サービスや、独自の API との連携で本人確認を実施することも可能です。サインアップが完了すると、Azure AD B2C テナント上にユーザーが作成され、サインアップ時に利用したアカウント情報 (ソーシャル アカウントの情報、あるいはメール アドレス情報) と属性値が Azure AD 上に記録されます。</p><p>このように作成されたユーザーは “コンシューマー ユーザー” とよばれます。大まかな Azure AD B2C を構成するコンポーネントの関係について、図にまとめましたので参考にしてください。</p><p><img src="/jpazureid-test/azure-active-directory/azure-ad-b2c-fundamentals/azure-ad-b2c-tenant-overview.png"></p><p>コンシューマー ユーザーは、赤枠のフローを通してサインアップ・サインインを行い、アプリに対してトークンを発行することが可能です。</p><p>ユーザー フローなどの設定は管理用アカウントである B2B ユーザーやテナントの組織ユーザーに管理権限を付与し設定を行います。Azure AD B2C ではトークンに含まれる属性情報などを細かくカスタマイズする、条件付きアクセス ポリシーを構成し必要に応じて多要素認証を求める、API コネクターやカスタム ポリシーを利用して API 連携を行うなど、アプリに合わせた認証・認可フローを構成することが可能です。</p><p><img src="/jpazureid-test/azure-active-directory/azure-ad-b2c-fundamentals/azure-ad-b2c-customize-flow.png"></p><blockquote><p>※ カスタム ポリシーは既定で用意されている ID プロバイダーとユーザー フローで要望を実現できない場合に、より高度なカスタマイズを実現するための ID プロフェッショナル向けの機能です。Azure AD B2C をご利用いただく際には、まずは既定で用意されている ID プロバイダーとユーザー フローにて要件を満たせるか検討いただくことを推奨します。</p></blockquote><h2 id="よくあるご質問"><a href="#よくあるご質問" class="headerlink" title="よくあるご質問"></a>よくあるご質問</h2><p>ここからは、上記の前提事項を踏まえ、よくある質問について回答いたします。</p><h3 id="Azure-AD-B2C-テナントの管理画面にアクセスするにはどうすればよいですか"><a href="#Azure-AD-B2C-テナントの管理画面にアクセスするにはどうすればよいですか" class="headerlink" title="Azure AD B2C テナントの管理画面にアクセスするにはどうすればよいですか"></a>Azure AD B2C テナントの管理画面にアクセスするにはどうすればよいですか</h3><p>Azure AD B2C はサブスクリプションに紐づくリソースではありますが、サブスクリプションが紐づくテナントとは別の Azure AD テナント上に機能が提供されています。そのため、管理者が Azure AD B2C テナントへアクセスするには、以下の手順でアクセス先のテナントを切り替える必要があります。</p><ol><li>Azure ポータルにアクセスします。</li><li>右上のユーザーアイコンをクリックし、<code>ディレクトリの切り替え</code> をクリックします。</li><li>作成した Azure AD B2C テナントを選択します。</li></ol><p>あるいは Azure AD B2C テナントのテナント ID を、<code>https://portal.azure.com/&lt;tenant id&gt;</code> のように指定してブラウザーからアクセスすることでも、Azure AD B2C テナントに切り替えいただけます。</p><p>なお、Azure ポータルから Azure AD B2C テナントにアクセスしてユーザー (<a href="mailto:&#x61;&#100;&#x6d;&#105;&#110;&#64;&#x63;&#x6f;&#110;&#116;&#111;&#115;&#x6f;&#98;&#x32;&#99;&#x2e;&#111;&#110;&#x6d;&#105;&#x63;&#114;&#x6f;&#x73;&#111;&#102;&#x74;&#46;&#99;&#111;&#x6d;">&#x61;&#100;&#x6d;&#105;&#110;&#64;&#x63;&#x6f;&#110;&#116;&#111;&#115;&#x6f;&#98;&#x32;&#99;&#x2e;&#111;&#110;&#x6d;&#105;&#x63;&#114;&#x6f;&#x73;&#111;&#102;&#x74;&#46;&#99;&#111;&#x6d;</a> など) を作成いただき、グローバル管理者権限を付与することで、このユーザーを管理者としてご利用いただくことも可能です。その場合、直接 Azure AD B2C テナントにアクセスするためテナントの切り替えが不要となるほか、<a href="https://developer.microsoft.com/ja-jp/graph/graph-explorer">Graph Explorer</a> などで Azure AD B2C テナントに対して API 呼び出しを実施いただくことも可能になります。このため、検証用に Azure AD B2C テナントに対しメンバー ユーザーとして管理ユーザーを作成いただくことをお勧めします。</p><h3 id="Azure-AD-B2C-のコンシューマー-ユーザー-アカウントとはなんですか"><a href="#Azure-AD-B2C-のコンシューマー-ユーザー-アカウントとはなんですか" class="headerlink" title="Azure AD B2C のコンシューマー ユーザー アカウントとはなんですか"></a>Azure AD B2C のコンシューマー ユーザー アカウントとはなんですか</h3><p>Azure AD B2C のサインアップ フローで作成されたアカウントは、コンシューマー ユーザー アカウントと呼ばれます。コンシューマー ユーザー アカウントは、サインアップ フロー以外に Azure ポータル、あるいは Microsoft Graph API を利用して作成することが可能です。</p><p>技術的にはコンシューマー アカウントは、連携している IdP のアカウント情報、またはローカル アカウントのメール アドレスを “ID プロパティ” として保持しています。ID プロパティ (identities 属性) のほか、表示名 (DisplayName) や拡張属性 (extension) を Microsoft Graph API を利用することで編集、またはユーザーの新規作成を行うことが可能です。</p><p>詳細については、以下の公開情報をご確認ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/manage-user-accounts-graph-api">Microsoft Graph API を使用してユーザーを管理する - Azure AD B2C | Microsoft Docs</a></li></ul><h3 id="Azure-AD-B2C-の職場アカウント-管理ユーザー-とは何ですか"><a href="#Azure-AD-B2C-の職場アカウント-管理ユーザー-とは何ですか" class="headerlink" title="Azure AD B2C の職場アカウント (管理ユーザー) とは何ですか"></a>Azure AD B2C の職場アカウント (管理ユーザー) とは何ですか</h3><p>Azure AD B2C テナントにはコンシューマー ユーザー以外にも、管理用の Azure AD ユーザーを登録することが可能です。これらの職場アカウント (B2B ゲストユーザーを含む) は管理ユーザーとして Azure AD を直接利用することができ、Azure ポータルにサインインをしユーザーを操作を行う、Microsoft Graph API を呼び出すといったことが可能です。上記の <a href="mailto:&#97;&#x64;&#109;&#x69;&#x6e;&#x40;&#99;&#x6f;&#x6e;&#116;&#111;&#x73;&#x6f;&#98;&#x32;&#99;&#x2e;&#111;&#110;&#x6d;&#105;&#99;&#114;&#111;&#x73;&#111;&#x66;&#x74;&#x2e;&#x63;&#111;&#x6d;">&#97;&#x64;&#109;&#x69;&#x6e;&#x40;&#99;&#x6f;&#x6e;&#116;&#111;&#x73;&#x6f;&#98;&#x32;&#99;&#x2e;&#111;&#110;&#x6d;&#105;&#99;&#114;&#111;&#x73;&#111;&#x66;&#x74;&#x2e;&#x63;&#111;&#x6d;</a> がこの例に該当します。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/user-overview">Azure Active Directory B2C のユーザー アカウントの概要 | Microsoft Docs</a></li></ul><p>Azure AD B2C テナントは、通常の Azure AD テナントを拡張して作成されております。そのため多くの Azure AD 機能を利用いただけますが、Azure AD B2C の管理領域とそれらは分けて考えることが重要です。管理ユーザーは従来の Azure AD テナントのユーザーと同等であり、グローバル管理者のディレクトリ ロールを割り当てることで、ユーザー フローを含めたテナントの設定を行うことが可能です。</p><p>上記のとおり、ユーザー ストア等は従来の Azure AD と Azure AD B2C のコンシューマー アカウントで共用であり、管理ユーザーは Azure AD ユーザー管理機能 (Microsoft Graph API や Azure ポータル上での操作) を利用してコンシューマー ユーザー アカウントを含めたユーザーを管理することが可能です。</p><p>なお、職場アカウントはあくまで管理用のユーザーであり、Azure AD B2C のユーザー フローで利用することはできません。上記図の赤枠で囲われた部分が Azure AD B2C の機能ですが、これらの機能は通常の Azure AD テナント上に拡張機能として実装されており、コンシューマー ユーザー アカウントのみが利用することを想定しております。</p><h3 id="他テナントの-Azure-AD-ユーザーをコンシューマー-アカウントとして利用することは可能ですか"><a href="#他テナントの-Azure-AD-ユーザーをコンシューマー-アカウントとして利用することは可能ですか" class="headerlink" title="他テナントの Azure AD ユーザーをコンシューマー アカウントとして利用することは可能ですか"></a>他テナントの Azure AD ユーザーをコンシューマー アカウントとして利用することは可能ですか</h3><p>他テナントのユーザーを B2B 招待 (管理ユーザーとして招待) ではなく、コンシューマー ユーザーとして作成したい場合には、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/identity-provider-azure-ad-single-tenant?pivots=b2c-user-flow">特定の Azure Active Directory 組織用のサインインを設定</a> しサインアップとサインインのフローを構成ください。</p><p>連携先のテナントに作成いただく Azure AD アプリにてサインイン可能なユーザーを設定することで、Azure AD B2C テナントにサインアップできるユーザーを制限することも可能です。アクセスできるユーザーを制限するには、エンタープライズ アプリケーションの<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/manage-apps/assign-user-or-group-access-portal">ユーザーの割り当てを有効</a>に設定し、アプリにアクセスを許可するユーザーを割り当てます。</p><h3 id="Azure-AD-B2C-のユーザー-フローで取得したトークンで-Microsoft-Graph-API-を呼び出せますか？"><a href="#Azure-AD-B2C-のユーザー-フローで取得したトークンで-Microsoft-Graph-API-を呼び出せますか？" class="headerlink" title="Azure AD B2C のユーザー フローで取得したトークンで Microsoft Graph API を呼び出せますか？"></a>Azure AD B2C のユーザー フローで取得したトークンで Microsoft Graph API を呼び出せますか？</h3><p>いいえ、Azure AD B2C のユーザー フローはお客様のアプリ用のトークンのみを発行し、Microsoft Graph API を呼び出すためのトークンを発行することはできません。</p><p>Azure AD B2C のサインイン アップ フローやサインイン フロー、b2clogin.com の認証エンドポイントから発行されるトークンは、ある意味 Azure AD の領域とは切り離されており、お客様独自のアプリケーション内でのみ利用できるものとなっています。</p><p>もう少し、技術的な説明を付け加えると、<a href="https://docs.microsoft.com/ja-jp/graph/auth/auth-concepts">Microsoft Graph API を呼び出すために必要なトークン</a> は、issuer が <code>https://login.microsoftonline.com/&lt;tenantid&gt;/v2.0</code> などである必要がありますが、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/tokens-overview">Azure AD B2C のユーザー フローで発行されるトークン</a> の issuer は <code>https://&lt;tenantname&gt;.b2clogin.com/&lt;tenantid&gt;/v2.0/</code> となります。このように、Issuer が異なるため、Azure AD B2C が発行するトークンを Microsoft Graph API に対して利用することはできません。Azure AD B2C のユーザー フローで発行されるトークンは、B2C アプリの閉じた世界でのみ利用できるものとなります。</p><p>Microsoft Graph API を呼び出すユース ケースがある場合、アプリ側で Azure AD の <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow">OAuth 2.0 クライアント資格情報フロー</a> などを利用して Microsoft Graph API 用のトークンを取得ください。例えばお客様側で API を用意いただき、その API 内部で Microsoft Graph API 用のトークン取得と Microsoft Graph API の呼び出しを行うといった実装が考えられます。</p><h3 id="Azure-AD-B2C-テナントに登録できるアプリの種類について教えてください。"><a href="#Azure-AD-B2C-テナントに登録できるアプリの種類について教えてください。" class="headerlink" title="Azure AD B2C テナントに登録できるアプリの種類について教えてください。"></a>Azure AD B2C テナントに登録できるアプリの種類について教えてください。</h3><p>Azure AD B2C のユーザー フローを利用する B2C アプリを登録できます。それに加え、通常の Azure AD テナント同様に、シングルテナント アプリケーション、マルチテナント アプリケーションの登録も可能です。</p><p>前者のユーザー フローを利用する B2C アプリは <code>&lt;tenantname&gt;.b2clogin.com</code> のエンドポイントで認証し、Azure AD B2C の世界のトークンを発行します。これに対して、後者のシングルテナントおよびマルチテナント アプリケーションは管理用アプリとして <code>login.microsoftonline.com</code> のエンドポイントで認証し、Microsoft Graph API の呼び出しなどに利用します。</p><p>テナントの管理ユーザー権限あるいはサービス プリンシパル権限で Microsoft Graph API を呼び出すには、テナントにシングルテナント (またはマルチテナント) アプリを登録ください。</p><h3 id="Azure-AD-B2C-の料金について詳しく教えてください"><a href="#Azure-AD-B2C-の料金について詳しく教えてください" class="headerlink" title="Azure AD B2C の料金について詳しく教えてください"></a>Azure AD B2C の料金について詳しく教えてください</h3><p>2021/1 現在、料金は Azure AD の External Identity と同様で以下のページよりご確認いただけます。</p><ul><li><a href="https://azure.microsoft.com/ja-jp/pricing/details/active-directory/external-identities/">料金 - Active Directory 外部 ID | Microsoft Azure</a></li></ul><h3 id="Azure-AD-B2C-テナントに-Azure-AD-Connect-を利用しオンプレミス-AD-のユーザーを同期するのは可能ですか？"><a href="#Azure-AD-B2C-テナントに-Azure-AD-Connect-を利用しオンプレミス-AD-のユーザーを同期するのは可能ですか？" class="headerlink" title="Azure AD B2C テナントに Azure AD Connect を利用しオンプレミス AD のユーザーを同期するのは可能ですか？"></a>Azure AD B2C テナントに Azure AD Connect を利用しオンプレミス AD のユーザーを同期するのは可能ですか？</h3><p>いいえ、Azure AD B2C テナントでは Azure AD Connect をご利用いただくことはできません。お客様独自のアプリを開発し、Microsoft Graph API を利用して Azure AD B2C テナントにユーザーを同期することは可能ですが、上述の利用シーンを確認いただき、組織ユーザーを Azure AD B2C に連携することが適切か再度ご検討ください。</p><h3 id="Azure-AD-B2C-の-Premium-P1-と-P2-ライセンスで利用できる機能は何ですか"><a href="#Azure-AD-B2C-の-Premium-P1-と-P2-ライセンスで利用できる機能は何ですか" class="headerlink" title="Azure AD B2C の Premium P1 と P2 ライセンスで利用できる機能は何ですか"></a>Azure AD B2C の Premium P1 と P2 ライセンスで利用できる機能は何ですか</h3><p>2021/1 現在、Azure AD B2C のコンシューマー アカウント向けに、条件付きアクセス ポリシーの利用 (P1)、リスクベースの条件付きアクセス ポリシーの利用 (P2) が可能です。現時点では Azure AD Premium の機能であるアプリおよびロールへのグループ ベースの割り当てや Azure AD の組織アカウント向けの Identity Protection などの機能は B2C テナント管理ユーザー向けには利用できません。</p><h3 id="コンシューマー-ユーザー-アカウントのパスワードをリセットするにはどうすればよいですか"><a href="#コンシューマー-ユーザー-アカウントのパスワードをリセットするにはどうすればよいですか" class="headerlink" title="コンシューマー ユーザー アカウントのパスワードをリセットするにはどうすればよいですか"></a>コンシューマー ユーザー アカウントのパスワードをリセットするにはどうすればよいですか</h3><p>コンシューマー ユーザー (ローカル アカウント) のパスワード リセットを Azure ポータルから実施すると、パスワード プロファイルの <code>forceChangePasswordNextSignIn</code> が <code>true</code> となり、一部のユーザー フローでサインインの失敗が発生します。</p><p>そのためパスワード リセットは Microsoft Graph API や Azure AD PowerShell モジュールを利用し、<code>forceChangePasswordNextSignIn</code> を <code>false</code> に設定したうえで更新ください。</p><p>▽ Graph API の例</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">PATCH https://graph.microsoft.com/v1.0/users/&lt;対象ユーザーのオブジェクト ID&gt;</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">    &quot;passwordProfile&quot;: &#123;</span><br><span class="line">        &quot;password&quot;: &quot;password-value&quot;,</span><br><span class="line">        &quot;forceChangePasswordNextSignIn&quot;: false</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;passwordPolicies&quot;: &quot;DisablePasswordExpiration&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>▽ Azure AD PowerShell モジュールでの例</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-AzureAD</span> <span class="literal">-TenantId</span> &lt;B2C tenant 名&gt;</span><br><span class="line"><span class="variable">$password</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="literal">-String</span> &lt;パスワードの値&gt; <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">Set-AzureADUserPassword</span> <span class="literal">-ObjectId</span> &lt;対象ユーザーのオブジェクト ID&gt; <span class="literal">-Password</span> <span class="variable">$password</span> <span class="literal">-ForceChangePasswordNextLogin</span> <span class="variable">$false</span> </span><br></pre></td></tr></table></figure><h3 id="コンシューマー-ユーザー-アカウントのパスワードに有効期限を定めることは可能ですか"><a href="#コンシューマー-ユーザー-アカウントのパスワードに有効期限を定めることは可能ですか" class="headerlink" title="コンシューマー ユーザー アカウントのパスワードに有効期限を定めることは可能ですか"></a>コンシューマー ユーザー アカウントのパスワードに有効期限を定めることは可能ですか</h3><p>パスワード有効期限の通知機能や、強制更新機能は Azure AD B2C の標準機能としては提供しておりません。</p><p>Azure AD B2C では、お客様が設定可能なパスワードのポリシーとして NIST SP 800-63 をベースに機能を実装しております。NIST SP 800-63 では、頻繁なパスワード変更や、複雑なパスワード ポリシーはエンドユーザーの利便性を下げるだけではなく、セキュリティの向上に寄与しないことを指摘しています。</p><p>必要に応じてカスタム ポリシーでの実装をご検討ください。</p><ul><li><a href="https://github.com/azure-ad-b2c/samples/tree/master/policies/force-password-reset-after-90-days">samples/policies/force-password-reset-after-90-days at master · azure-ad-b2c/samples</a></li></ul><h3 id="XXXX-の機能について、カスタム-ポリシーを利用すればを実現可能ですか"><a href="#XXXX-の機能について、カスタム-ポリシーを利用すればを実現可能ですか" class="headerlink" title="XXXX の機能について、カスタム ポリシーを利用すればを実現可能ですか"></a>XXXX の機能について、カスタム ポリシーを利用すればを実現可能ですか</h3><p>弊社ではカスタム ポリシーの利用例として、以下の GitHub リポジトリにてサンプルを公開しています。まずは実現したいことが以下のサンプルにあるかを確認ください。</p><ul><li><a href="https://github.com/azure-ad-b2c/samples">azure-ad-b2c/samples: Azure AD B2C Identity Experience Framework sample User Journeys.</a></li></ul><p>カスタム ポリシーは非常に柔軟な連携や構成が可能なため、ある意味イチからプログラミングをしてアプリケーションを作成する程度の自由度があります。一方で構成が非常に複雑であり、仕組みの理解や適切な利用には十分な学習と検証が必要です。弊社サポートとしては Azure AD B2C の機能自体についてのご質問については回答可能ですが、特定の要件に合わせた詳細なカスタマイズ手順のご案内については、別途コンサルティング サービス、あるいはコミュニティー (Stack overflow) サポートの利用をご検討ください。</p><ul><li><a href="https://stackoverflow.com/questions/tagged/azure-ad-b2c">Newest ‘azure-ad-b2c’ Questions - Stack Overflow</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity サポートの埴山です。&lt;/p&gt;
&lt;p&gt;Azure AD B2C は非常に多機能な ID 基盤ですが、誤った利用方法を検討いただいていたり、本来利用方法として想定されない構成についてご質問いただいたりすることがございます。本記事では A</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="Azure AD B2C" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD-B2C/"/>
    
  </entry>
  
  <entry>
    <title>Hybrid Azure AD Join とユーザーの UPN</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/haadj-and-upn/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/haadj-and-upn/</id>
    <published>2021-01-04T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.845Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの 姚 (ヨウ) です。</p><p>今回は Hybrid Azure AD Join を構成した際の、デバイスにログオンするユーザーの UPN とドメイン名の関係について説明します。<br>この内容は以下の公開情報で説明されておりますが、今回はより分かりやすい解説を目指します。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/devices/hybrid-azuread-join-plan#review-on-premises-ad-users-upn-support-for-hybrid-azure-ad-join">ハイブリッド Azure AD 参加でのオンプレミス AD ユーザー UPN サポートを確認する</a></p><p>ご存じの通り、Hybrid Azure AD Join した端末へユーザーがログオンすると、SSO や条件付きアクセスに利用される PRT を取得します。</p><p>PRT を正常に取得するためには、デバイスが正常に Hybrid Azure AD Join した状態として登録されている必要がありますが、ユーザーの UPN も正しく構成されている必要があります。<br>PRT を正常に取得するために、どのようにユーザーの UPN を構成するべきかをフェデレーション認証とクラウド認証でそれぞれ解説します。<br>ご参考にいただければと思います。</p><h2 id="クラウド認証のユーザーの場合"><a href="#クラウド認証のユーザーの場合" class="headerlink" title="クラウド認証のユーザーの場合"></a>クラウド認証のユーザーの場合</h2><ul><li>Windows 10 1803 以降のバージョンを対象です。</li><li>ユーザーがいる Azure AD テナントとデバイスが Hybrid Azure AD Join として登録する Azure AD テナントは同じである前提です。</li><li>ユーザーがいる Azure AD テナントとデバイスが Hybrid Azure AD Join として登録する Azure AD テナントは異なる場合、Hybrid Azure AD Join として構成できません。</li></ul><p>以下の表にオンプレミス AD と AAD のユーザーの UPN のパターンごとに PRT を正常に取得できるかどうかをまとめいたしました。</p><table><thead><tr><th align="center"></th><th align="center">パターン A</th><th align="center">パターン B</th><th align="center">パターン C</th></tr></thead><tbody><tr><td align="center">オンプレミス AD 側の UPN</td><td align="center"><a href="mailto:&#x78;&#x78;&#x78;&#x78;&#x78;&#64;&#99;&#111;&#110;&#116;&#111;&#115;&#111;&#x2e;&#108;&#111;&#99;&#x61;&#x6c;">&#x78;&#x78;&#x78;&#x78;&#x78;&#64;&#99;&#111;&#110;&#116;&#111;&#115;&#111;&#x2e;&#108;&#111;&#99;&#x61;&#x6c;</a></td><td align="center"><a href="mailto:&#x78;&#120;&#x78;&#120;&#x78;&#64;&#x63;&#111;&#x6e;&#116;&#111;&#115;&#111;&#x2e;&#x63;&#x6f;&#46;&#x6a;&#112;">&#x78;&#120;&#x78;&#120;&#x78;&#64;&#x63;&#111;&#x6e;&#116;&#111;&#115;&#111;&#x2e;&#x63;&#x6f;&#46;&#x6a;&#112;</a></td><td align="center"><a href="mailto:&#120;&#120;&#120;&#120;&#x78;&#64;&#99;&#x6f;&#x6e;&#x74;&#111;&#x73;&#111;&#x2e;&#x63;&#x6f;&#109;">&#120;&#120;&#120;&#120;&#x78;&#64;&#99;&#x6f;&#x6e;&#x74;&#111;&#x73;&#111;&#x2e;&#x63;&#x6f;&#109;</a></td></tr><tr><td align="center">Azure AD 側の UPN</td><td align="center"><a href="mailto:&#x78;&#120;&#120;&#x78;&#120;&#64;&#x63;&#111;&#x6e;&#116;&#x6f;&#115;&#x6f;&#x2e;&#x63;&#x6f;&#109;">&#x78;&#120;&#120;&#x78;&#120;&#64;&#x63;&#111;&#x6e;&#116;&#x6f;&#115;&#x6f;&#x2e;&#x63;&#x6f;&#109;</a></td><td align="center"><a href="mailto:&#120;&#x78;&#120;&#x78;&#120;&#x40;&#x63;&#x6f;&#110;&#x74;&#111;&#x73;&#x6f;&#x2e;&#x63;&#x6f;&#109;">&#120;&#x78;&#120;&#x78;&#120;&#x40;&#x63;&#x6f;&#110;&#x74;&#111;&#x73;&#x6f;&#x2e;&#x63;&#x6f;&#109;</a></td><td align="center"><a href="mailto:&#120;&#120;&#x78;&#120;&#x78;&#64;&#99;&#x6f;&#110;&#x74;&#x6f;&#115;&#x6f;&#46;&#x63;&#x6f;&#x6d;">&#120;&#120;&#x78;&#120;&#x78;&#64;&#99;&#x6f;&#110;&#x74;&#x6f;&#115;&#x6f;&#46;&#x63;&#x6f;&#x6d;</a></td></tr><tr><td align="center">Azure AD に登録されているカスタムドメイン</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td></tr><tr><td align="center">PRT を取得</td><td align="center">できない</td><td align="center">できる</td><td align="center">できる</td></tr></tbody></table><p>上記の表を言葉で説明しますと、以下です。<br>ユーザーのオンプレミス AD の UPN と Azure AD 側の UPN は同じ場合、正常に PRT を取得できます。<br>ユーザーのオンプレミス AD の UPN と Azure AD 側の UPN は異なっても、オンプレミス AD の UPN のドメイン名は Azure AD テナントのカスタムドメインとして登録されば、PRT を取得できます。</p><h2 id="フェデレーション認証のユーザーの場合"><a href="#フェデレーション認証のユーザーの場合" class="headerlink" title="フェデレーション認証のユーザーの場合"></a>フェデレーション認証のユーザーの場合</h2><ul><li>Windows 10 1803 以降のバージョンを対象です。</li><li>ユーザーがいる Azure AD テナントとデバイスが Hybrid Azure AD Join として登録する Azure AD テナントは同じである前提です。</li><li>ユーザーがいる Azure AD テナントとデバイスが Hybrid Azure AD Join として登録する Azure AD テナントは異なる場合、Hybrid Azure AD Join として構成できません。</li></ul><p>フェデレーション ユーザーの場合は比較的わかりやすいです。</p><p>AD FS のフェデレーション環境でオンプレミス AD と AAD のユーザーの UPN が異なっても、代替ログイン ID を構成していれば、ユーザーは正常に PRT を取得できます。<br>もちろん、ユーザーのオンプレミス AD と Azure AD の UPN は同じで、代替ログイン ID を利用しない構成でも、正常に PRT を取得できます。</p><p>クラウド認証と同じく表にまとめてみました。</p><table><thead><tr><th align="center"></th><th align="center">パターン A</th><th align="center">パターン B</th><th align="center">パターン C</th></tr></thead><tbody><tr><td align="center">オンプレミス AD 側の UPN</td><td align="center"><a href="mailto:&#x78;&#x78;&#120;&#x78;&#x78;&#64;&#x63;&#x6f;&#110;&#x74;&#111;&#x73;&#111;&#x2e;&#108;&#x6f;&#x63;&#x61;&#x6c;">&#x78;&#x78;&#120;&#x78;&#x78;&#64;&#x63;&#x6f;&#110;&#x74;&#111;&#x73;&#111;&#x2e;&#108;&#x6f;&#x63;&#x61;&#x6c;</a></td><td align="center"><a href="mailto:&#x78;&#120;&#120;&#x78;&#x78;&#x40;&#99;&#x6f;&#x6e;&#116;&#111;&#115;&#111;&#x2e;&#x63;&#111;&#46;&#x6a;&#x70;">&#x78;&#120;&#120;&#x78;&#x78;&#x40;&#99;&#x6f;&#x6e;&#116;&#111;&#115;&#111;&#x2e;&#x63;&#111;&#46;&#x6a;&#x70;</a></td><td align="center"><a href="mailto:&#x78;&#x78;&#x78;&#120;&#x78;&#x40;&#x63;&#x6f;&#110;&#116;&#x6f;&#115;&#111;&#x2e;&#99;&#111;&#x6d;">&#x78;&#x78;&#x78;&#120;&#x78;&#x40;&#x63;&#x6f;&#110;&#116;&#x6f;&#115;&#111;&#x2e;&#99;&#111;&#x6d;</a></td></tr><tr><td align="center">Azure AD 側の UPN</td><td align="center"><a href="mailto:&#120;&#120;&#120;&#120;&#120;&#x40;&#x63;&#x6f;&#110;&#116;&#x6f;&#x73;&#111;&#x2e;&#x63;&#x6f;&#x6d;">&#120;&#120;&#120;&#120;&#120;&#x40;&#x63;&#x6f;&#110;&#116;&#x6f;&#x73;&#111;&#x2e;&#x63;&#x6f;&#x6d;</a></td><td align="center"><a href="mailto:&#x78;&#x78;&#x78;&#x78;&#x78;&#64;&#x63;&#x6f;&#110;&#x74;&#111;&#x73;&#x6f;&#46;&#99;&#111;&#x6d;">&#x78;&#x78;&#x78;&#x78;&#x78;&#64;&#x63;&#x6f;&#110;&#x74;&#111;&#x73;&#x6f;&#46;&#99;&#111;&#x6d;</a></td><td align="center"><a href="mailto:&#x78;&#120;&#x78;&#x78;&#120;&#64;&#99;&#111;&#x6e;&#116;&#x6f;&#115;&#x6f;&#46;&#99;&#x6f;&#x6d;">&#x78;&#120;&#x78;&#x78;&#120;&#64;&#99;&#111;&#x6e;&#116;&#x6f;&#115;&#x6f;&#46;&#99;&#x6f;&#x6d;</a></td></tr><tr><td align="center">Azure AD に登録されているカスタムドメイン</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td><td align="center">contoso.com<br>contoso.co.jp<br>contoso.jp</td></tr><tr><td align="center">PRT を取得</td><td align="center">できる</td><td align="center">できる</td><td align="center">できる</td></tr></tbody></table><p>AD FS のフェデレーション環境での代替ログイン ID の構成は一般的に以下の理由によって利用されます。</p><p>・ユーザーのオンプレミス AD の UPN のドメインは Azure AD のカスタムドメインとして登録していない<br>・ユーザーのオンプレミス AD の UPN とメールドレスが異なり、Office 365 などのクラウド アプリケーションへのサインイン時にメールアドレスを利用する</p><p>代替ログイン ID の詳細については、<a href="https://docs.microsoft.com/ja-jp/windows-server/identity/ad-fs/operations/configuring-alternate-login-id">代替ログイン ID を構成する</a> をご参照ください。</p><p>製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供させていただきますので、ぜひ弊社サポート サービスをご利用ください。<br>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの 姚 (ヨウ) です。&lt;/p&gt;
&lt;p&gt;今回は Hybrid Azure AD Join を構成した際の、デバイスにログオンするユーザーの UPN とドメイン名の関係について説明します。&lt;br&gt;この内容は</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="HAADJ" scheme="https://georgioush.github.io/jpazureid-test/tags/HAADJ/"/>
    
    <category term="UPN" scheme="https://georgioush.github.io/jpazureid-test/tags/UPN/"/>
    
  </entry>
  
  <entry>
    <title>生体情報 - どうか指紋情報が漏洩しませんように！</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/biometrics-keep-your-fingers-close/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/biometrics-keep-your-fingers-close/</id>
    <published>2020-12-28T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.809Z</updated>
    
    <content type="html"><![CDATA[<p>本記事は、 2020 年 5 月 26 日に Azure Active Directory Identity Blog に公開された記事 (Biometrics – Keep Your Fingers Close) を翻訳したものです。原文は <a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/biometrics-keep-your-fingers-close/ba-p/1276934">こちら</a> より参照ください。</p><hr><p>「利用者がシステムに立ち寄って指紋をスキャンすると (もしくはカメラを見つめるかマイクに話しかけると)、あっという間にログインできるようなシステムが欲しい」。こんなご要望を特に製造業、政府系サービス、自動発券機の利用シナリオなどでお客様からよく伺います。</p><p>機械に近づくと、初めてそれを使う場合でも指紋や顔で簡単にログオンできるというのは確かに魅力的なシナリオのように思います。何かを購入して持ち歩いたり、落として無くしたりすることもなく、フィッシングにも会いませんし誰かに勝手に使われたりすることもありません。また、従業員が職場や高いセキュリティの求められる場所でスマートフォンなど SNS につながったデバイスを使用する必要もありませんから、いろんな人がそういうものをあなたに売りつけようとしてくると思います。</p><p>こんなシナリオを実現するためには、ユーザーの生体情報をリモートにある資格情報保存サーバーに登録し、クライアントで生体情報をスキャンしたら、スキャンしたものとサーバー側で保存してあるものをマッチングさせて、あら不思議、同じユーザーですねと確認することになります。これはすごい！もうこれでいんじゃない？！</p><p>残念ながら、生体情報を中央で管理してユーザーを認証することには、いくつかの大きな問題があります。生体情報を中央で管理する方法は、<strong>個人の特定</strong> (ある程度の範囲内でユーザーが誰であるか推定する) につながる可能性があるのです。2020 年初頭の時点では、リモートの生体情報を利用する方法は <strong>認証</strong>、つまり利用者が何者であるかを <strong>立証</strong> することには適していません。</p><p>リモートに保存されている生体情報を使用して認証を行う際の問題点は、生体署名にまつわる 3 つの主要な問題点に由来します。</p><ol><li><p><strong>生体情報は秘密ではない。</strong> ソーシャル メディアに自ら顔の映った写真を投稿したり、よりスムーズに入館できるよう個人を識別するシステムに指紋を登録したりするよりも前から、我々の身体的な状態は簡単に取得することが可能でした。あなたが外の世界に示した姿がそのままキャプチャされているといえます。あなたが外の世界に自らを晒すことで、生体情報が画像やビデオ、指紋として取得され、場合によっては悪意を持って生体情報が取得されることになります。皆さんは既に様々なところでその特徴が収集されているのです。</p></li><li><p><strong>どのような人にとっても生体情報の選択肢は非常に限られている。</strong> 10 本の指、2 つの目、1 つの顔、1 つの声、1 つのパルス信号 … 色々と新しいアイデアを考えたとしても選択肢は 20 個ほどしかなく、生体情報が漏洩したときに使用不可として失効できるものは限られています。現実的に言えば、ユーザビリティを考慮するとさらに選択肢は限られており、利き手の指数本と顔ぐらいになります。さらに通常、予算の制約により組織が単一の生体認証機器しか使えないと考えると、選択肢はより狭まります。4 桁の PIN でさえ 1 万の組み合わせしかありません。あなたの指紋情報が漏洩したときに失効して使用不可にできる指の数はもっと限られています。</p></li><li><p><strong>生体情報はシステム間で再利用できる可能性がある。</strong> ほとんどの生体認証システムは生体情報の型 (テンプレート) を保存しており、使用された生体認証の精細な画像などを保存しているわけではありません。テンプレートの例としては、顔や指紋の主要な基準点の間の距離などが一般的です。しかし、技術によっては、生体認証の照合に使用されるデータが類似している場合があるため、あるシステムから抽出された指紋テンプレートを別のシステムで使用できるように変換できる場合があり得ます。.jpg ファイルを .bmp ファイルや .png ファイルの形式に変換できるように、データの有効性を維持しながらあるテンプレートを別のテンプレートに変換できる可能性があるのです。最近のシステムの中には、システムの各アルゴリズムのバージョン間でテンプレートが変換されないようになっているものもありますが、既に動作しているシステムがこのような新しいアルゴリズムに移行してすべてのテンプレートを再登録するというのは、現実的に非常に難しく不可能とも言えます。一度どこかで生体情報が漏洩すれば、もう二度とその情報は使えなくなってしまうのです。</p></li><li><p><strong>生体情報テンプレートは簡単に盗まれる。</strong> 生体情報は近似でのマッチングに依存しているため、特定の値を不可逆的に変換するハッシュ化を利用することはありません。中央のデータベースに保存されているテンプレートは、元の値が取得できる形で暗号化する必要があります。攻撃者が鍵を見つけてしまえば、データベース内のすべてのユーザーのテンプレートを抽出することができてしまいます。そして、テンプレートが一度抽出されてしまえば、互換性のあるすべてのシステムまたはテンプレートを変換できるシステムにおいてテンプレートが攻撃者の手に渡ることになります。システムに複数のうちいずれかの生体認証情報でサインインする機能がある場合、攻撃者は新しいテンプレートを追加することで、正しいユーザーのログインに影響を与えることなく、攻撃者のテンプレートをすでに登録済みの ID に使用することができます (パスワードのような単一値の認証情報では、パスワードが変更されれば正しいユーザーがログインできなくなるので、書き換えにすぐ気づくことができます)。</p></li></ol><p>合理的な議論を行うには、生体情報が秘密情報ではなく、さらにその点は重要でないという前提において、生体認証のメカニズムが完全性を保証するよう以下のような点を明確にすることが必要です。</p><ul><li>サーバー上に登録されたユーザーの情報が改ざんされないこと。</li><li>生体情報読み取り機 (指紋スキャナーなど) が正当に構成されており改ざんされていないこと。</li><li>生体情報読み取り機とストレージ機構の間の通信経路が完全に安全であること。</li></ul><p>これらのことは、理論的には様々な暗号技術を組み合わせることで実現可能です。例えば、すべての生体情報読み取り機に鍵ペアが埋め込まれていて、すべてのリクエストに公開鍵で署名し、経路上のすべての機器が製造元の証明書機関を用いてチェックして、さらに読み取り機の型式番号で検索して、それがハッキングされていない既知の有効なリーダーであることを確認するようにします。さらに、ファームウェアのチェックサムを使用してハードウェアが細工されていないことを確認し、要求の署名にその結果を含めることもできます。データベースが改ざんされていないことを確認するために分散型台帳を使うことなども可能です。</p><p>しかし、これら各ステップは実際の世界で行うには困難であることがわかっています。正しく動作しないプロトコルやアルゴリズム、各種製品など挙げるときりがありません。また、攻撃者からすると、読み取りセンサーとサーバーの間の経路上のすべてのステップが攻撃対象になるのです。</p><p>生体認証は、社会的にリスクを抱えた人や貧困層の人々、避難民など一部の課題を解決するために重要なテクノロジーとなっていますが、誤った使用がなされるリスクも高いと考えられます。このような理由から、この問題が <a href="https://en.wikipedia.org/wiki/ISO/IEC_JTC_1/SC_37">標準化フォーラム</a> で扱われ、調査や第三者による検証を募りながら進められているのは非常に良いことだと思います（私はこういった理由から標準化プロセスを広く支持しています - 標準化はセキュリティを高める強力な取り組みですから)。</p><p>これらの標準が受け入れられ、実装され、時間をかけてテストされるまでは、私たちは何か他のモノを使用し、攻撃の可能性を最小限にするべきです。FIDO2 のような標準や Windows Hello を実装した時の目標は、テンプレートを取得したデバイスにテンプレートの使用を限定し、テンプレート自体を安全なハードウェアに格納することで、テンプレートと安全なストレージの間の経路を最短にし、生体認証テンプレートが傍受される可能性を最小化することです。テンプレートは、安全なハードウェア (TPM など) が暗号に関する処理にアクセスするためだけに使用されます。安全なハードウェア (TPM など) では、鍵ペアの作成、公開鍵の公開、秘密鍵によるメッセージの署名などの操作を保護するためにテンプレートが使用されます。</p><p>このような設計であれば、生体認証の通信経路を乗っ取るには、ハードウェアへの直接アクセスが必要で、仮に何者かが認証装置を乗っ取ったとしても、取得されたテンプレートは他の場所では役に立ちません。重要なことは、ユーザーが直接所有していないデバイスにおいては、生体認証データを一切収集する必要がないということです。これは生体情報をローカルの認証機器に登録されなければならず、一方で我々は任意のデバイスに近づいて指紋をスキャンすることはできなくなるということを意味します。このアプローチでは、生体認証はすでに登録されているローカル デバイスでしか使用できません。</p><p>それに比べて、中央管理型の生体情報は、読み取り機に加え、読み取り機が接続されているデバイス、そのデバイス上のソフトウェア、そのデバイスと生体情報が保存されているサーバーとの間のネットワーク、そしてサーバー自体も攻撃にさらされる可能性があります。しかもその経路のどれもが製造元ベンダー以外の組織によって検証されたセキュリティ メカニズムを持ち合わせていないのです。</p><p>厳密に検証されたメカニズムがなければ、中央管理型の生体認証は、改ざん、傍受、窃取および共有への対策が不十分な状態となります。適切に管理されていないシステムの一つでテンプレートが漏洩してしまい、その結果、他のすべてのシステムであなたの顔情報が悪用される状態となったらどうしましょうか？あなたの顔情報にテンプレートを追加することで、攻撃者があなたになりすますことができるとしたらどうなるでしょうか？あなたの個人データを管理している会社が、あなたの個人データを他の組織と共有したり、盗まれたデータがあなたの同意なしに他の場面であなたを自動的に識別するために使用されたりしたらどうなるでしょうか？</p><p>これが、マイクロソフトが現在、中央管理型の生体情報を使用した認証をサポートしない理由です。セキュリティの問題は至る所に広がっており、その影響はあまりにも大きいのです。しかし、特に社会的にリスクを抱えた人や避難民、貧困層の人々にとって、身元の証明のために 15 ドルのお金を払うことは困難であり、これは結果としてデジタル ID の恩恵を最も必要としている多くの人がそれを享受できない状態となることを意味します。私は、これは解決すべき非常に重要な問題であると考えており、今後解決できる問題であるとも考えています。</p><p>しかし、今のところ、生体認証において、マイクロソフトとしては生体情報の収集と保存を安全なハードウェア環境に限定することを推奨します。Windows Hello では、FIDO と同様に、生体情報をローカル デバイスに登録する要件を設けています。これはセキュリティとプライバシーの両方の理由から望ましい方法です。生体情報はローカル環境で認証機能のロックを解除するためにのみ使用され、認証機能の内部で使用されることはありません。</p><p>ただ、これでは我々が理想とする「初めて使うデバイスまで手ぶらで近づき、あとは生体情報でサインインするだけ」というシナリオが実現するのはまだ先ということになります。現状では、我々は何かしらの認証機器を提示し、生体認証でそのロックを解除しなければなりません。上記のシナリオほど魔法のようなものではありませんが、この方法の方がよりセキュアで、個人情報が秘匿され、将来も安全性が高いものとなります。</p><p>生体情報のみで認証する際の問題を解決したいとお考えの方々、または私が何か見落としているとお気づきの方は、ぜひ私の Twitter <a href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/biometrics-keep-your-fingers-close/ba-p/twitter.com/alex_t_weinert">@alex_t_weinert</a> まで連絡いただき、考えを共有ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本記事は、 2020 年 5 月 26 日に Azure Active Directory Identity Blog に公開された記事 (Biometrics – Keep Your Fingers Close) を翻訳したものです。原文は &lt;a href=&quot;https:</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="Security" scheme="https://georgioush.github.io/jpazureid-test/tags/Security/"/>
    
  </entry>
  
  <entry>
    <title>このデバイスではどこでもこのアカウントを使用する</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/WorkPlaceJoin/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/WorkPlaceJoin/</id>
    <published>2020-12-11T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.944Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。 Azure Identity サポートの谷です。  </p><p>Windows 10 デバイスで Office のライセンス認証時やサインインが求められる際に表示される “このデバイスではどこでもこのアカウントを使用する” 下記画面について、お問い合わせを多くいただいています。<br>この画面の動作および制御方法について、本記事ではお纏めいたしました。  </p><p><img src="/jpazureid-test/azure-active-directory/WorkPlaceJoin/WorkPlaceJoin.jpg">  </p><h2 id="なぜ表示されるのか？"><a href="#なぜ表示されるのか？" class="headerlink" title="なぜ表示されるのか？"></a>なぜ表示されるのか？</h2><p>Windows 10 の 1703 (Build 15063.138) 以後のバージョンにて Office のバージョン 16.0.7967 以後のバージョンを利用する場合、Office は Web Account Manager (WAM) と呼ばれる認証方式を利用します。<br>ダイアログ メッセージは この WAM と呼ばれる認証フレームワークを使用され、 Office クライアントを使用する際に資格情報を入力した最後のタイミングで Azure AD にデバイスを登録するかを求める動作により表示されています。<br>同画面で [はい] をクリックすると、Azure AD へのデバイス登録が行われます。<br>デバイスを登録したくない場合には、左下の「このアプリのみ」を選択してください。<br>“組織がデバイスを管理できるようにする” のオプションは Intune を利用している環境で有効とした場合に、Azure AD / Intune 両方にデバイスが登録される動作となります。  </p><h2 id="表示させたくない場合"><a href="#表示させたくない場合" class="headerlink" title="表示させたくない場合"></a>表示させたくない場合</h2><p>各 OS 毎でレジストリを追加することで制御することが可能です。<br>Windows 10 のバージョン毎で対応が異なりますので、運用いただいているデバイスのバージョンを確認し、それぞれ対応してください。 </p><h3 id="Windows-10-のバージョンが-1809-以降の場合"><a href="#Windows-10-のバージョンが-1809-以降の場合" class="headerlink" title="Windows 10 のバージョンが 1809 以降の場合"></a>Windows 10 のバージョンが 1809 以降の場合</h3><p>Windows 10 のバージョンが 1809 以降の場合、既に KB4489894 の更新内容が含まれておりますので、以下のレジストリ キー値を設定し、再起動することで Azure AD Registered 状態にならない様に構成することが可能です。</p><p>&lt;設定が必要なレジストリ キー&gt;<br> レジストリ キーパス : HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WorkplaceJoin<br> レジストリ名 : BlockAADWorkplaceJoin<br> 形式 : DWORD<br> 値 : 00000001    </p><h3 id="Windows-10-のバージョンが-1803-の場合"><a href="#Windows-10-のバージョンが-1803-の場合" class="headerlink" title="Windows 10 のバージョンが 1803 の場合"></a>Windows 10 のバージョンが 1803 の場合</h3><p>Windows 10 1803 では上述のレジストリ設定に加え、下記の更新プログラムの適用が必要です。<br>仮に既に KB4489894 以降の更新プログラムを適用している場合、レジストリの設定、および再起動のみでご要望を満たすことが可能です。</p><p>&lt;対象の更新プログラム&gt;<br>  March 19, 2019 - KB4489894 (OS Build 17134.677)<br>  <a href="https://support.microsoft.com/en-us/help/4489894/windows-10-update-kb4489894">https://support.microsoft.com/en-us/help/4489894/windows-10-update-kb4489894</a> </p><p>&lt;グループ ポリシーで配布する場合&gt;<br>上述の BlockAADWorkplaceJoin レジストリ値を 0x1 として設定するグループポリシーに関して、下記の手順をご紹介いたします。</p><ol><li>グループ ポリシーの管理画面より対象クライアント コンピューターに適用させる前提の GPO の編集画面を表示します。</li><li>以下のポリシーを展開します。<br>  コンピューターの構成  <ul><li>基本設定  </li><li><ul><li>Windows の設定  </li></ul></li><li>– レジストリ  </li></ul></li><li>上記 [レジストリ] を右クリックし [新規作成] - [レジストリ項目] を選択します。</li><li>下記のように設定を追加します。<br>アクション : 更新<br>ハイブ : HKEY_LOCAL_MACHINE<br>キーのパス : SOFTWARE\Policies\Microsoft\Windows\WorkplaceJoin<br>値の名前 : BlockAADWorkplaceJoin<br>値の種類 : REG_DWORD<br>値のデータ : 00000001  </li></ol><p> <br>上記の設定をポリシーで配布することでクライアントに目的のレジストリ値が反映するかご確認いただけますと幸いです。</p><h2 id="すでに意図せず登録してしまったデバイスの削除方法"><a href="#すでに意図せず登録してしまったデバイスの削除方法" class="headerlink" title="すでに意図せず登録してしまったデバイスの削除方法"></a>すでに意図せず登録してしまったデバイスの削除方法</h2><ol><li>通常クライアント PC を利用するユーザーで Windows にログオンします。  </li><li>[スタート] - [設定] (歯車のマーク) - [アカウント] - [職場または学校にアクセスする] を開きます。  </li><li>以下のように、[職場または学校アカウント] のエントリが存在する場合、エントリを選択し、[切断] をクリックします。<br> <img src="/jpazureid-test/azure-active-directory/WorkPlaceJoin/WorkPlaceJoin1.jpg">  </li><li>ポップアップが表示されますので、[はい] をクリックします。 </li><li>職場または学校にアクセスするの画面にて”職場または学校アカウント” の情報が消えれば、削除が完了します。<br>  <img src="/jpazureid-test/azure-active-directory/WorkPlaceJoin/WorkPlaceJoin3.jpg"></li></ol><h2 id="良くご質問いただく内容"><a href="#良くご質問いただく内容" class="headerlink" title="良くご質問いただく内容"></a>良くご質問いただく内容</h2><h3 id="Q-登録済みのデバイスを-Azure-ポータルから管理者の操作のみで削除可能か？"><a href="#Q-登録済みのデバイスを-Azure-ポータルから管理者の操作のみで削除可能か？" class="headerlink" title="Q. 登録済みのデバイスを Azure ポータルから管理者の操作のみで削除可能か？"></a><strong>Q. 登録済みのデバイスを Azure ポータルから管理者の操作のみで削除可能か？</strong></h3><p><strong>A.</strong>　Azure AD 上からデバイスの削除を行うことは可能ですが、対象のデバイスで上述の削除方法を実施しない場合には下記の問題が発生します。<br>そのため、デバイス側で手動で削除を実施するようにしてください。<br>エラーコード 700003 の対処策について<br><a href="https://jpazureid.github.io/blog/azure-active-directory/what-to-do-errorcode-700003/">https://jpazureid.github.io/blog/azure-active-directory/what-to-do-errorcode-700003/</a>  </p><h3 id="Q-Azure-AD-にデバイスが登録されたまま放置しても問題ないか？"><a href="#Q-Azure-AD-にデバイスが登録されたまま放置しても問題ないか？" class="headerlink" title="Q. Azure AD にデバイスが登録されたまま放置しても問題ないか？"></a><strong>Q. Azure AD にデバイスが登録されたまま放置しても問題ないか？</strong></h3><p><strong>A.</strong>　デバイスの管理方法の変更が組織で行われない限り、特別問題が生じることはありません。<br>組織にてデバイスの管理を Hybrid Azure AD Join 構成に変更を行った場合に、Azure AD Registerd と Hybrid Azure AD Join の状態の 2 つのデバイスが Azure AD に重複登録されてしまう可能性があります。<br>構成変更をする場合には、予め下記をご参照ください。  </p><p>Azure AD 登録状態のデバイスの処理<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/devices/hybrid-azuread-join-plan#handling-devices-with-azure-ad-registered-state">https://docs.microsoft.com/ja-jp/azure/active-directory/devices/hybrid-azuread-join-plan#handling-devices-with-azure-ad-registered-state</a>  </p><h3 id="Q-“このデバイスではどこでもこのアカウントを使用する”-のメッセージはどのタイミングで表示されるのか？"><a href="#Q-“このデバイスではどこでもこのアカウントを使用する”-のメッセージはどのタイミングで表示されるのか？" class="headerlink" title="Q. “このデバイスではどこでもこのアカウントを使用する” のメッセージはどのタイミングで表示されるのか？"></a><strong>Q. “このデバイスではどこでもこのアカウントを使用する” のメッセージはどのタイミングで表示されるのか？</strong></h3><p><strong>A.</strong>　上述させていただきましたとおり、Office 365 インストール時や Teams 、Outlook などの Office 製品での認証時に表示されます。  </p><h3 id="Q-“このデバイスではどこでもこのアカウントを使用する”-のメッセージを非表示にするように制御した場合の影響は"><a href="#Q-“このデバイスではどこでもこのアカウントを使用する”-のメッセージを非表示にするように制御した場合の影響は" class="headerlink" title="Q. “このデバイスではどこでもこのアカウントを使用する” のメッセージを非表示にするように制御した場合の影響は?"></a><strong>Q. “このデバイスではどこでもこのアカウントを使用する” のメッセージを非表示にするように制御した場合の影響は?</strong></h3><p><strong>A.</strong>　WAM による Azure AD へのデバイス登録が行われなくなるだけで、Windows 10 、Office 製品、Azure AD の利用上に制限や動作影響等は特にありません。  </p><h3 id="Q-Azure-AD-でのデバイス管理方法について"><a href="#Q-Azure-AD-でのデバイス管理方法について" class="headerlink" title="Q. Azure AD でのデバイス管理方法について"></a><strong>Q. Azure AD でのデバイス管理方法について</strong></h3><p><strong>A.</strong>　本記事のメッセージを契機に Azure AD でのデバイス管理方法についてご質問を多くいただきます。<br>弊社製品開発チームにて開催させていただいている Webinar にてご紹介させていただいておりますので、参考にしていただければ幸いです。<br><a href="https://github.com/yusukekodama/PMActivities/blob/master/Webinar/Schedule.md#%E9%80%A3%E7%B5%A1%E4%BA%8B%E9%A0%85">https://github.com/yusukekodama/PMActivities/blob/master/Webinar/Schedule.md#%E9%80%A3%E7%B5%A1%E4%BA%8B%E9%A0%85</a>  </p><p>関連する回としては下記となります。  </p><ul><li>COVID-19 でリモート対応に成功した企業と失敗した企業の違いとは？  </li><li>Azure AD の新しいデバイス管理パターンを理解しよう  </li><li>Intune によるモバイルデバイスとアプリのセキュアな管理とは  </li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。 Azure Identity サポートの谷です。  &lt;/p&gt;
&lt;p&gt;Windows 10 デバイスで Office のライセンス認証時やサインインが求められる際に表示される “このデバイスではどこでもこのアカウントを使用する” 下記画面について、お問い合わせを</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="WorkPlace Join" scheme="https://georgioush.github.io/jpazureid-test/tags/WorkPlace-Join/"/>
    
    <category term="Windows 10" scheme="https://georgioush.github.io/jpazureid-test/tags/Windows-10/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD に登録できる 「アプリ」と「リソース」、「API 権限」を理解する</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/</id>
    <published>2020-12-03T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.882Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure ID チームの埴山です。</p><p>本記事は <a href="https://qiita.com/advent-calendar/2020/microsoft-azure-tech">Azure Tech Advent Calendar</a> 4 日目の記事です。</p><p>今回はトラブルシューティングの方法ではなく、Azure AD を利用したアプリケーション開発における、”API 権限” について説明します。特に Microsoft Graph API を題材に API エコシステムの中身を見ていきます。</p><p>Azure AD を利用してアプリ開発を検討している方や、Azure AD における OAuth の実装について詳しく知りたい方への記事となります。<br>チュートリアルなどについては、一通り動かしたことのある方を対象とした記事ですので、Azure AD で保護されたアプリケーション開発の基礎については <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/">Microsoft ID プラットフォームのドキュメント | Microsoft Docs</a> の公開ドキュメントをご確認ください。</p><h2 id="OAuth-と-Azure-AD"><a href="#OAuth-と-Azure-AD" class="headerlink" title="OAuth と Azure AD"></a>OAuth と Azure AD</h2><p>OAuth は「リソース」へのアクセス権を安全に委譲し、API を保護するための「トークン」を発行する仕組みのデファクトスタンダードです。Microsoft では Exchange Online や SharePoint Online といった「リソース」に対するアクセスするための「API」を OAuth の仕組みを使って保護しており、ユーザーは必要な権限を必要に応じて「クライアント」であるアプリに払い出すことが可能です。これらの権限管理を行っているのが Azure AD です。</p><p>ここでは OAuth の基礎については説明を省きますが、Azure AD にアプリを登録することで、Microsoft が管理する Azure AD で保護された「リソース」へのアクセスを行う「クライアント」を作成したり、自社で開発した API を「リソース」として登録し Azure AD で保護したりすることができます。リソースへのアクセス権は Azure AD では API のアクセス許可とよばれます。<br>API のアクセス許可は「トークン」という形で「クライアント」であるアプリに受け渡されます。例えばユーザーが、ユーザー情報を取得できる API のアクセス許可を、クライアントであるアプリに許可することが可能です。アクセス許可を付与されたアプリケーションは、アクセス トークンという<br>トークンを取得し、ユーザーの情報を取得する API を呼び出すことが可能になります。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/oauth-flow.png"></p><p>アプリが取得できる権限として、ユーザー委任のアクセス許可と、アプリケーション権限のアクセス許可の二つがあります。前者がユーザーの同意を得て、ユーザーの権限相当のアクセス権を取得できるのに対し、後者は管理者がアプリに権限を付与 (管理者の同意) することで、アプリケーション自身に権限を付与し、アプリ自身が API のアクセス権を得ることができます。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/delegated-and-app-permissions.png"></p><p>ただし、あくまでここで取得できる権限は API のアクセス許可であり、実際のリソースへのアクセス権はリソースオーナー、つまり Exchange Online や SharePoint Online が管理していることに注意してください。たとえば、あるユーザーがユーザー委任のメールの読み込み権限をアプリに付与したからといって、対象のユーザーがアクセスできないメールボックスの読み込みを行うことはできません。つまり、ユーザーがアクセスできるリソースの範囲は、API のアクセス許可と、リソース側の権限管理の両方で制御されています。</p><p>本記事ではこれらの API のアクセス許可の実体について深堀していきます。</p><h2 id="サンプルアプリを動作させる"><a href="#サンプルアプリを動作させる" class="headerlink" title="サンプルアプリを動作させる"></a>サンプルアプリを動作させる</h2><p>まずは実際に Microsoft Graph API を呼び出すサンプルを動かし、その動作を見てみましょう。</p><p>後程、テナントに同意された権限などを確認するために、テナントのグローバル管理者権限が必要となってきます。そのためサンプルの動作はテストテナントを作成しお試しいただくことをお勧めします。<br>また今回紹介するアプリの実際の動作のためには <a href="https://nodejs.org/en/">Node.js</a> のインストールが必要です。</p><blockquote><p>Microsoft Graph API を呼び出すちょうどいいサンプルが、node.js だったので</p></blockquote><h3 id="アプリの登録とサンプルのダウンロード"><a href="#アプリの登録とサンプルのダウンロード" class="headerlink" title="アプリの登録とサンプルのダウンロード"></a>アプリの登録とサンプルのダウンロード</h3><p>Azure Active Directory &gt; <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps">アプリの登録</a> から新規アプリを登録します。</p><p>名前は <code>MS Graph Client Sample</code> としましょう。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/01.png"></p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/02.png"></p><p>設定はデフォルトのまま作成します。そのまま<code>クイック スタート</code>をクリックし、<code>シングルページ アプリケーション (SPA)</code> を選択します。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/03.png"></p><p>続いて JavaScript (認証コード フロー) を選択します。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/04.png"></p><p><code>これらの変更を行います</code> ボタンをクリックし、サンプルの動作に必要な設定を変更します。<br><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/05.png"><br><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/06.png"></p><p>続けてプロジェクトのダウンロードです。 <code>コード サンプルをダウンロードします</code> をクリックしダウンロードした zip ファイルを適当な場所に展開します。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/07.png"></p><h3 id="サンプルの動作"><a href="#サンプルの動作" class="headerlink" title="サンプルの動作"></a>サンプルの動作</h3><p>PowerShell を起動し、コードサンプルを展開したフォルダーに移動します。ちなみにエクスプローラーの検索窓に powershell と入力すると、開いているフォルダーから PowerShell を起動できます。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/08.png"></p><p>クイック スタートにある通り npm install および npm start コマンドを実行します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm <span class="built_in">start</span></span><br></pre></td></tr></table></figure><p><code>http://localhost:3000/</code> でアプリが起動しますので、ブラウザーでアクセスします。</p><h3 id="動作の確認"><a href="#動作の確認" class="headerlink" title="動作の確認"></a>動作の確認</h3><p><code>Sign In</code> ボタンをクリックし、ユーザーの資格情報を入力すると　API のアクセス許可の同意画面が出てきます。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/09.png"></p><p><code>承諾</code> をクリックするとこで、サインインが完了します。この際、Azure AD からアプリに対し ID トークンとアクセス トークンが発行されています。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/10.png"></p><blockquote><p>※ 今回は ID トークンの詳細や使い道については説明しません。</p></blockquote><p><code>See Profile</code> ボタンをクリックすることで、取得したアクセス トークンを使ってユーザーのプロファイル情報を取得できます。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/11.png"><br><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/14.png"></p><p>次に <code>Read Mails</code> ボタンをクリックしてみましょう。<br>すると、新たに <code>Read your mail</code> の API のアクセス許可を求める同意画面が表示され、<code>同意</code> をクリックすることでメールを読み込むためのトークンが取得されます。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/12.png"></p><p>※ テストユーザーは Exchange Online のライセンスを持っていなかったので API の呼び出しには失敗しています。</p><h2 id="何がおこったのか"><a href="#何がおこったのか" class="headerlink" title="何がおこったのか"></a>何がおこったのか</h2><p>これまでの操作をまとめてみましょう。<br>今回、新しいアプリケーションを Azure AD に登録し、ユーザー プロファイルの表示ができる API のアクセス許可と、メールの読み込みの API のアクセス許可を要求しました。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/oauth-flow-2.png"></p><p>要求に対しユーザーの同意画面が現れ、同意を行うことでアプリがアクセス トークンを取得できるようになりました。<br>アプリは取得したアクセス トークンを使って Microsoft Graph API を呼び出し、ユーザー情報やメールの読み込みを行いました。</p><p>これらの裏でどのようなことが起こっていたのでしょうか。より詳細に見てみましょう。</p><h3 id="エンタープライズ-アプリケーションと-API-のアクセス許可"><a href="#エンタープライズ-アプリケーションと-API-のアクセス許可" class="headerlink" title="エンタープライズ アプリケーションと API のアクセス許可"></a>エンタープライズ アプリケーションと API のアクセス許可</h3><p>ユーザーが作成したクライアント アプリは、Azure ポータルの “アプリの登録” に登録されます。と、同時に API の権限の同意結果を保存する “エンタープライズ アプリケーション” が作成されます。<br>詳細を確認するために作成したアプリのプロパティに表示される “ローカル ディレクトリでのマネージド アプリケーション” をクリックしてみましょう。(<code>Azure Active Directory</code> &gt; <code>エンタープライズ アプリケーション</code> と移動し検索しても OK です。)</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/15.png"></p><p>表示されたサービス プリンシパルの <code>アクセス許可</code> を確認します。ユーザー同意のタブを見ると、先ほどユーザーが同意した API のアクセス許可が登録されています。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/16.png"></p><p>詳細を確認すると、たとえば <code>User.Read</code> のスコープに同意済みであることなどが確認できます。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/17.png"></p><p>4 つのアクセス許可をよく見てみると、クレームの値が <code>openid</code>, <code>profile</code>, <code>User.Read</code>, <code>Mail.Read</code> であることが確認できるかと思います。</p><h3 id="API-のアクセス許可と-scope"><a href="#API-のアクセス許可と-scope" class="headerlink" title="API のアクセス許可と scope"></a>API のアクセス許可と scope</h3><p>これらの 4 つのクレームの値は何を表しているのでしょうか。</p><p>実は先ほどのサインイン時に、アプリケーションは Azure AD の認可エンドポイントに対し、scope を指定し<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-auth-code-flow#request-an-authorization-code">認可要求 (承認コードを要求)</a>を送っていました。<br>要求するパラメーターはサンプルの <code>app/authConfig.js</code> 内で、以下のように指定されています。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Add here the scopes that you would like the user to consent during sign-in</span></span><br><span class="line"><span class="keyword">const</span> loginRequest = &#123;</span><br><span class="line">    scopes: [<span class="string">&quot;User.Read&quot;</span>]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add here the scopes to request when obtaining an access token for MS Graph API</span></span><br><span class="line"><span class="keyword">const</span> tokenRequest = &#123;</span><br><span class="line">    scopes: [<span class="string">&quot;User.Read&quot;</span>, <span class="string">&quot;Mail.Read&quot;</span>],</span><br><span class="line">    forceRefresh: <span class="literal">false</span> <span class="comment">// Set this to &quot;true&quot; to skip a cached token and go to the server to get a new token</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>コードを確認していただければわかりますが <code>loginRequest</code> がサインイン時に、<code>tokenRequest</code> がメール読み込み時に要求される scope です。</p><blockquote><p>※ msal.js では loginPopup 呼び出し時、自動で socpe に openid profile を追加するため、最終的に同意した API の権限は、<code>openid</code>, <code>profile</code>, <code>User.Read</code>, <code>Mail.Read</code> の 4 つとなります。</p></blockquote><p>つまり、ユーザー委任の API のアクセス許可イコール、scope と呼ばれる単位で管理されていることがわかります。</p><p>このようにユーザーがアプリに同意を行うことで、ユーザーの同意情報がサービス プリンシパルに保存され、アプリはユーザーの代わりに API の呼び出しを実施することが可能になるのです。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/oauth-flow-3.png"></p><h2 id="Microsoft-Graph-API"><a href="#Microsoft-Graph-API" class="headerlink" title="Microsoft Graph API"></a>Microsoft Graph API</h2><p>では、ここで同意された <code>User.Read</code> のスコープとはなんなのでしょうか。Microsoft Graph API の API のアクセス許可であることはご存じだと思いますが、これらのスコープはどこに定義されて、同意した権限はどのように保存されているのでしょうか。</p><h3 id="OAuthPermissionGrants-を確認する"><a href="#OAuthPermissionGrants-を確認する" class="headerlink" title="OAuthPermissionGrants を確認する"></a>OAuthPermissionGrants を確認する</h3><p>これを理解するためには、Azure AD に登録されたサービス プリンシパルについて確認することが必要です。</p><p>先ほど “アプリの登録” からアプリを作成したと思います。その際エンタープライズ アプリケーションも同時に作成されると言いましたが、このエンタープライズ アプリケーションこそがサービス プリンシパルと呼ばれるオブジェクトです。正確にはエンタープライズ アプリケーションがサービス プリンシパルの一種ですが基本的には “サービス プリンシパル” と “エンタープライズ アプリケーション” はほぼ同義だと考えて OK です。</p><p>テナントに登録された <a href="https://docs.microsoft.com/ja-jp/graph/api/resources/serviceprincipal?view=graph-rest-1.0">“サービス プリンシパル” オブジェクト</a> の一覧は、Azure AD PowerShell モジュールや Microsoft Graph API で取得できます。<br>ここでは <a href="https://github.com/microsoftgraph/msgraph-sdk-powershell">Microsoft Graph PowerShell SDK</a> を利用して、サービス プリンシパルの一覧を取得してみましょう。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Install-Module</span> Microsoft.Graph</span><br><span class="line"><span class="built_in">Select-MgProfile</span> <span class="literal">-Name</span> <span class="string">&quot;v1.0&quot;</span></span><br></pre></td></tr></table></figure><p>OAuth の権限を取得するため、<code>Directory.Read.All</code> の権限が必要ですので、あらかじめ指定しておきます。この後の Connect-Graph 実行時にはテナントのグローバル管理者でのサインインが必要です。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-Graph</span> <span class="literal">-Scopes</span> Directory.Read.All</span><br><span class="line"><span class="comment"># To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code HMCYSET2L to authenticate. </span></span><br><span class="line"><span class="comment"># 注: URL にアクセスし、code を入力しグローバル管理者権限でサインインと同意を完了させます。</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-MgServicePrincipal</span> |<span class="built_in">Select-Object</span> AppDisplayName, Id, AppId</span><br><span class="line"></span><br><span class="line"><span class="comment"># AppDisplayName                          Id                                   AppId</span></span><br><span class="line"><span class="comment"># --------------                          --                                   -----</span></span><br><span class="line"><span class="comment"># Microsoft password reset service        11fc006f-2cb4-4f3c-9c43-c3a3d7f76184 93625bc8-bfe2-437a-97e0-3d0060024faa</span></span><br><span class="line"><span class="comment"># Office 365 Configure                    134ad4d8-2e42-46a6-8508-c9585c67b30f aa9ecb1e-fd53-4aaa-a8fe-7a54de2c1334</span></span><br><span class="line"><span class="comment"># Microsoft Graph                         19a9419c-cc6f-47c6-88f3-0f2a964a4f16 00000003-0000-0000-c000-000000000000</span></span><br><span class="line"><span class="comment"># Windows Azure Active Directory          29a26a86-d50a-4b2a-a40a-4c014aa9e416 00000002-0000-0000-c000-000000000000</span></span><br><span class="line"><span class="comment"># MS-PIM                                  2a71ba9d-de5b-4f9a-a9df-73e68bc5ddcf 01fc33a7-78ba-4d2f-a4b7-768e336e890e</span></span><br><span class="line"><span class="comment"># AAD Request Verification Service - PROD 3dd23bd7-8280-490f-984e-616873819772 c728155f-7b2a-4502-a08b-b8af9b269319</span></span><br><span class="line"><span class="comment"># MS Graph Client Sample                  439775c2-70a1-4e08-a3e7-cd39c50e918d 2d6aced0-40ae-4519-a2e5-8e23944fc046</span></span><br><span class="line"><span class="comment"># Windows Azure Service Management API    62fc0cd5-d157-4ee0-befb-877a367210e2 797f4846-ba00-4fd7-ba43-dac1f8f63013</span></span><br><span class="line"><span class="comment"># O365 Demeter                            96909691-743c-49e3-80d4-a5428bd47108 982bda36-4632-4165-a46a-9863b1bbcf7d</span></span><br><span class="line"><span class="comment"># Microsoft.Azure.SyncFabric              a6069499-077b-45a8-9fa2-ac9ca80c5df6 00000014-0000-0000-c000-000000000000</span></span><br><span class="line"><span class="comment"># Microsoft App Access Panel              a6eb38c8-78c9-47cd-981f-2136273824c3 0000000c-0000-0000-c000-000000000000</span></span><br><span class="line"><span class="comment"># Microsoft Graph PowerShell              b42a2cf1-3551-4e3a-bcd7-bf299f12cb3c 14d82eec-204b-4c2f-b7e8-296a70dab67e</span></span><br><span class="line"><span class="comment"># Microsoft.SMIT                          b8a15564-fd40-4802-b2e9-cd5a2ae6715b 8fca0a66-c008-4564-a876-ab3ae0fd5cff</span></span><br><span class="line"><span class="comment"># Azure ESTS Service                      c0a8c459-1611-4405-8f89-4008de7b7988 00000001-0000-0000-c000-000000000000</span></span><br><span class="line"><span class="comment"># Signup                                  c51b3541-6e7a-4aff-8582-729c8174f66d b4bddae8-ab25-483e-8670-df09b9f1d0ea</span></span><br><span class="line"><span class="comment"># Microsoft Graph Change Tracking         d3a24af2-a630-4c87-8d17-013aa3e576e1 0bf30f3b-4a52-48df-9a82-234910c4a086</span></span><br><span class="line"><span class="comment"># MCAPI Authorization Prod                d9c70c10-16ff-4021-a6dc-25916de5a7b9 d73f4b35-55c9-48c7-8b10-651f6f2acb2e</span></span><br><span class="line"><span class="comment"># IAM Supportability                      e2619bb6-17d5-47e4-93e5-4b8fd5a836dd a57aca87-cbc0-4f3c-8b9e-dc095fdc8978</span></span><br><span class="line"><span class="comment"># AzureSupportCenter                      e883ba61-437b-4b80-bee2-f3106fcb9221 37182072-3c9c-4f6a-a4b3-b3f91cacffce</span></span><br><span class="line"><span class="comment"># Azure Portal                            f131b178-6dda-4f79-9247-cc744d946491 c44b4083-3bb0-49c1-b47d-974e53cbdf3c</span></span><br></pre></td></tr></table></figure><p>このテナントはテスト用に作成したテナントなので、これだけしか出力されませんが、実際のテナントでは Microsoft が管理しているアプリや、サードパーティー製のアプリ、自社で開発しているアプリなど、大量に出力されると思います。<br>これらの多くのアプリケーションは Azure ポータルの <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/AllApps/menuId/">エンタープライズ アプリケーション</a> にも表示されていますが、Microsoft が管理されている一部のサービス プリンシパルはポータルに表示されないものもあります。</p><p>今回作成したアプリは <code>MS Graph Client Sample</code> ですので、当該のサービス プリンシパル取得しておきます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$myAppSp</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;displayName eq &#x27;MS Graph Client Sample&#x27;&quot;</span></span><br></pre></td></tr></table></figure><p>次に、先ほど同意を行った API のアクセス許可を取得します。API のアクセス許可は <a href="https://docs.microsoft.com/ja-jp/graph/api/serviceprincipal-list-oauth2permissiongrants?view=graph-rest-1.0&tabs=http">OAuth2Permissions</a> として保存されているため、以下のコマンドで取得可能です。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$oAuth2Permissions</span> = <span class="built_in">Get-MgServicePrincipalOauth2PermissionGrant</span> <span class="literal">-ServicePrincipalId</span> <span class="variable">$myAppSp</span>.Id</span><br><span class="line"><span class="variable">$oAuth2Permissions</span> | <span class="built_in">fl</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># ClientId             : 439775c2-70a1-4e08-a3e7-cd39c50e918d</span></span><br><span class="line"><span class="comment"># ConsentType          : Principal</span></span><br><span class="line"><span class="comment"># ExpiryTime           : 2021/05/28 4:12:42</span></span><br><span class="line"><span class="comment"># Id                   : wnWXQ6FwCE6j5805xQ6RjZxBqRlvzMZHiPMPKpZKTxZ1aL_h6m71R6v57ub13Wy-</span></span><br><span class="line"><span class="comment"># PrincipalId          : e1bf6875-6eea-47f5-abf9-eee6f5dd6cbe</span></span><br><span class="line"><span class="comment"># ResourceId           : 19a9419c-cc6f-47c6-88f3-0f2a964a4f16</span></span><br><span class="line"><span class="comment"># Scope                :  User.Read openid profile Mail.Read</span></span><br><span class="line"><span class="comment"># StartTime            : 0001/01/01 0:00:00</span></span><br><span class="line"><span class="comment"># Keys                 : &#123;&#125;</span></span><br><span class="line"><span class="comment"># Values               : &#123;&#125;</span></span><br><span class="line"><span class="comment"># AdditionalProperties : &#123;&#125;</span></span><br><span class="line"><span class="comment"># Count                : 0</span></span><br></pre></td></tr></table></figure><p>先ほどのサンプルで同意した API のアクセス許可である User.Read, openid, profile, Mail.Read が表示されています。<br>また PrincipalId は、先ほど同意処理を実施したユーザーの ObjectId であることが確認できます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-MgUser</span> <span class="literal">-UserId</span>  e1bf6875<span class="literal">-6eea</span><span class="literal">-47f5</span><span class="literal">-abf9</span><span class="literal">-eee6f5dd6cbe</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Id                                   DisplayName Mail UserPrincipalName                   UserType</span></span><br><span class="line"><span class="comment"># --                                   ----------- ---- -----------------                   --------</span></span><br><span class="line"><span class="comment"># e1bf6875-6eea-47f5-abf9-eee6f5dd6cbe user             user@oauth2beginner.onmicrosoft.com Member</span></span><br></pre></td></tr></table></figure><p>つまり、この情報から上記ユーザーが、”User.Read, openid, profile, Mail.Read” の権限を、クライアントであるサービス プリンシパル “439775c2-70a1-4e08-a3e7-cd39c50e918d” (MS Graph Client Sample) に委任した、ということが確認できます。<br>そして、それらの情報は <a href="https://docs.microsoft.com/ja-jp/graph/api/resources/oauth2permissiongrant?view=graph-rest-1.0">OAuth2Permissions</a> として保存されていることがわかります。</p><p>さて、この API 権限 (OAuth2Permissions) ですがサンプルを動作させた皆様なら、”Microsoft Graph API” の権限であることはお分かりかと思います。<br>では、その情報はどこで確認できるのでしょうか。</p><p>OAuth2PermissionGrant の内容を確認すると ResourceId “19a9419c-cc6f-47c6-88f3-0f2a964a4f16” とあります。<br>この ResourceId を指定し、サービス プリンシパルを取得してみましょう。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-ServicePrincipalId</span> <span class="number">19</span>a9419c<span class="literal">-cc6f</span><span class="literal">-47c6</span><span class="literal">-88f3</span><span class="literal">-0f2a964a4f16</span> | <span class="built_in">Select-Object</span> DisplayName, AppId</span><br><span class="line"></span><br><span class="line"><span class="comment"># DisplayName     AppId</span></span><br><span class="line"><span class="comment"># -----------     -----</span></span><br><span class="line"><span class="comment"># Microsoft Graph 00000003-0000-0000-c000-000000000000</span></span><br></pre></td></tr></table></figure><blockquote><p>※ 表示される ResourceId はテナントごとに異なります。</p></blockquote><h3 id="リソースの正体"><a href="#リソースの正体" class="headerlink" title="リソースの正体"></a>リソースの正体</h3><p>当たり前といえば当たり前ですが、ResourceId が指示していたのは Microsoft Graph API でした。<br>そしてその正体は、テナントに登録されている “Microsoft Graph” という名前のサービス プリンシパルなのです。</p><p>実は Azure AD の “サービスプリンシパル” は、OAuth の文脈では “クライアント” を表すこともあれば、”リソース” を表すこともあります。(あるいはその両方を表すこともあります)<br>そして ResourceId に表示されている通り、Microsoft Graph は Azure AD に登録されたリソースとしてのサービス プリンシパルである、ということです。</p><p>それでは早速 Microsoft Graph API のリソースを表す、”Microsoft Graph” の “サービスプリンシパル” の中身を見てみましょう。<br>サービスプリンシパルは先ほどの ResourceId を指定するか、もしくは、Microsoft Graph の AppId は “00000003-0000-0000-c000-000000000000” と決まっているので、以下のようにフィルターしても OK です。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$msGraph</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;appId eq &#x27;00000003-0000-0000-c000-000000000000&#x27;&quot;</span></span><br></pre></td></tr></table></figure><p>取得したサービス プリンシパルを確認してみましょう。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$msGraph</span> | <span class="built_in">Format-List</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># AccountEnabled                     : True</span></span><br><span class="line"><span class="comment"># AddIns                             : &#123;&#125;</span></span><br><span class="line"><span class="comment"># AlternativeNames                   : &#123;&#125;</span></span><br><span class="line"><span class="comment"># AppDescription                     :</span></span><br><span class="line"><span class="comment"># AppDisplayName                     : Microsoft Graph</span></span><br><span class="line"><span class="comment"># AppId                              : 00000003-0000-0000-c000-000000000000</span></span><br><span class="line"><span class="comment"># AppOwnerOrganizationId             : f8cdef31-a31e-4b4a-93e4-5f571e91255a</span></span><br><span class="line"><span class="comment"># AppRoleAssignedTo                  :</span></span><br><span class="line"><span class="comment"># AppRoleAssignmentRequired          : False</span></span><br><span class="line"><span class="comment"># AppRoleAssignments                 :</span></span><br><span class="line"><span class="comment"># AppRoles                           : &#123;ba7b8302-40ad-475c-a768-5b990aa1dba1, 57f0b71b-a759-45a0-9a0f-cc099fbd9a44, 673cd</span></span><br><span class="line"><span class="comment">#                                      294-c6eb-43f7-8bc9-cee7da70d759, 107747da-618e-4e26-bcaf-6adac31d8dae...&#125;</span></span><br><span class="line"><span class="comment"># ApplicationTemplateId              :</span></span><br><span class="line"><span class="comment"># ClaimsMappingPolicies              :</span></span><br><span class="line"><span class="comment"># CreatedObjects                     :</span></span><br><span class="line"><span class="comment"># DeletedDateTime                    :</span></span><br><span class="line"><span class="comment"># Description                        :</span></span><br><span class="line"><span class="comment"># DisplayName                        : Microsoft Graph</span></span><br><span class="line"><span class="comment"># Endpoints                          :</span></span><br><span class="line"><span class="comment"># HomeRealmDiscoveryPolicies         :</span></span><br><span class="line"><span class="comment"># Homepage                           :</span></span><br><span class="line"><span class="comment"># Id                                 : 19a9419c-cc6f-47c6-88f3-0f2a964a4f16</span></span><br><span class="line"><span class="comment"># Info                               : Microsoft.Graph.PowerShell.Models.MicrosoftGraphInformationalUrl</span></span><br><span class="line"><span class="comment"># KeyCredentials                     : &#123;&#125;</span></span><br><span class="line"><span class="comment"># LoginUrl                           :</span></span><br><span class="line"><span class="comment"># LogoutUrl                          :</span></span><br><span class="line"><span class="comment"># MemberOf                           :</span></span><br><span class="line"><span class="comment"># Notes                              :</span></span><br><span class="line"><span class="comment"># NotificationEmailAddresses         : &#123;&#125;</span></span><br><span class="line"><span class="comment"># Oauth2PermissionGrants             :</span></span><br><span class="line"><span class="comment"># Oauth2PermissionScopes             : &#123;2884dbf9-deb7-4665-a380-2a5a11805f09, a4633e44-d355-4474-99df-8c2de6b0e39e, 3660b</span></span><br><span class="line"><span class="comment">#                                      e8e-a561-4754-bf45-278f6f4d38f3, ac0981dc-81a3-4a1d-af5b-d664bef4bbf7...&#125;</span></span><br><span class="line"><span class="comment"># OwnedObjects                       :</span></span><br><span class="line"><span class="comment"># Owners                             :</span></span><br><span class="line"><span class="comment"># PasswordCredentials                : &#123;&#125;</span></span><br><span class="line"><span class="comment"># PreferredSingleSignOnMode          :</span></span><br><span class="line"><span class="comment"># PreferredTokenSigningKeyThumbprint :</span></span><br><span class="line"><span class="comment"># ReplyUrls                          : &#123;&#125;</span></span><br><span class="line"><span class="comment"># SamlSingleSignOnSettings           : Microsoft.Graph.PowerShell.Models.MicrosoftGraphSamlSingleSignOnSettings</span></span><br><span class="line"><span class="comment"># ServicePrincipalNames              : &#123;00000003-0000-0000-c000-000000000000/ags.windows.net, 00000003-0000-0000-c000-000</span></span><br><span class="line"><span class="comment">#                                      000000000, https://canary.graph.microsoft.com, https://graph.microsoft.com...&#125;</span></span><br><span class="line"><span class="comment"># ServicePrincipalType               : Application</span></span><br><span class="line"><span class="comment"># Tags                               : &#123;&#125;</span></span><br><span class="line"><span class="comment"># TokenEncryptionKeyId               :</span></span><br><span class="line"><span class="comment"># TokenIssuancePolicies              :</span></span><br><span class="line"><span class="comment"># TokenLifetimePolicies              :</span></span><br><span class="line"><span class="comment"># TransitiveMemberOf                 :</span></span><br><span class="line"><span class="comment"># Keys                               : &#123;createdDateTime, resourceSpecificApplicationPermissions, signInAudience, verified</span></span><br><span class="line"><span class="comment">#                                      Publisher&#125;</span></span><br><span class="line"><span class="comment"># Values                             : &#123;2020-11-29T03:54:06Z, System.Object[], AzureADMultipleOrgs, System.Collections.Ge</span></span><br><span class="line"><span class="comment">#                                      neric.Dictionary`2[System.String,System.Object]&#125;</span></span><br><span class="line"><span class="comment"># AdditionalProperties               : &#123;[createdDateTime, 2020-11-29T03:54:06Z], [resourceSpecificApplicationPermissions,</span></span><br><span class="line"><span class="comment">#                                       System.Object[]], [signInAudience, AzureADMultipleOrgs], [verifiedPublisher, Syst</span></span><br><span class="line"><span class="comment">#                                      em.Collections.Generic.Dictionary`2[System.String,System.Object]]&#125;</span></span><br><span class="line"><span class="comment"># Count                              : 4</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>設定値がいくつか表示されますね。たとえば <code>PublisherName</code> は <code>Microsoft Services</code> で、<code>AppOwnerOrganizationId</code> が <code>f8cdef31-a31e-4b4a-93e4-5f571e91255a</code> であるので、Microsoft が管理しているサービス プリンシパルであると判別できます。</p><p>ここで今回注目すべきは <strong><a href="https://docs.microsoft.com/ja-jp/graph/api/resources/permissionscope?view=graph-rest-1.0">Oauth2PermissionScopes</a></strong> です。<br>少し中身を確認してみましょう。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$msGraph</span>.Oauth2PermissionScopes | <span class="built_in">Select-Object</span> Value, UserConsentDescription <span class="literal">-First</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Value                             UserConsentDescription</span></span><br><span class="line"><span class="comment"># -----                             ----------------------</span></span><br><span class="line"><span class="comment"># SensitiveInfoType.Read.All        Allow the app to get the list of available sensitive types, including out of box a...</span></span><br><span class="line"><span class="comment"># SensitivityLabel.Evaluate         Allow the app to determine if there is any sensitivity label to be applied automat...</span></span><br><span class="line"><span class="comment"># DataLossPreventionPolicy.Evaluate Allow the app to evaluate the inputs provided against the Data Loss Prevention pol...</span></span><br><span class="line"><span class="comment"># SensitiveInfoType.Detect          Allow the app to scan the text in the input to detect the sensitive information ty...</span></span><br><span class="line"><span class="comment"># APIConnectors.ReadWrite.All       Allows the app to read, create and manage the API connectors used in user authenti...</span></span><br><span class="line"><span class="comment"># APIConnectors.Read.All            Allows the app to read the API connectors used in user authentication flows, on yo...</span></span><br><span class="line"><span class="comment"># TeamsTab.ReadWriteForUser         Allows a Teams app to read, install, upgrade, and uninstall all tabs for you.</span></span><br><span class="line"><span class="comment"># TeamsTab.ReadWriteForTeam         Allows a Teams app to read, install, upgrade, and uninstall all tabs to teams you ...</span></span><br><span class="line"><span class="comment"># TeamsTab.ReadWriteForChat         Allows a Teams app to read, install, upgrade, and uninstall all tabs in chats you ...</span></span><br><span class="line"><span class="comment"># ChatMessage.Read                  Allows an app to read one-to-one or group chat messages in Microsoft Teams, on you...</span></span><br></pre></td></tr></table></figure><p>そうです、もうお分かりですね。Microsoft Graph API の scope 一覧は、この Oauth2PermissionScopes に定義されています。<br>ちなみに <code>User.Read</code> 権限は、ユーザーをアプリにサインインさせ、プロファイルを表示させる権限と定義されています。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> <span class="variable">$msGraph</span>.Oauth2PermissionScopes | ?&#123; <span class="variable">$_</span>.Value <span class="operator">-eq</span> <span class="string">&quot;User.Read&quot;</span>&#125;  | <span class="built_in">Select-Object</span> Value, UserConsentDescription</span><br><span class="line"></span><br><span class="line">Value     UserConsentDescription</span><br><span class="line">-----     ----------------------</span><br><span class="line">User.Read Allows you to sign <span class="keyword">in</span> to the app with your organizational account and let the app read your profile. It al...</span><br></pre></td></tr></table></figure><p>Microsoft Graph API のアクセス許可の一覧は、<a href="https://docs.microsoft.com/ja-jp/graph/permissions-reference">Microsoft Graph のアクセス許可のリファレンス - Microsoft Graph | Microsoft Docs</a> にあります。<br>ユーザー権限の API のアクセス許可、すなわち scope はこのうち委任されたアクセス許可に該当します。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/oauth-flow-4.png"></p><!-- API を呼び出す際の動作をブラウザーの開発者ツール (F12 で起動し、`See Profile` ボタンクリック時の通信を Network タブを確認します) で見てみると、アクセストークンの値を確認できます。あるいは JavaScript のデバッグ ツールで、トークンの値を確認してもよいでしょう。Authorization ヘッダーに付与されたアクセス トークンの値をコピーし、[https://jwt.ms](https://jwt.ms) に張り付けると、トークンの scp (scope) として `Mail.Read` `openid` `profile` `User.Read` `email` が含まれていることが確認できます。![](/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/user-delegated-access-token.png)今回アプリ内で呼び出した、[ユーザーの取得 API](https://docs.microsoft.com/ja-jp/graph/api/user-get?view=graph-rest-1.0&tabs=http) は、最低限 `User.Read` のユーザー委任の権限が必要ですので、`User.Read` のスコープが含まれたアクセス トークンを提示すれば API にアクセスができるようになります。 --><h3 id="ユーザー委任の-API-のアクセス許可のまとめ"><a href="#ユーザー委任の-API-のアクセス許可のまとめ" class="headerlink" title="ユーザー委任の API のアクセス許可のまとめ"></a>ユーザー委任の API のアクセス許可のまとめ</h3><p>Microsoft Graph API をユーザー委任の権限で呼び出すアプリを実装しました。<br>アプリは scope と呼ばれる単位で、ユーザーに API のアクセス許可の同意を要求し、ユーザーが同意することでそれらのアクセス許可を委任されます。</p><p>ユーザーの同意済みスコープはエンタープライズ アプリケーション (サービス プリンシパル) に保存されますが、これらのスコープはもともと Microsoft Graph のサービス プリンシパルに OAuth2PermissionScopes として定義されています。<br>API の呼び出しに必要な scope を含むアクセス トークンを取得することで、Microsoft Graph API を呼び出すことができました。</p><h2 id="アプリケーションのアクセス許可"><a href="#アプリケーションのアクセス許可" class="headerlink" title="アプリケーションのアクセス許可"></a>アプリケーションのアクセス許可</h2><p>ここまではユーザー委任のアクセス許可について説明しましたが、アプリケーションのアクセス許可についても少し説明します。とはいえ、ユーザー委任の権限に比べると少しシンプルです。</p><p>ユーザー委任の権限は、scope という単位で、アクセス時にユーザーに同意を求める動作でした。<br>それに対し、アプリケーションのアクセス許可はアプリの作成時に事前に定義を行います。</p><h3 id="アプリケーションを作成し、アクセス許可を付与する"><a href="#アプリケーションを作成し、アクセス許可を付与する" class="headerlink" title="アプリケーションを作成し、アクセス許可を付与する"></a>アプリケーションを作成し、アクセス許可を付与する</h3><p>アプリケーションのアクセス許可の付与方法については、以前ブログで <a href="https://github.com/jpazureid/get-last-signin-reports/tree/use-signin-activity-beta-api">ユーザーの最終サインイン日時を取得するスクリプト</a> を紹介しましたので、こちらをサンプルとして利用します。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/app-oauth-flow.png"></p><p>上記サンプルでは、<code>User.Read.All</code> と <code>AuditLog.Read.All</code> のアプリケーションのアクセス許可をアプリに付与し、管理者の同意を実施していました。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/app-permissions.png"></p><p>そしてアプリは保存されたクライアント シークレットや証明書を利用し、Microsoft Graph API を呼び出すためのアクセス トークンを取得しています。</p><h3 id="アプリケーションの権限を付与することで何が起きたのか"><a href="#アプリケーションの権限を付与することで何が起きたのか" class="headerlink" title="アプリケーションの権限を付与することで何が起きたのか"></a>アプリケーションの権限を付与することで何が起きたのか</h3><p>先ほどと同様に、クライアントとして登録したアプリのサービス プリンシパルを確認してみましょう。<br>アクセス許可を確認すると、種類が Application となっており、クレームの値は User.Read.All となっています。また、付与方法が “管理者の同意” となっていることも確認できます。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/app-permissions-2.png"></p><p>つまり、今回も User.Read.All の scope に同意したということなのでしょうか。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/app-permissions-3.png"></p><p>先ほどと同じように、同意済みの scope を Get-MgOauth2PermissionGrant コマンドで確認してみましょう。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$myAppSp</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;displayName eq &#x27;Get Last SignIn&#x27;&quot;</span></span><br><span class="line"><span class="variable">$oAuth2Permissions</span> = <span class="built_in">Get-MgServicePrincipalOauth2PermissionGrant</span> <span class="literal">-ServicePrincipalId</span> <span class="variable">$myAppSp</span>.Id</span><br><span class="line"><span class="variable">$oAuth2Permissions</span> | <span class="built_in">fl</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># ClientId             : 383b27b3-1525-4362-a92b-4ca0625ff497</span></span><br><span class="line"><span class="comment"># ConsentType          : AllPrincipals</span></span><br><span class="line"><span class="comment"># Id                   : syc7OCUVYkOpK0ygYl_0l5xBqRlvzMZHiPMPKpZKTxY</span></span><br><span class="line"><span class="comment"># PrincipalId          :</span></span><br><span class="line"><span class="comment"># ResourceId           : 19a9419c-cc6f-47c6-88f3-0f2a964a4f16</span></span><br><span class="line"><span class="comment"># Scope                : User.Read</span></span><br><span class="line"><span class="comment"># Keys                 : &#123;&#125;</span></span><br><span class="line"><span class="comment"># Values               : &#123;&#125;</span></span><br><span class="line"><span class="comment"># AdditionalProperties : &#123;&#125;</span></span><br><span class="line"><span class="comment"># Count                : 0</span></span><br></pre></td></tr></table></figure><p>残念ながら、デフォルトで設定されている <code>User.Read</code> ※ のユーザー権限のアクセス許可のみが表示されており、<code>User.Read.All</code> や <code>AuditLog.Read.All</code> のアクセス許可は見当たりません。</p><blockquote><p>※ デフォルトで設定されている <code>User.Read</code> のアクセス許可は、サインインログの取得に特に必要ない権限ですが特に削除の必要もないため削除しておりませんでした。ユーザー委任のアクセス許可にもこのように管理者の同意ができます。</p></blockquote><h3 id="アプリケーション権限の正体"><a href="#アプリケーション権限の正体" class="headerlink" title="アプリケーション権限の正体"></a>アプリケーション権限の正体</h3><p>結論を述べると、アプリケーション権限の正体は scope ではありません。<br>アプリケーション権限のアクセス許可は AppRole であり、同意済みの権限は <a href="https://docs.microsoft.com/ja-jp/graph/api/serviceprincipal-list-approleassignedto?view=graph-rest-1.0&tabs=http">AppRoleAssignments</a> と呼ばれ PowerShell だと以下のコマンドで取得できます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$appRoleAssignments</span> = <span class="built_in">Get-MgServicePrincipalAppRoleAssignment</span> <span class="literal">-ServicePrincipalId</span> <span class="variable">$myAppSp</span>.Id</span><br><span class="line"><span class="variable">$appRoleAssignments</span> | <span class="built_in">fl</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># AppRoleId            : df021288-bdef-4463-88db-98f22de89214</span></span><br><span class="line"><span class="comment"># CreatedDateTime      : 2020/11/29 13:11:35</span></span><br><span class="line"><span class="comment"># DeletedDateTime      :</span></span><br><span class="line"><span class="comment"># Id                   : syc7OCUVYkOpK0ygYl_0l4kLNbV1-qFJl5eXj-YK7xo</span></span><br><span class="line"><span class="comment"># PrincipalDisplayName : Get Last SignIn</span></span><br><span class="line"><span class="comment"># PrincipalId          : 383b27b3-1525-4362-a92b-4ca0625ff497</span></span><br><span class="line"><span class="comment"># PrincipalType        : ServicePrincipal</span></span><br><span class="line"><span class="comment"># ResourceDisplayName  : Microsoft Graph</span></span><br><span class="line"><span class="comment"># ResourceId           : 19a9419c-cc6f-47c6-88f3-0f2a964a4f16</span></span><br><span class="line"><span class="comment"># Keys                 : &#123;&#125;</span></span><br><span class="line"><span class="comment"># Values               : &#123;&#125;</span></span><br><span class="line"><span class="comment"># AdditionalProperties : &#123;&#125;</span></span><br><span class="line"><span class="comment"># Count                : 0</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># AppRoleId            : b0afded3-3588-46d8-8b3d-9842eff778da</span></span><br><span class="line"><span class="comment"># CreatedDateTime      : 2020/11/29 13:11:35</span></span><br><span class="line"><span class="comment"># DeletedDateTime      :</span></span><br><span class="line"><span class="comment"># Id                   : syc7OCUVYkOpK0ygYl_0l714yGEg10ZHlHTmMMwK0Cc</span></span><br><span class="line"><span class="comment"># PrincipalDisplayName : Get Last SignIn</span></span><br><span class="line"><span class="comment"># PrincipalId          : 383b27b3-1525-4362-a92b-4ca0625ff497</span></span><br><span class="line"><span class="comment"># PrincipalType        : ServicePrincipal</span></span><br><span class="line"><span class="comment"># ResourceDisplayName  : Microsoft Graph</span></span><br><span class="line"><span class="comment"># ResourceId           : 19a9419c-cc6f-47c6-88f3-0f2a964a4f16</span></span><br><span class="line"><span class="comment"># Keys                 : &#123;&#125;</span></span><br><span class="line"><span class="comment"># Values               : &#123;&#125;</span></span><br><span class="line"><span class="comment"># AdditionalProperties : &#123;&#125;</span></span><br><span class="line"><span class="comment"># Count                : 0</span></span><br></pre></td></tr></table></figure><p>先ほどと同じように、ResourceId <code>19a9419c-cc6f-47c6-88f3-0f2a964a4f16</code> の Microsoft Graph の権限が 2 つ現れました。<br>おそらくどちらかが <code>User.Read.All</code> で、どちらかが <code>AuditLog.Read</code> のはずなのですが、これらの情報からどうやって確認すればよいのでしょうか。</p><p>もちろん、これらの値は Microsoft Graph のサービス プリンシパルに定義されています。<br>実ははアプリケーションの権限の API のアクセス許可は <a href="https://docs.microsoft.com/en-us/graph/api/resources/approle?view=graph-rest-1.0">AppRole</a> として定義されています。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$msGraph</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-ServicePrincipalId</span> <span class="number">19</span>a9419c<span class="literal">-cc6f</span><span class="literal">-47c6</span><span class="literal">-88f3</span><span class="literal">-0f2a964a4f16</span></span><br><span class="line"><span class="variable">$msGraph</span>.AppRoles| <span class="built_in">Select-Object</span> Value, Id, DisplayName <span class="literal">-First</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Value                             Id                                   DisplayName</span></span><br><span class="line"><span class="comment"># -----                             --                                   -----------</span></span><br><span class="line"><span class="comment"># DataLossPreventionPolicy.Evaluate ba7b8302-40ad-475c-a768-5b990aa1dba1 Evaluate Data Loss Prevention policy</span></span><br><span class="line"><span class="comment"># SensitivityLabel.Evaluate         57f0b71b-a759-45a0-9a0f-cc099fbd9a44 Evaluate sensitivity labels</span></span><br><span class="line"><span class="comment"># SensitiveInfoType.Detect          673cd294-c6eb-43f7-8bc9-cee7da70d759 Detect sensitive information types</span></span><br><span class="line"><span class="comment"># SensitiveInfoType.Read.All        107747da-618e-4e26-bcaf-6adac31d8dae Read available sensitive information types</span></span><br><span class="line"><span class="comment"># APIConnectors.ReadWrite.All       1dfe531a-24a6-4f1b-80f4-7a0dc5a0a171 Read and write API connectors for authenticat...</span></span><br><span class="line"><span class="comment"># APIConnectors.Read.All            b86848a7-d5b1-41eb-a9b4-54a4e6306e97 Read API connectors for authentication flows</span></span><br><span class="line"><span class="comment"># TeamsTab.ReadWriteForUser.All     425b4b59-d5af-45c8-832f-bb0b7402348a Allow the app to manage all tabs for all users</span></span><br><span class="line"><span class="comment"># TeamsTab.ReadWriteForTeam.All     6163d4f4-fbf8-43da-a7b4-060fe85ed148 Allow the Teams app to manage all tabs for al...</span></span><br><span class="line"><span class="comment"># TeamsTab.ReadWriteForChat.All     fd9ce730-a250-40dc-bd44-8dc8d20f39ea Allow the Teams app to manage all tabs for al...</span></span><br><span class="line"><span class="comment"># ChatMessage.Read.All              b9bb2381-47a4-46cd-aafb-00cb12f68504 Read all chat messages</span></span><br></pre></td></tr></table></figure><p>Id からアクセス許可の値を逆引きすると、アプリに割り当てられた AppRole の権限を確認することができます。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$appRoleId</span> = <span class="variable">$appRoleAssignments</span> | %&#123; <span class="variable">$_</span>.AppRoleId &#125;</span><br><span class="line"><span class="variable">$msGraph</span>.AppRoles| ?&#123; <span class="variable">$appRoleId</span>.Contains(<span class="variable">$_</span>.Id) &#125; | <span class="built_in">Select-Object</span> Value, Id, DisplayName</span><br><span class="line"></span><br><span class="line"><span class="comment"># Value             Id                                   DisplayName</span></span><br><span class="line"><span class="comment"># -----             --                                   -----------</span></span><br><span class="line"><span class="comment"># AuditLog.Read.All b0afded3-3588-46d8-8b3d-9842eff778da Read all audit log data</span></span><br><span class="line"><span class="comment"># User.Read.All     df021288-bdef-4463-88db-98f22de89214 Read all users&#x27; full profiles</span></span><br></pre></td></tr></table></figure><!-- アクセス ログを取得するスクリプトの中で、アクセス トークンを出力し、[jwt.ms](https://jwt.ms) に張り付けると、roles (AppRoles) として、`User.Read.All` と `AuditLog.Read.All` が含まれていることが確認できます。![](/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/app-access-token.png) --><h3 id="アプリケーション権限の-API-のアクセス許可まとめ"><a href="#アプリケーション権限の-API-のアクセス許可まとめ" class="headerlink" title="アプリケーション権限の API のアクセス許可まとめ"></a>アプリケーション権限の API のアクセス許可まとめ</h3><p>まとめると、アプリケーション権限のアクセス許可は、AppRole として定義されていることを確認しました。<br>アプリケーション オブジェクトに API のアクセス許可を設定し、管理者の同意を行うことでサービス プリンシパルに AppRoleAssignment として許可された API のアクセス許可が保存されます。</p><p>そしてアクセス トークンには roles として、API のアクセス許可が含まれ、Microsoft Graph API ではこのクレームをもとに、API アクセスを制御できることを確認しました。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/app-oauth-flow-2.png"></p><h2 id="Nest-Step"><a href="#Nest-Step" class="headerlink" title="Nest Step"></a>Nest Step</h2><p>ここまでは、Microsoft Graph API の scope と AppRole について解説をしてきましたが、Microsoft ID プラットフォームでは独自の API を作成し、Azure AD で保護することも可能です。</p><p>Azure AD 上にリソースとしてのアプリを登録し、scope や AppRole を定義することにより、自社の API を Azure AD の ID エコシステムを利用し保護することが可能です。つまり、Azure AD 上で特定のユーザーのみがアクセス可能なように制御したり、条件付きアクセスポリシーで不正なアクセスから保護するといったことが可能になります。</p><h3 id="サンプルアプリ"><a href="#サンプルアプリ" class="headerlink" title="サンプルアプリ"></a>サンプルアプリ</h3><p>Azure AD で API を保護するには、API 用のアプリを登録し、scope や AppRole を定義します。<br>API 側では MSAL ライブラリを利用することにより、提示されたアクセス トークンを検証し、正規のトークンを所持するユーザー以外のアクセスをブロックすることが可能です。</p><p>具体的なサンプルは <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/quickstart-v2-dotnet-native-aspnet">クイックスタート: Microsoft ID プラットフォームによって保護されている ASP.NET Web API を呼び出す</a> をご参照ください。また <a href="https://github.com/Azure-Samples?q=webapi&type=&language=">各種言語のサンプル</a> は GitHub に公開されているか探してみてください。</p><p>今回は JavaScript の <a href="https://github.com/Azure-Samples/active-directory-javascript-nodejs-webapi-v2">API サンプル</a>を動かし、先ほど作った MS Graph Client Sample から独自の API を呼び出してみます。<br>最終的な構成は以下のようなイメージです。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-diagram.png"></p><h3 id="アプリの登録"><a href="#アプリの登録" class="headerlink" title="アプリの登録"></a>アプリの登録</h3><p>まずはクライアント アプリ同様に、アプリの登録画面から API を登録します。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-registration.png"></p><h4 id="scope-の登録"><a href="#scope-の登録" class="headerlink" title="scope の登録"></a>scope の登録</h4><p>scope つまり、OAuth2Permissions つまり、ユーザー委任のアクセス許可は API の公開から登録します。<br>scope を登録するには、事前にアプリケーション ID の URI (Identifier) を設定します。これは OAuth の audience (aud)、リソースを表す識別子となります※。例えば Microsoft Graph API では “<a href="https://graph.microsoft.com&quot;/">https://graph.microsoft.com&quot;</a> です。</p><p>この値はグローバルで一意である必要があり、初期設定では “api://appid” です。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-uri.png"></p><blockquote><p>※ アクセス トークン (V2) に含まれる aud の値はアプリケーション ID で固定です</p></blockquote><p>スコープ名は Microsoft Graph API に倣って XXX.Read のように設定しましたがアプリの構成に従い好きな名前をつけて OK です。細かいスコープを切らない場合、Microsoft のサービスでは “user_impersonation” がよく利用されます。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-scope-create.png"></p><p><code>スコープの追加</code> をクリックすると、スコープが追加されます。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-scope.png"></p><p>scope を指定する際には、本来このアプリケーション ID の URI と scope の値を <code>/</code> でつなげて指定する必要があります。今回の例では “api://5a6e76a2-0790-4ca7-b42e-27b31d70aa92/Data.Read” が指定すべき scope の値になります。</p><blockquote><p>scope の指定時にアプリケーション ID の URI を省略すると暗黙的に “<a href="https://graph.microsoft.com&quot;/">https://graph.microsoft.com&quot;</a> が指定されます。</p></blockquote><h4 id="AppRole-の追加"><a href="#AppRole-の追加" class="headerlink" title="AppRole の追加"></a>AppRole の追加</h4><p>実は AppRole の設定は最近 Azure ポータルから行えるようになりました。<br><code>アプリのロール (プレビュー) </code> にアクセスし、<code>アプリ ロールの作成</code>をクリックします。</p><p>アプリケーションに付与できる権限を定義する場合には、<code>許可されたメンバーの種類</code> を “アプリケーション” か、”両方” を選択します。<br>なぜ、アプリケーション権限の実態である Role をユーザーに対しても割り当てられるんだと思われるかもしれませんが、実はアプリケーションの AppRole だけでなく、ユーザーの AppRole を Azure AD に定義することもできます。<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">アプリ ロールを追加してトークンから取得する</a> により詳細が記載されているので、ロールベースのアクセス許可を Azure AD で実現されたい方はご覧ください。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-role-create.png"></p><p>このように、AppRole についても Azure ポータルから設定が可能となっています。</p><blockquote><p>2020/12/4 現在 日本語の表示に不具合があり、ロールが有効でも “無効” と表示されてしまっています。</p></blockquote><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-role.png"></p><p><code>マニフェスト</code> に移動し、後の動作確認のために accessTokenAcceptedVersion を 2 に設定し、保存します。<br>AppRole についてもマニフェストを確認することで、実際に有効になっているか確認できますので、不安な方はこちらをご覧ください。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-manifest.png"></p><h3 id="動作の確認-1"><a href="#動作の確認-1" class="headerlink" title="動作の確認"></a>動作の確認</h3><p>最後に、定義した API のアクセス許可の動作を確認してみます。</p><h4 id="クライアントの修正"><a href="#クライアントの修正" class="headerlink" title="クライアントの修正"></a>クライアントの修正</h4><p>まず自作の API を呼び出すためのアクセス トークンを取得します。アプリケーション権限の付与方法は、Graph API の場合と同じく、API のアクセス許可からアプリケーション権限の API を選択するだけですので省略します。</p><p>ユーザー権限のアクセス許可については、クイックスタートのサンプル (MS Graph Client Sample) を改造して呼び出しのイメージをつかんでみましょう。<br>いくつか修正点があるので順に説明します。</p><p>まずは、<code>authConfig.json</code> に <code>myAPITokenRequest</code> オブジェクトを作成しましょう。もともとの <code>tokenRequest</code> の scopes を “api://5a6e76a2-0790-4ca7-b42e-27b31d70aa92/Data.Read” に変更するだけです。</p><p>authConfig.json</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// my api token request</span></span><br><span class="line"><span class="keyword">const</span> myAPITokenRequest = &#123;</span><br><span class="line">    scopes: [<span class="string">&quot;api://5a6e76a2-0790-4ca7-b42e-27b31d70aa92/Data.Read&quot;</span>],</span><br><span class="line">    forceRefresh: <span class="literal">false</span> <span class="comment">// Set this to &quot;true&quot; to skip a cached token and go to the server to get a new token</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>API 呼び出し部分は、callMSGraph メソッドを流用し、<code>http://localhot:5000/api</code> を呼び出します。</p><p>authPopup.js</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callMyAPI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    getTokenPopup(myAPITokenRequest).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        callMSGraph(<span class="string">&quot;http://localhost:5000/api&quot;</span>, response.accessToken, updateUI);</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(error);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ui.js と index.html にもコードを追加します。</p><p>ui.js</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (endpoint === graphConfig.graphMeEndpoint) &#123;</span><br><span class="line">    <span class="keyword">const</span> title = <span class="built_in">document</span>.createElement(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">    title.innerHTML = <span class="string">&quot;&lt;strong&gt;Title: &lt;/strong&gt;&quot;</span> + data.jobTitle;</span><br><span class="line">    <span class="keyword">const</span> email = <span class="built_in">document</span>.createElement(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">    email.innerHTML = <span class="string">&quot;&lt;strong&gt;Mail: &lt;/strong&gt;&quot;</span> + data.mail;</span><br><span class="line">    <span class="keyword">const</span> phone = <span class="built_in">document</span>.createElement(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">    phone.innerHTML = <span class="string">&quot;&lt;strong&gt;Phone: &lt;/strong&gt;&quot;</span> + data.businessPhones[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> address = <span class="built_in">document</span>.createElement(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">    address.innerHTML = <span class="string">&quot;&lt;strong&gt;Location: &lt;/strong&gt;&quot;</span> + data.officeLocation;</span><br><span class="line">    profileDiv.appendChild(title);</span><br><span class="line">    profileDiv.appendChild(email);</span><br><span class="line">    profileDiv.appendChild(phone);</span><br><span class="line">    profileDiv.appendChild(address);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (endpoint === graphConfig.graphMailEndpoint) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data.value.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        alert(<span class="string">&quot;Your mailbox is empty!&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> tabList = <span class="built_in">document</span>.getElementById(<span class="string">&quot;list-tab&quot;</span>);</span><br><span class="line">        tabList.innerHTML = <span class="string">&#x27;&#x27;</span>; <span class="comment">// clear tabList at each readMail call</span></span><br><span class="line">        <span class="keyword">const</span> tabContent = <span class="built_in">document</span>.getElementById(<span class="string">&quot;nav-tabContent&quot;</span>);</span><br><span class="line"></span><br><span class="line">        data.value.map(<span class="function">(<span class="params">d, i</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// Keeping it simple</span></span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> listItem = <span class="built_in">document</span>.createElement(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">                listItem.setAttribute(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;list-group-item list-group-item-action&quot;</span>)</span><br><span class="line">                listItem.setAttribute(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;list&quot;</span> + i + <span class="string">&quot;list&quot;</span>)</span><br><span class="line">                listItem.setAttribute(<span class="string">&quot;data-toggle&quot;</span>, <span class="string">&quot;list&quot;</span>)</span><br><span class="line">                listItem.setAttribute(<span class="string">&quot;href&quot;</span>, <span class="string">&quot;#list&quot;</span> + i)</span><br><span class="line">                listItem.setAttribute(<span class="string">&quot;role&quot;</span>, <span class="string">&quot;tab&quot;</span>)</span><br><span class="line">                listItem.setAttribute(<span class="string">&quot;aria-controls&quot;</span>, i)</span><br><span class="line">                listItem.innerHTML = d.subject;</span><br><span class="line">                tabList.appendChild(listItem)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> contentItem = <span class="built_in">document</span>.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">                contentItem.setAttribute(<span class="string">&quot;class&quot;</span>, <span class="string">&quot;tab-pane fade&quot;</span>)</span><br><span class="line">                contentItem.setAttribute(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;list&quot;</span> + i)</span><br><span class="line">                contentItem.setAttribute(<span class="string">&quot;role&quot;</span>, <span class="string">&quot;tabpanel&quot;</span>)</span><br><span class="line">                contentItem.setAttribute(<span class="string">&quot;aria-labelledby&quot;</span>, <span class="string">&quot;list&quot;</span> + i + <span class="string">&quot;list&quot;</span>)</span><br><span class="line">                contentItem.innerHTML = <span class="string">&quot;&lt;strong&gt; from: &quot;</span> + d.from.emailAddress.address + <span class="string">&quot;&lt;/strong&gt;&lt;br&gt;&lt;br&gt;&quot;</span> + d.bodyPreview + <span class="string">&quot;...&quot;</span>;</span><br><span class="line">                tabContent.appendChild(contentItem);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//追加</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(endpoint === <span class="string">&quot;http://localhost:5000/api&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> apiResponseDiv = <span class="built_in">document</span>.getElementById(<span class="string">&quot;api-response-div&quot;</span>);</span><br><span class="line">    apiResponseDiv.innerHTML = <span class="built_in">JSON</span>.stringify(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>index.html</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;seeProfile&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;seeProfile()&quot;</span>&gt;</span>See Profile<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;readMail&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;readMail()&quot;</span>&gt;</span>Read Mails<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">id</span>=<span class="string">&quot;callMyAPI&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callMyAPI()&quot;</span>&gt;</span>Call MyAPI<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;api-response-div&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>これでクライアント部分の実装は終了です。</p><h4 id="API-の実装"><a href="#API-の実装" class="headerlink" title="API の実装"></a>API の実装</h4><p>API では提示されたトークンが正規のものか、署名を検証し、必要なクレームの値 (例えば aud など) が含まれているかを検証する必要があります。<br>定義した API を保護するためのサンプルとしては、JavaScript の Passport を利用した以下のものを利用します。</p><ul><li><a href="https://github.com/Azure-Samples/active-directory-javascript-nodejs-webapi-v2">Azure-Samples/active-directory-javascript-nodejs-webapi-v2: A small Node.js Web API that is protected with Azure AD v2.0 to validate access tokens and accepts authorized calls.</a></li></ul><p>config.json を以下のように修正します。</p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;credentials&quot;: &#123;</span><br><span class="line">    &quot;tenantID&quot;: &quot;cae9d4b9-9fba-4add-9257-2bb9473a060f&quot;, //テナント ID</span><br><span class="line">    &quot;clientID&quot;: &quot;2d6aced0-40ae-4519-a2e5-8e23944fc046&quot;, //MS Graph Client Sample のアプリケーション ID</span><br><span class="line">    &quot;audience&quot;: &quot;5a6e76a2-0790-4ca7-b42e-27b31d70aa92&quot; //My API Sample のアプリケーション ID</span><br><span class="line">&#125;,</span><br><span class="line">&quot;resource&quot;: &#123;</span><br><span class="line">    &quot;scope&quot;: [&quot;Data.Read&quot;] //My API で作成した scope の値</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>修正後、以下のコマンドで API を起動します。正常に起動できれば <a href="http://localhost:5000/">http://localhost:5000</a> で API サーバーが動き出します。</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure><h4 id="動作確認"><a href="#動作確認" class="headerlink" title="動作確認"></a>動作確認</h4><p>最後に <a href="http://localhost:3000/">http://localhost:3000</a> にアクセスして、アプリにサインインしましょう。<code>Call MyAPI</code> をクリックすると先ほど定義した scope に同意するよう求められます。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-consent.png"></p><p>承諾をクリックすると、<code>http://localhost:5000/api</code> の API を呼び出すためのトークンが取得され、無事 API を呼び出すことに成功します。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-response.png"></p><p>最終的な構成はこのようなイメージです。</p><p><img src="/jpazureid-test/azure-active-directory/oauth2-application-resource-and-api-permissions/api-diagram-detail.png"></p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回は Microsoft Graph API を呼び出すサンプルと、独自の API を定義することで、Azure AD 上で OAuth の scope や AppRole の定義方法やその実体を見てみました。チュートリアルをこなすだけでは見えてこない詳細なイメージがつかめたのではないでしょうか。</p><p>スコープや AppRole について理解することは、独自のアプリを実装するときだけでなく Microsoft が提供する API を利用する際にも非常に役に立つと思います。</p><p>さらに、独自のアプリを実装するに当たっては、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/single-and-multi-tenant-apps">Azure AD のシングルテナント アプリとマルチテナント アプリ</a> の違いを理解したり、Microsoft が推奨する<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/develop/identity-platform-integration-checklist">ベストプラクティスのチェックリスト</a>を確認したりするのがよいと思います。</p><p>皆様もぜひ、Azure AD を利用したセキュアなアプリ開発を実践してみてください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure ID チームの埴山です。&lt;/p&gt;
&lt;p&gt;本記事は &lt;a href=&quot;https://qiita.com/advent-calendar/2020/microsoft-azure-tech&quot;&gt;Azure Tech Advent Calendar&lt;/a&gt;</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="OAuth" scheme="https://georgioush.github.io/jpazureid-test/tags/OAuth/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD B2B ゲストユーザーの連絡先情報更新方法について</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/update-B2B-user-address/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/update-B2B-user-address/</id>
    <published>2020-10-21T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.926Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの小田です。<br>今回は、Azure AD B2B ゲストユーザーの連絡先情報（電子メール / 連絡用メールアドレス）の更新方法についてご案内いたします。</p><p>Azure AD にて別組織のユーザーを招待しますと、テナントにゲストユーザーが作成されます。<br>ゲストユーザーの連絡先情報（電子メール / 連絡用メールアドレス）には、招待したときに指定したメールアドレスが設定され、<br>これらは Azure 側からの通知メール（計画メンテナンス、MFA の通知など）の宛先として使用されます。</p><p>ゲストユーザーが招待を承諾した後で、そのユーザーの実体が登録されているホームテナント側でメールアドレスの変更があった場合、そのユーザーをゲストとして登録しているリソーステナント側では、メールアドレスの変更は反映されません。</p><p>そのため、ゲストユーザーがホームテナント側で持っている属性値（メールアドレス等）を修正する場合、これまではゲストユーザーを一旦削除して「再招待」を実施するか、Microsoft Graph API、Exchange 管理センター、または Exchange Online PowerShell 経由で更新する必要がありました。</p><p>しかしながら、2020 年 10 月現在、ゲストユーザーの連絡先情報（電子メール / 連絡用メールアドレス）は、Azure AD 管理センターにて編集可能になりました。<br>再招待を実施することなく、ゲストユーザーのメール アドレスの変更を変更する、その具体的な手順は、下記の通りです。</p><h2 id="変更手順"><a href="#変更手順" class="headerlink" title="変更手順"></a>変更手順</h2><ol><li>Azure ポータル <a href="https://portal.azure.com/">(https://portal.azure.com/)</a> にアクセスし、グローバル管理者もしくはユーザー管理者にてサインインします。</li><li>[Azure Active Directory] - [ユーザー] - [すべてのユーザー] - [編集対象のゲストユーザー] をクリックし、[プロパティ] を開きます。</li><li>[編集] をクリックし、「連絡先情報」を編集します。</li></ol><p><img src="/jpazureid-test/azure-active-directory/update-B2B-user-address/address-update-in-AzurePortal.png"></p><ol start="4"><li>[保存] をクリックします。</li></ol><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><p>Azure Active Directory B2B コラボレーション ユーザーのプロパティ<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/external-identities/user-properties#can-i-update-a-guest-users-email-address">https://docs.microsoft.com/ja-jp/azure/active-directory/external-identities/user-properties#can-i-update-a-guest-users-email-address</a></p><p>Changelog for Microsoft Graph<br><a href="https://docs.microsoft.com/en-us/graph/changelog">https://docs.microsoft.com/en-us/graph/changelog</a></p><p>なお、Azure ポータルでは、ゲストユーザーだけではなく、組織内ユーザーにおきましても電子メールを変更することが可能です。<br>組織内ユーザーは、Exchange Online のライセンスが割り当たっている可能性もありますので、このような場合は、 Exchange Online 側でメールアドレス操作を実施ください。</p><p>上記内容が少しでも参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの小田です。&lt;br&gt;今回は、Azure AD B2B ゲストユーザーの連絡先情報（電子メール / 連絡用メールアドレス）の更新方法についてご案内いたします。&lt;/p&gt;
&lt;p&gt;Azure AD にて別組織のユーザーを招待</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="Azure AD B2B" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD-B2B/"/>
    
  </entry>
  
  <entry>
    <title>パスワード ライトバックのしくみと一般的なトラブルシューティング</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory-connect/password-writeback-overview/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory-connect/password-writeback-overview/</id>
    <published>2020-10-14T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.748Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの金子です。<br>今回はパスワード ライトバックのしくみと一般的なトラブルシューティングについてご紹介します。</p><h2 id="パスワード-ハッシュ同期とパスワード-ライトバックの違いとは"><a href="#パスワード-ハッシュ同期とパスワード-ライトバックの違いとは" class="headerlink" title="パスワード ハッシュ同期とパスワード ライトバックの違いとは"></a>パスワード ハッシュ同期とパスワード ライトバックの違いとは</h2><p>まず、ユーザーは Azure AD Connect により、オンプレミス AD から Azure AD に同期されていることを前提とします。<br>パスワード ハッシュ同期についてはご存じの方が多いと思いますが、パスワード ハッシュ同期はオンプレミスの認証パスワード (厳密にはパスワード ハッシュ) を Azure AD に同期する機能です。これによりユーザーは同じ ID/パスワードで Office 365 などのクラウド上のアプリにもサインインすることができるようになります。<br>オンプレミス側でパスワードを変更した場合も同様にクラウド側へ同期されますが、逆にクラウド側からはオンプレミス側のパスワードをリセットしたり変更することはできません。なぜなら、パスワード ハッシュ同期はオンプレミスの Active Directory Domain Services (AD DS) から Azure AD への一方向の同期しかおこなわないためです。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/1_phs.png"></p><p>そのため、社外で仕事をしておりオンプレミス AD に接続できないような状況で次のような要件が発生する場合はパスワード ライトバックを有効化する必要があります。</p><ul><li><p><strong>ユーザーが Microsoft 365 などのクラウド アプリにサインインする認証パスワードを忘れたため、ユーザー自身で同期ユーザーのパスワードをリセットしたい</strong></p></li><li><p><strong>何らかの要件があり Azure AD の管理者が、同期ユーザーのパスワードを強制的にリセットしたい</strong></p></li><li><p><strong>Azure AD Identity Protection によって同期ユーザーの資格情報の漏洩が疑われた (リスク検知した) 場合に、ユーザー自身でパスワードを変更 (または リセット) したい、Azure AD の管理者がユーザーに代わってパスワードをリセットしたい</strong></p></li></ul><p>上記のようなシナリオでは、パスワード ライトバックを有効にすることで要件を実現できます。<br>SSPR と連動させれば、ユーザーがパスワードを忘れてしまった場合でもユーザー自身がオンプレミス AD のパスワードをリセットできるため、IT 管理者の負荷を軽減することができます。<br>また、Identity Protection によって不正なアクセスなどを検知した場合、ユーザー自身が同期ユーザーのパスワードを変更 (リセット) できる他、管理者は Azure ポータルにサインインできる環境であれば、どこにいてもユーザーのパスワードを強制的にリセットすることができますので、セキュリティ リスクを軽減することにもつながります。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/2_password-writeback.png"></p><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><p>同期ユーザーに対する社外ネットワークからのパスワード変更およびリセットを実現するためには、次の前提条件をすべて満たしている必要があります。</p><ol><li>Azure AD Connect でパスワード ライトバックを有効化していること</li><li>Azure ポータル上でセルフサービス パスワード リセット (SSPR) が有効になっていること（“オンプレミスとの統合”）</li><li>利用するユーザーごとに Azure AD Premium P1 または P2 ライセンス、もしくは Microsoft 365 Business Premium ライセンスを持っていること</li><li>AD DS コネクタ アカウントに下記のアクセス許可があること<ul><li>パスワードのリセット</li><li>lockoutTime に対する書き込みアクセス許可</li><li>pwdLastSet に対する書き込みアクセス許可</li><li>まだ設定していない場合は、そのフォレスト内の “各ドメイン” のルート オブジェクトに対する “期限切れではないパスワード” の拡張権利があること</li></ul></li><li>Azure AD Connect サーバーから下記の外部 URL へ HTTPS で接続できること<pre><code> *.passwordreset.microsoftonline.com *.servicebus.windows.net</code></pre></li></ol><h2 id="パスワード-ライトバックのしくみ"><a href="#パスワード-ライトバックのしくみ" class="headerlink" title="パスワード ライトバックのしくみ"></a>パスワード ライトバックのしくみ</h2><p>ではパスワード ライトバックが実際にどのようなしくみで動作しているかを説明します。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/3_password-writeback-detail.png"></p><p>まず、ユーザーが Azure AD のアカウントでパスワード変更 (SSPR)  要求をおこないますと、設定したパスワードが暗号化され、テナント固有の Service Bus へ送られます。<br>Service Bus に保留中のリセット要求が届くと、パスワード リセット エンドポイントがオープンし、Azure AD Connect サーバーの Password Reset Service が処理を開始 (PasswordResetRequestStart) し Azure AD 側から暗号化されたパスワードを取得します。<br>これはオンプレミス側からクラウド側への Outbound (HTTPS / 443) の通信でおこなわれますので、クラウド側からオンプレミス側への Inbound の通信（ポート）を開放する必要はありません。</p><p>Password Reset Service がパスワードを取得しますと、秘密鍵で複合化し、Azure AD Connect はリセット要求のあったユーザーをデータべ―ス内から探し出し、AD Sync サービスが適切な AD DS に対してパスワード リセットを要求します。この時、実際のパスワードリセットは Azure AD Connect で設定したオンプレミス AD 上の AD DS コネクタ アカウント (既定では MSOL_xxxxx) がおこないます。</p><p>そして、パスワード リセット (変更) が成功しますと、Password Reset Service は成功 (PasswordResetSuccess) を Azure AD 側に通知します。<br>この通知を受け取るとパスワード変更 (SSPR)  が完了します。</p><p>このパスワード ライトバックの一連の処理はログ上では次のように記録されます。</p><h3 id="●-Azure-AD-Connect-サーバーのアプリケーション-イベントログ"><a href="#●-Azure-AD-Connect-サーバーのアプリケーション-イベントログ" class="headerlink" title="● Azure AD Connect サーバーのアプリケーション イベントログ"></a>● Azure AD Connect サーバーのアプリケーション イベントログ</h3><p><strong>PasswordResetService</strong><br>Event ID: 31001<br>PasswordResetRequestStart, Details: <a href="mailto:&#x75;&#x73;&#101;&#114;&#49;&#64;&#x63;&#111;&#110;&#x74;&#111;&#x73;&#x6f;&#46;&#x63;&#111;&#109;">&#x75;&#x73;&#101;&#114;&#49;&#64;&#x63;&#111;&#110;&#x74;&#111;&#x73;&#x6f;&#46;&#x63;&#111;&#109;</a></p><p><strong>ADSync</strong><br>Event ID: 405<br>Call sync ldap_bind for DomainName=CONTOSO.COM, UserName=MSOL_xxxxxxxxx.</p><p><strong>ADSync</strong><br>Event ID: 403<br>ImpersonationHelper call LogonUser for DomainName=CONTOSO.COM, UserName=MSOL_xxxxxxxxx.</p><p><strong>ADSync</strong><br>Event ID: 405<br>Call sync ldap_bind for DomainName=CONTOSO.COM, UserName=MSOL_xxxxxxxxx.</p><p><strong>PasswordResetService</strong><br>Event ID: 31002<br>TrackingId: xxxxxxxxx-xxxx-xxxxxxxxx-xxxxxxxxx, PasswordResetSuccess, Details: Context: cloudAnchor: User_xxxxxxxxx-xxxxxxxxx, SourceAnchorValue: xxxxxxxxxxxxxxxxxx, UserPrincipalName: <a href="mailto:&#x75;&#115;&#101;&#x72;&#x31;&#64;&#99;&#111;&#110;&#x74;&#x6f;&#x73;&#111;&#x2e;&#99;&#x6f;&#x6d;">&#x75;&#115;&#101;&#x72;&#x31;&#64;&#99;&#111;&#110;&#x74;&#x6f;&#x73;&#111;&#x2e;&#99;&#x6f;&#x6d;</a>, unblockUser: True</p><h3 id="●-Azure-AD-の監査ログ"><a href="#●-Azure-AD-の監査ログ" class="headerlink" title="● Azure AD の監査ログ"></a>● Azure AD の監査ログ</h3><p><strong>Self-service password reset flow activity progress</strong><br>User submitted a new password</p><p><strong>Reset user password</strong></p><p><strong>Update StsRefreshTokenValidFrom Timestamp</strong></p><p><strong>Reset password (self-service)</strong><br>Successfully completed reset.</p><p><strong>Self-service password reset flow activity progress</strong><br>User successfully reset password</p><p>また、パスワード ハッシュ同期を有効化している場合は、パスワード ライトバック後に下記のログが記録されます。<br>これは Password Reset Service とは別のパスワード ハッシュ同期処理のプロセスが動作しているためで、オンプレミス AD 側で変更されたパスワードは通常のパスワード ハッシュ同期のタイミング ( 2 分に一度) で Azure AD 側へ同期されます。<br>これはパスワード ハッシュ同期の既定の動作とご理解ください。</p><h3 id="●-Azure-AD-Connect-サーバーのアプリケーション-イベントログ-1"><a href="#●-Azure-AD-Connect-サーバーのアプリケーション-イベントログ-1" class="headerlink" title="● Azure AD Connect サーバーのアプリケーション イベントログ"></a>● Azure AD Connect サーバーのアプリケーション イベントログ</h3><p><strong>Directory Synchronization</strong><br>Event ID: 657<br>Password Change Result</p><h3 id="●-Azure-AD-の監査ログ-1"><a href="#●-Azure-AD-の監査ログ-1" class="headerlink" title="● Azure AD の監査ログ"></a>● Azure AD の監査ログ</h3><p><strong>Change user password</strong></p><p>(補足）<br>パスワード ライトバックを利用する上で、パスワード ハッシュ同期の有効化は必須ではありません。<br>パスワード ライトバックはパスワード ハッシュ同期による認証だけではなく、パススルー認証や AD FS の環境でもサポートされています。よって、認証方法によらず、同期ユーザーは Azure AD 側からもパスワード変更 (SSPR) をおこなうことができます。</p><h2 id="トラブルシューティング"><a href="#トラブルシューティング" class="headerlink" title="トラブルシューティング"></a>トラブルシューティング</h2><p>パスワード ライトバックが失敗するシナリオはいくつか考えられます。<br>ここでは一般的なエラー要因とその対処方法についてご紹介します。</p><ol><li>変更したパスワードが オンプレミス AD のパスワード ポリシーを満たしていない (Event ID 33008)</li><li>“password” や “baseball” といった推測されやすい用語が含まれているため Azure AD 側で変更が拒否された</li><li>パスワード ライトバックに必要なアクセス許可が付与されていない (Event ID 33004)</li><li>ADSync サービスがダウンしていた (Event ID 31034)</li><li>オンプレミス AD 側でユーザーが見つからない (Event ID 33002)</li><li>オンプレミス AD の保護されたグループ内に存在する管理者アカウントのパスワードをリセットした (Event ID 33004)</li><li>Azure AD Connect 構成ウィザードでパスワード ライトバックを有効化できない</li></ol><h4 id="1-変更したパスワードが-オンプレミス-AD-のパスワード-ポリシーを満たしていない-Event-ID-33008"><a href="#1-変更したパスワードが-オンプレミス-AD-のパスワード-ポリシーを満たしていない-Event-ID-33008" class="headerlink" title="1. 変更したパスワードが オンプレミス AD のパスワード ポリシーを満たしていない (Event ID 33008)"></a>1. 変更したパスワードが オンプレミス AD のパスワード ポリシーを満たしていない (Event ID 33008)</h4><p>[エラー内容]<br>Azure AD Connect のイベントログには Event ID 33008 のエラーが記録されます。<br>エラー メッセージ：<strong>A restriction prevents the password from being changed to the current one specified.</strong></p><p>[原因と対処方法]<br>パスワードライトバックを利用して同期ユーザーのパスワードリセット (変更) を行った場合、オンプレミス AD のパスワードポリシーおよび Azure AD のパスワードポリシー双方が評価されます。<br>オンプレミス AD のパスワード ポリシー (文字数や変更禁止期間など) やアカウントのパスワード変更禁止設定など、パスワード ポリシーを満たしていない場合、パスワード変更は下記のエラーが返されます。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/4_error.png"></p><p>この場合はオンプレミス AD のパスワード ポリシーで決められた範囲でパスワードを変更する必要があります。<br>「グループ ポリシー管理エディター」にて「パスワード ポリシーの設定」をご確認ください。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/5_gpo.png"></p><h4 id="2-“password”-や-“baseball”-といった推測されやすい用語が含まれているため-Azure-AD-側で変更が拒否された"><a href="#2-“password”-や-“baseball”-といった推測されやすい用語が含まれているため-Azure-AD-側で変更が拒否された" class="headerlink" title="2. “password” や “baseball” といった推測されやすい用語が含まれているため Azure AD 側で変更が拒否された"></a>2. “password” や “baseball” といった推測されやすい用語が含まれているため Azure AD 側で変更が拒否された</h4><p>[エラー内容]<br>上述の通り、パスワードライトバックを利用して同期ユーザーのパスワード変更 (リセット) を実施した場合、オンプレミス AD のパスワードポリシーに加えて、Azure AD のパスワードポリシーも評価されます。<br>もし パスワード リセットで設定したパスワードが Azure AD 側の禁止文字に該当する場合は、変更が拒否されます。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/6_error2.png"></p><p>[原因と対処方法]<br>Azure AD 側ではパスワードの文字列に対して以下の両方のチェックがおこなわれます。このチェックはオンプレミス AD にパスワード リセットを要求する前に Azure AD によって内部的に実行されます。</p><ul><li>グローバル禁止パスワード</li><li>カスタム禁止パスワード</li></ul><p>グローバル禁止パスワードは、 Azure AD がグローバルで禁止しているパスワード リストです。<br>セキュリティ上このリストは公開されていませんが、 “password” や “baseball” といった推測されやすい用語が含まれている場合が該当します。</p><p>カスタム禁止パスワードは、管理者が設定できる禁止パスワードです。<br>これらの禁止パスワードを利用しないようにパスワード変更 (リセット) を行うことが対処策となります。</p><h4 id="3-パスワード-ライトバックに必要なアクセス許可が付与されていない-Event-ID-33004"><a href="#3-パスワード-ライトバックに必要なアクセス許可が付与されていない-Event-ID-33004" class="headerlink" title="3. パスワード ライトバックに必要なアクセス許可が付与されていない (Event ID 33004)"></a>3. パスワード ライトバックに必要なアクセス許可が付与されていない (Event ID 33004)</h4><p>[エラー内容]<br>前述の「前提条件 (4)」 に記載したパスワード ライトバックに必要なアクセス許可が対象のユーザーや OU に付与されていない場合はエラーが返されます。</p><p>Azure AD Connect のイベントログに Event ID 33004 のエラーが記録されます。<br>エラー メッセージ：<strong>Requesting user was denied access to perform the operation on a privileged account.</strong></p><p>[原因と対処方法]<br>パスワード変更をおこなう AD DS コネクタ アカウントには以下の 2 つがあり、ご自身の環境がどちらのアカウントを使用しているかを確認します。</p><p>a. Azure AD Connect のインストール時に新規で作成されたアカウント (既定では MSOL_xxxxx)<br>b. オンプレミス AD 上に作成した既存のアカウント</p><p>a のアカウントは自動でルート ディレクトリに対して必要なアクセス許可が付与されますので、配下の OU やユーザーにもアクセス許可が継承されます。そのため、通常はパスワード変更の権限も付与されています。</p><p>b のアカウントはアクセス許可を手動で割り当てる必要があります。もしアクセス許可を付与していない場合は、下記に記載された PowerShell コマンドレットで権限を付与してください。</p><p>パスワード ライトバックのアクセス許可<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-configure-ad-ds-connector-account#permissions-for-password-writeback">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-configure-ad-ds-connector-account#permissions-for-password-writeback</a></p><h4 id="4-ADSync-サービスがダウンしていた-Event-ID-31034"><a href="#4-ADSync-サービスがダウンしていた-Event-ID-31034" class="headerlink" title="4. ADSync サービスがダウンしていた (Event ID 31034)"></a>4. ADSync サービスがダウンしていた (Event ID 31034)</h4><p>[エラー内容]<br>Azure AD Connect のイベントログには Event ID 31034 のエラーが記録されます。<br>エラー メッセージ：<strong>The connection to the connect service was lost.</strong></p><p>[原因と対処方法]<br>ADSync サービスがダウンしている場合はパスワード リセットが失敗します。<br>Azure AD Connect サーバーの ADSync サービスを再起動してください。</p><h4 id="5-オンプレミス-AD-側でユーザーが見つからない-Event-ID-33002"><a href="#5-オンプレミス-AD-側でユーザーが見つからない-Event-ID-33002" class="headerlink" title="5. オンプレミス AD 側でユーザーが見つからない (Event ID 33002)"></a>5. オンプレミス AD 側でユーザーが見つからない (Event ID 33002)</h4><p>[エラー内容]<br>Azure AD Connect のイベントログには Event ID 33002 のエラーが記録されます。<br>エラー メッセージ：<strong>The operation failed because the object could not be found.</strong></p><p>[原因と対処方法]<br>オンプレミス AD 側でユーザーが見つからない場合はパスワード リセットが失敗します。<br>オンプレミス AD にユーザーが存在することを確認してください。</p><h4 id="6-オンプレミス-AD-の保護されたグループ内に存在する管理者アカウントのパスワードをリセットした-Event-ID-33004"><a href="#6-オンプレミス-AD-の保護されたグループ内に存在する管理者アカウントのパスワードをリセットした-Event-ID-33004" class="headerlink" title="6. オンプレミス AD の保護されたグループ内に存在する管理者アカウントのパスワードをリセットした (Event ID 33004)"></a>6. オンプレミス AD の保護されたグループ内に存在する管理者アカウントのパスワードをリセットした (Event ID 33004)</h4><p>[エラー内容]<br>Azure AD Connect のイベントログには Event ID 33004 のエラーが記録されます。<br>エラー メッセージ：<strong>The password could not be updated because the management agent credentials were denied access.</strong></p><p>●エラーになる操作<br>サインイン時に「パスワードを忘れた場合」をクリックします。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/7_forget-password.png"></p><p>SSPR の画面に遷移します。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/8_sspr.png"></p><p>パスワード リセットはエラーになります。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/9_sspr-error.png"></p><p>[原因と対処方法]<br>対象のユーザー アカウントが Active Directory の保護されたグループ (例えば Enterprise Admins や Domain Admins ) に所属していることが考えられます。</p><p>オンプレミス AD の保護されたグループに所属しているメンバーは、パスワード リセット (パスワードを忘れた場合のリセット) はできません。</p><p>Active Directory の保護されたグループ (いわゆる管理者グループ) は、SDProp と呼ばれるプロセスにより 1 時間に 1 回、AdminSDHolder オブジェクトに設定されているアクセス許可で上書きされます。そのため、AD ユーザーに対してパスワード リセットを実行している “AD DS コネクタ アカウント” のリセット権限も失われ、結果として Azure AD Connect のパスワード リセットは失敗します。<br>保護されたグループのメンバーは、ユーザー プロパティの adminCount 属性に “1” が自動で設定されます。</p><p>本エラーの対処方法としては、オンプレミス AD の保護されたグループ メンバーから外す必要があります。<br>グループのメンバーから外した後、[Active Directoty ユーザーとコンピューター] の プロパティ内の [属性エディター] タブにて、adminCount の 1 の値を手動で クリアします。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/10_property.png"></p><p>そして、[セキュリティ] タブの [詳細設定] にて、「継承の有効化」をおこなってください。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/11_inheritance.png"></p><p>継承が有効化されますと、ルート ディレクトリのアクセス許可が継承されますので、 “AD DS コネクタ アカウント” に対してパスワード リセットのアクセス許可が付与されます。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/12_check.png"></p><p>(補足）<br>保護されたグループに所属しているメンバーでもパスワード変更は可能です。パスワード変更とは、自分のアカウントでサインインした後に、マイアカウントのページから変更をおこなう下記の操作のことです。</p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/13_change-step1.png"></p><p><img src="/jpazureid-test/azure-active-directory-connect/password-writeback-overview/14_change-step2.png"></p><h4 id="7-Azure-AD-Connect-構成ウィザードでパスワード-ライトバックを有効化できない"><a href="#7-Azure-AD-Connect-構成ウィザードでパスワード-ライトバックを有効化できない" class="headerlink" title="7. Azure AD Connect 構成ウィザードでパスワード ライトバックを有効化できない"></a>7. Azure AD Connect 構成ウィザードでパスワード ライトバックを有効化できない</h4><p>[エラー内容]<br>構成ウィザードでパスワード ライトバックの構成中に下記のエラー メッセージが表示される場合があります。</p><p>エラーメッセージ：<br><strong>パスワードの書き戻しを構成できません。 必要なライセンスを持っていることを確認します。</strong><br>Unable to configure password writeback. Ensure you have the required license and consult the event log for addition information.</p><p>[原因と対処方法]<br>このエラーメッセージは「前提条件の (5) 」のエンドポイントに接続できない場合に発生します。<br>オンプレミスでプロキシ サーバーをご利用されている場合に、Azure AD Connect が machine.config のプロキシ設定を正しく読み込めていないため、外部エンドポイントへの通信がプロキシを経由できず、オンプレミスのファイアウォール等でブロックされている可能性があります。</p><p>外部エンドポイントへの接続がプロキシを経由できていない場合は、machine.config にプロキシの設定を追加した後、一度 Azure AD Connect サーバーを再起動してください。<br>その後、構成ウィザードでパスワード ライトバックを有効にしますと、オンプレミスのファイアウォール等でブロックされることなくエンドポイントへ接続できるようになりエラーが解消されます。</p><p>もし何かエラーが生じて原因がわからないなどお困り事がありましたら、お気軽にテクニカル サポートへお問い合わせください。<br>上記の情報が少しでも皆様のお役に立ちましたら幸いです。</p><h3 id="参考文献やリンクなど"><a href="#参考文献やリンクなど" class="headerlink" title="参考文献やリンクなど"></a>参考文献やリンクなど</h3><p>前提条件<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-sspr-writeback#prerequisites">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-sspr-writeback#prerequisites</a></p><p>Azure AD Connect に使用されるアカウント<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/reference-connect-accounts-permissions#accounts-used-for-azure-ad-connect">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/reference-connect-accounts-permissions#accounts-used-for-azure-ad-connect</a></p><p>Azure AD Connect に対するアカウントのアクセス許可を構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-sspr-writeback#configure-account-permissions-for-azure-ad-connect">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-enable-sspr-writeback#configure-account-permissions-for-azure-ad-connect</a></p><p>Confirm network connectivity<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/troubleshoot-sspr-writeback#confirm-network-connectivity">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/troubleshoot-sspr-writeback#confirm-network-connectivity</a></p><p>エディションと機能の比較<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-licensing#compare-editions-and-features">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-licensing#compare-editions-and-features</a></p><p>パスワード ライトバックのしくみ<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-writeback#how-password-writeback-works">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-writeback#how-password-writeback-works</a></p><p>Password writeback event log error codes<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/troubleshoot-sspr-writeback#password-writeback-event-log-error-codes">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/troubleshoot-sspr-writeback#password-writeback-event-log-error-codes</a></p><p>カスタムの禁止パスワードを構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-configure-custom-password-protection#configure-custom-banned-passwords">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/tutorial-configure-custom-password-protection#configure-custom-banned-passwords</a></p><p>パスワード ライトバックのアクセス許可<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-configure-ad-ds-connector-account#permissions-for-password-writeback">https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-configure-ad-ds-connector-account#permissions-for-password-writeback</a></p><p>付録 c: 保護されたアカウントと Active Directory のグループ<br><a href="https://docs.microsoft.com/ja-jp/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory">https://docs.microsoft.com/ja-jp/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory</a></p><p>Azure AD Connect ウィザードを実行すると、エラーが発生する: パスワードの書き戻しを構成できません<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/active-directory/unable-configure-pwd-writeback-error">https://docs.microsoft.com/ja-jp/troubleshoot/azure/active-directory/unable-configure-pwd-writeback-error</a></p><p>パスワードの書き戻し (FAQ)<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/active-directory-passwords-faq#password-writeback">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/active-directory-passwords-faq#password-writeback</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの金子です。&lt;br&gt;今回はパスワード ライトバックのしくみと一般的なトラブルシューティングについてご紹介します。&lt;/p&gt;
&lt;h2 id=&quot;パスワード-ハッシュ同期とパスワード-ライトバックの違いとは&quot;&gt;&lt;</summary>
      
    
    
    
    
    <category term="Azure AD Connect" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD-Connect/"/>
    
    <category term="Password Writeback" scheme="https://georgioush.github.io/jpazureid-test/tags/Password-Writeback/"/>
    
    <category term="Self Service Password Reset" scheme="https://georgioush.github.io/jpazureid-test/tags/Self-Service-Password-Reset/"/>
    
  </entry>
  
  <entry>
    <title>MFA 認証方法を、変更 / 再登録 / 追加 したい！</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/change-mfa-verification-method/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/change-mfa-verification-method/</id>
    <published>2020-10-09T03:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.813Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity サポート チームの栗井です。</p><p>弊社サポートチームでは、 Azure Active Directory に関して、以下のようなご要望に関するお問い合わせをよくいただきます。</p><ul><li>スマートフォンを買い替えたので、MFA 認証方法を変更したい。</li><li>スマートフォンを紛失したので、MFA 認証方法を再登録したい。</li><li>社用のスマートフォンに加えて、私用スマートフォンを、MFA 認証方法として追加したい。</li></ul><p>このブログでは、こういったご要望に答えるために、MFA 認証方法の変更 / 再登録 / 追加 するための方法と手順を、ご紹介いたします。</p><p><strong>読者のターゲット :</strong> テナントの管理者。組織内のユーザーが、MFA 認証方法の変更 / 再登録 / 追加 が必要となった際に、ご参考になれば幸いです。</p><p>操作の手順は、以下の場合ごとに異なるため、それぞれ別項目でご説明します。</p><ul><li>現在登録されているモバイル デバイスで、MFA 認証ができる場合 (モバイル デバイスの買い替え、追加など)</li><li>現在登録されているモバイル デバイスで、MFA 認証ができない場合 (モバイル デバイスの紛失、故障など)</li></ul><h2 id="現在登録されているモバイル-デバイスで、MFA-認証ができる場合"><a href="#現在登録されているモバイル-デバイスで、MFA-認証ができる場合" class="headerlink" title="現在登録されているモバイル デバイスで、MFA 認証ができる場合"></a>現在登録されているモバイル デバイスで、MFA 認証ができる場合</h2><p>この場合、MFA 認証方法の変更 / 追加は、ユーザー自身の操作のみで行うことができます。ユーザーには以下の方法で、MFA 認証方法の変更 / 追加を行ってもらってください。</p><h3 id="MFA-認証方法の変更-追加手順"><a href="#MFA-認証方法の変更-追加手順" class="headerlink" title="MFA 認証方法の変更 / 追加手順"></a>MFA 認証方法の変更 / 追加手順</h3><p>ユーザーに、任意のデバイス (※) で <a href="https://aka.ms/mfasetup">https://aka.ms/mfasetup</a> にアクセスしてもらいます。</p><p>(※作業の途中で、新しいモバイル デバイスのカメラで読みこむための、QR コードが表示されます。PC やタブレットなど、新しいモバイル デバイス以外の端末にしましょう。)</p><p>サインインと MFA が要求されます。それぞれ認証を行いましょう。</p><p>この先は、2 パターンに分かれます。</p><h4 id="パターン-1-以下の画面が出てきた場合-URL-https-mysignins-microsoft-com-security-info"><a href="#パターン-1-以下の画面が出てきた場合-URL-https-mysignins-microsoft-com-security-info" class="headerlink" title="パターン 1 : 以下の画面が出てきた場合 (URL : https://mysignins.microsoft.com/security-info)"></a>パターン 1 : 以下の画面が出てきた場合 (URL : <a href="https://mysignins.microsoft.com/security-info">https://mysignins.microsoft.com/security-info</a>)</h4><p><img src="/jpazureid-test/azure-active-directory/change-mfa-verification-method/figure1.png"></p><p>[+ 方法の追加] を選択してください。画面の表示に従って、新しいモバイル デバイスを、MFA 認証方法として登録しましょう。</p><h4 id="パターン-2-以下の画面が出てきた場合-URL-https-account-activedirectory-windowsazure-com-proofup-aspx"><a href="#パターン-2-以下の画面が出てきた場合-URL-https-account-activedirectory-windowsazure-com-proofup-aspx" class="headerlink" title="パターン 2 : 以下の画面が出てきた場合 (URL : https://account.activedirectory.windowsazure.com/proofup.aspx)"></a>パターン 2 : 以下の画面が出てきた場合 (URL : <a href="https://account.activedirectory.windowsazure.com/proofup.aspx">https://account.activedirectory.windowsazure.com/proofup.aspx</a>)</h4><p><img src="/jpazureid-test/azure-active-directory/change-mfa-verification-method/figure2.png"></p><p>SMS もしくは 音声通話認証の場合 : [認証用電話] の番号を変更し、保存してください。<br>Microsoft Authenticator をご利用の場合 :  [Authenticator アプリの設定] を選択し、画面の指示に従ってください。</p><p>いずれの画面も、登録済みの MFA 認証方法を一覧で確認できます。<br>もし、「既存のデバイスでは、もう MFA 認証を行わない！」と決まっている場合、一覧から削除してしまいましょう。</p><p>※ 複数端末を MFA 認証方法として登録する場合 : 認証方法としては、SMS / 電話は 1 つの電話番号のみ、Microsoft Authenticator は複数の端末が登録可能です。複数モバイル デバイスによる MFA 認証を行いたい場合は、Microsoft Authenticator をご利用ください。</p><h2 id="現在登録されているモバイル-デバイスで、MFA-認証ができない場合"><a href="#現在登録されているモバイル-デバイスで、MFA-認証ができない場合" class="headerlink" title="現在登録されているモバイル デバイスで、MFA 認証ができない場合"></a>現在登録されているモバイル デバイスで、MFA 認証ができない場合</h2><p>この場合、以下のいずれかの方法によって、管理者がユーザーの MFA 認証方法をリセット / 変更ください。</p><p>【 1 】管理者による MFA 認証方法のリセット</p><p>【 2 】管理者が直接 MFA 認証用電話番号を指定 (プレビュー機能)</p><h3 id="【-1-】管理者によるMFA-認証方法のリセット"><a href="#【-1-】管理者によるMFA-認証方法のリセット" class="headerlink" title="【 1 】管理者によるMFA 認証方法のリセット"></a>【 1 】管理者によるMFA 認証方法のリセット</h3><p>管理者によって現在の MFA 認証方法をリセットした上で、ユーザーが再登録を行う方法です。 <br><br>現在の MFA 認証方法をリセットすることができるのは、テナント管理者 (グローバル管理者ロール) です。リセットする対象が管理者ユーザー以外であれば、ユーザー管理者、特権認証管理者、認証管理者のロールを持つアカウントでも行うことができます。</p><p>(A) <a href="https://portal.azure.com/">Azure Portal</a> からリセット</p><p>(B) <a href="https://account.activedirectory.windowsazure.com/usermanagement/multifactorverification.aspx">Azure MFA Portal</a> からリセット※ この方法は、テナント管理者 (グローバル管理者ロール) のみ実行可能です。</p><p>(C) PowerShell からリセット</p><ul><li><p>(A) の方法は、以下の公開情報にてご紹介しております。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-userdevicesettings#manage-user-authentication-options">Azure Multi-factor Authentication のユーザー設定の管理 - ユーザー認証オプションを管理する</a></p></li><li><p>(B) と (C) の方法は、以下のブログにてご紹介しております。 </p><p><a href="https://jpazureid.github.io/blog/azure-active-directory/mfa-reset/">多要素認証 (MFA) のリセット手順</a> </p></li></ul><p>管理者によって、ユーザーの MFA 認証方法がリセットされたら、ユーザーは MFA 認証方法を再登録する必要があります。<br>前述の、現在登録されているモバイル デバイスで、MFA 認証ができる場合の手順に従って、新しいデバイスを MFA 認証方法として登録して下さい。</p><h3 id="【-2-】管理者が直接-MFA-認証用電話番号を指定-プレビュー機能"><a href="#【-2-】管理者が直接-MFA-認証用電話番号を指定-プレビュー機能" class="headerlink" title="【 2 】管理者が直接 MFA 認証用電話番号を指定 (プレビュー機能)"></a>【 2 】管理者が直接 MFA 認証用電話番号を指定 (プレビュー機能)</h3><p>こちらは現在、プレビュー機能として公開されている方法です。</p><p>Azure Portal 上で、管理者はユーザーの MFA 認証のための電話番号を、直接指定することができます。</p><p><a href="portal.azure.com">Azure ポータル</a> &gt; [Azure Active Directory] &gt; [ユーザー] &gt; (一覧からユーザーを選択) &gt; [認証方法]</p><p>「新しいユーザー認証方法エクスペリエンスをお試しください。こちらをクリックすると、プレビューを使用できます。」というメッセージを選択すると、以下のプレビュー版の機能が、ご利用可能になります。</p><p>[ + 認証方法の追加] から、[電話番号] を選択し、ユーザーのモバイル デバイスの電話番号を追加して下さい。</p><p><img src="/jpazureid-test/azure-active-directory/change-mfa-verification-method/figure3.png"></p><p>※ [方法の選択] で選択可能な [メール] は、MFA ではなく セルフサービス パスワード リセットの連絡先追加のための項目です。ここでは選択しないでください。</p><p><img src="/jpazureid-test/azure-active-directory/change-mfa-verification-method/figure4.png"></p><p>次回からは、指定した電話番号に MFA の要求が届くようになります。</p><h2 id="例外-テナント管理者の-MFA-認証方法をリセットする必要がある場合"><a href="#例外-テナント管理者の-MFA-認証方法をリセットする必要がある場合" class="headerlink" title="例外 : テナント管理者の MFA 認証方法をリセットする必要がある場合"></a>例外 : テナント管理者の MFA 認証方法をリセットする必要がある場合</h2><p>MFA 認証方法の再登録には、テナントの管理者による、MFA 認証方法のリセットが必要です。</p><p>ただし、テナントの管理者自身のモバイル デバイスの紛失 / 故障などにより、MFA 認証方法の再登録したい場合、上記の手順を進めることができない場合がございます。</p><p>「Azure Portal、Azure MFA Portal のいずれにも、MFA が必要な設定をしているので、アクセスすることができない！」といった場合です。</p><p>このようなときの、対処法をご案内いたします。</p><h3 id="I-テナントに管理者が複数存在する場合"><a href="#I-テナントに管理者が複数存在する場合" class="headerlink" title="I. テナントに管理者が複数存在する場合"></a>I. テナントに管理者が複数存在する場合</h3><p>MFA 認証方法を再登録する必要がある管理者以外に、別の管理者が存在する場合は、その管理者によって、前述の [管理者による MFA 認証方法のリセット方法] を行ってください。</p><p>その後、MFA 認証方法を再登録する必要がある管理者によって、前述の [MFA 認証方法の変更 / 追加手順] の手順を行ってください。</p><h3 id="II-Azure-のサブスクリプションを-クラウド-ソリューション-プロバイダー-パートナー-CSP-パートナー-からご購入頂いている場合"><a href="#II-Azure-のサブスクリプションを-クラウド-ソリューション-プロバイダー-パートナー-CSP-パートナー-からご購入頂いている場合" class="headerlink" title="II. Azure のサブスクリプションを クラウド ソリューション プロバイダー パートナー (CSP パートナー) からご購入頂いている場合"></a>II. Azure のサブスクリプションを クラウド ソリューション プロバイダー パートナー (CSP パートナー) からご購入頂いている場合</h3><p>CSP パートナーのアカウントは、お客様のテナントにアクセスする権限を持っています。</p><p>CSP パートナーに連絡を取り、お客様のテナントにアクセスができる CSP アカウントによって、前述の [管理者による MFA 認証方法のリセット方法] を行ってもらいましょう。</p><p>その後、MFA 認証方法を再登録する必要がある管理者によって、前述の [MFA 認証方法の変更 / 追加手順] を行ってください。</p><h3 id="III-I-と-II-のいずれにも当てはまらない場合"><a href="#III-I-と-II-のいずれにも当てはまらない場合" class="headerlink" title="III. I と II のいずれにも当てはまらない場合"></a>III. I と II のいずれにも当てはまらない場合</h3><p>これは、これまでご紹介した方法がいずれも実行不可能場合のみに行っていただく、最終手段です。</p><p>テナントのすべての全体管理者がサインイン不可能になった場合には、弊社データセンター側で、管理者の MFA を、一時的に解除させていただきます。</p><p>その間に管理者自身の MFA の再セットアップ (前述の [MFA 認証方法の変更 / 追加手順] の手順) を、行っていただく必要があります。</p><p>解除には、数営業日いただくことになりますので予めご留意ください。</p><p>この場合、弊社サポート チームまでお問い合わせください。必要な手順をご案内いたします。</p><p>お問い合わせ時には下記の情報を予めお知らせください。</p><ul><li>テナント名 (~.onmicrosoft.com) またはテナント ID</li><li>全体管理者の UPN</li><li>状況 (何かしら操作をした日時、操作内容など)</li></ul><p>Azure Portal にログインできない場合は、<a href="https://aka.ms/AzurePortalHelp">https://aka.ms/AzurePortalHelp</a> からリクエストをご起票ください。</p><h2 id="参考文献やリンクなど"><a href="#参考文献やリンクなど" class="headerlink" title="参考文献やリンクなど"></a>参考文献やリンクなど</h2><p>本記事に関連する公開情報、サポート ブログ、サービスの URL をご紹介いたします。ご参考になれば幸いです。</p><h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul><li><p>公開情報「Azure Multi-factor Authentication のユーザー設定の管理」: <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-userdevicesettings">https://docs.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-userdevicesettings</a></p></li><li><p>公開情報　「追加の確認方法を変更する」: <a href="https://support.microsoft.com/ja-jp/office/%e8%bf%bd%e5%8a%a0%e3%81%ae%e7%a2%ba%e8%aa%8d%e6%96%b9%e6%b3%95%e3%82%92%e5%a4%89%e6%9b%b4%e3%81%99%e3%82%8b-956ec8d0-7081-4518-a701-f8414cc20831?ui=ja-JP&amp;rs=ja-JP&amp;ad=JP">https://support.microsoft.com/ja-jp/office/%e8%bf%bd%e5%8a%a0%e3%81%ae%e7%a2%ba%e8%aa%8d%e6%96%b9%e6%b3%95%e3%82%92%e5%a4%89%e6%9b%b4%e3%81%99%e3%82%8b-956ec8d0-7081-4518-a701-f8414cc20831?ui=ja-JP&amp;rs=ja-JP&amp;ad=JP</a></p></li><li><p>サポート ブログ 「多要素認証 (MFA) のリセット手順」: <a href="https://jpazureid.github.io/blog/azure-active-directory/mfa-reset/">https://jpazureid.github.io/blog/azure-active-directory/mfa-reset/</a></p></li></ul><h3 id="サービスの-URL"><a href="#サービスの-URL" class="headerlink" title="サービスの URL"></a>サービスの URL</h3><ul><li>Azure ポータル : <a href="https://portal.azure.com/">https://portal.azure.com/</a></li><li>Azure ポータル (プレビュー版) : <a href="https://preview.portal.azure.com/">https://preview.portal.azure.com/</a></li><li>Azure MFA Portal (管理者専用) : <a href="https://account.activedirectory.windowsazure.com/usermanagement/multifactorverification.aspx">https://account.activedirectory.windowsazure.com/usermanagement/multifactorverification.aspx</a></li><li>MFA 認証情報確認 / 登録ページ : <a href="https://aka.ms/mfasetup">https://aka.ms/mfasetup</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity サポート チームの栗井です。&lt;/p&gt;
&lt;p&gt;弊社サポートチームでは、 Azure Active Directory に関して、以下のようなご要望に関するお問い合わせをよくいただきます。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;スマートフォンを買い</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="MFA" scheme="https://georgioush.github.io/jpazureid-test/tags/MFA/"/>
    
  </entry>
  
  <entry>
    <title>9/28 (日本語抄訳) RCA – 複数の Microsoft サービスおよび Azure Active Directory と連携したアプリケーションでの認証エラー (Tracking ID SM79-F88)</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/20200928-rca-azure-ad/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/20200928-rca-azure-ad/</id>
    <published>2020-10-01T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.761Z</updated>
    
    <content type="html"><![CDATA[<p>いつも Azure Identity サポート チームのブログを参照いただきましてありがとうございます。</p><p>今回は 9/28 に発生しました Azure Active Directory の障害について、RCA (Root Cause Analysis) レポートの日本語版の抄訳を紹介します。原文は <a href="https://azure.microsoft.com/ja-jp/status/history/">状態の履歴および根本原因分析 (RCA)</a> を確認ください。</p><p>日本語版の抄訳の PDF については、以下のリンクよりダウンロード頂けます。</p><p><a href="/jpazureid-test/azure-active-directory/20200928-rca-azure-ad/SM79-F88_JP.pdf">SM79-F88_JP.pdf</a></p><p>この障害では Azure / Office 365 ポータルへのサインインができないことをはじめ、障害の対象となりましたテナントで多大な影響が生じました。改めて、今回の障害により多くのお客様にご迷惑をお掛けしましたことを深くお詫び申し上げます。</p><h2 id="9-28-RCA-–-複数の-Microsoft-サービスおよび-Azure-Active-Directory-と連携したアプリケーションでの認証エラー-Tracking-ID-SM79-F88"><a href="#9-28-RCA-–-複数の-Microsoft-サービスおよび-Azure-Active-Directory-と連携したアプリケーションでの認証エラー-Tracking-ID-SM79-F88" class="headerlink" title="9/28 RCA – 複数の Microsoft サービスおよび Azure Active Directory と連携したアプリケーションでの認証エラー (Tracking ID SM79-F88)"></a>9/28 RCA – 複数の Microsoft サービスおよび Azure Active Directory と連携したアプリケーションでの認証エラー (Tracking ID SM79-F88)</h2><h3 id="影響の概要"><a href="#影響の概要" class="headerlink" title="影響の概要"></a>影響の概要</h3><p>2020 年 9 月 28 日の 21:25 UTC (日本時間 9 月 29 日 AM 6:25) から 2020 年 9 月 29 日の 00:23 UTC (日本時間 9 月 29 日 AM 9:23) の間で Azure Active Directory (Azure AD) を認証基盤として利用するすべての Microsoft およびサードパーティのアプリケーション、サービスの認証処理でエラーが生じた可能性があります。Azure AD B2C を使用して認証を行うアプリケーションも影響を受けました。</p><p>事象発生時点で Azure AD を利用したクラウド サービスで認証済みでなかったユーザーは、問題の影響を受けた可能性がより高く、平均して以下に示すような可用性の値で複数の認証リクエストが失敗していた可能性があります。これらの値は、さまざまな顧客とワークロードの情報を元に集計されました。</p><ul><li>ヨーロッパ: 事象発生期間中の成功率 81 ％。</li><li>アメリカ: 事象発生期間中の成功率は 17 %、緩和直前には 37 % に改善。</li><li>アジア: 事象発生期間中の最初の 120 分間の成功率は 72 %。業務時間のピークが始まるころの可用性は最低で 32 % に低下。 </li><li>オーストラリア: 事象発生期間中の成功率は 37 %。</li></ul><p>2020 年 9 月 29 日 00:23 UTC (日本時間 9 月 29 日 AM 9:23) までに、大多数のお客様のサービスは通常の運用可能な状態に復旧しましたが、その後も認証リクエストの失敗が散発的に発生しており、02:25 UTC (日本時間 AM 11:25) まで影響が生じていた可能性があります。  </p><p>事象開始時刻前に認証を行っていたユーザーは、アクセスしているアプリケーションやサービスに依存しますが、この問題による影響を受けた可能性は低い状態でした。</p><p>仮想マシン、仮想マシンのスケールセット、および Azure Kubernetes サービスのマネージド アイデンティティ サービスには回復機能が備えられており、事象発生期間中にも平均 99.8 % の可用性を保ちました。</p><h3 id="根本原因"><a href="#根本原因" class="headerlink" title="根本原因:"></a>根本原因:</h3><p>9 月 28 日 21:25 UTC (日本時間 9 月 29 日 AM 6:25) に、内部の検証テスト リングを対象としたサービス アップデートが展開され、その結果、Azure AD のバックエンド サービスの起動時にクラッシュが発生しました。Azure AD バックエンド サービスのセーフ デプロイ プロセス (SDP) システムの潜在的なコード欠陥により、通常の検証プロセスを介さず本番環境にサービス アップデートが直接展開されました。</p><p>Azure AD は、世界中の複数のデータセンターにまたがる複数のパーティションを持つアクティブ・アクティブ構成で展開された地理的に分散したサービスであり、隔離境界を持ちます。通常、変更は最初に顧客データを含まない検証リングを対象にし、次に Microsoft のみのユーザーを含む内部リング、最後に本番環境を対象に展開されます。これらの変更は、数日かけて 5 つのリングに渡って段階的に展開されます。</p><p>今回のケースでは、潜在的な不具合により展開に使用するメタデータがシステムにより正しく認識されず、SDP システムが正しく検証テスト リングを展開先として設定できませんでした。その結果、すべてのリングが同時に展開先になりました。この不適切な展開により、サービスの可用性が低下しました。</p><p>影響が発生してから数分以内に、自動ロールバック システム (通常であれば影響度と影響の発生時間が限定されることが期待される) を使用して変更を元に戻す処置を行いました。しかし、SDP システムの潜在的な欠陥が展開メタデータを破損させていたため、手動のロールバック プロセスに頼らざるを得ず、問題を緩和するまでに大幅に時間を要する結果となりました。</p><h3 id="緩和策"><a href="#緩和策" class="headerlink" title="緩和策"></a>緩和策</h3><p>監視により、影響が発生してから数分以内にサービスの劣化を検知し、直ちにトラブルシューティングを開始しました。以下の対応を実施しました。</p><ul><li>問題は UTC 21:25 (日本時間 9 月 29 日 AM 6:25) に始まり、 5 分以内に監視システムで不健全な状態が検出され、直ちにエンジニアによる調査が開始されました。</li><li>その後 30 分間、問題のトラブルシューティングと並行して、顧客への影響を最小限に抑えるとともに問題回避を迅速化するための一連の手順が実施されました。これには、問題が緩和された後に予想される負荷を処理するために、Azure AD サービスの一部をスケールアウトし、バックアップの Azure AD 認証システムに特定のワークロードをフェイルオーバーしたことも含まれます。</li><li>22:02 UTC (日本時間 9 月 29 日 AM 7:02) に、根本原因を特定し、修復を開始し、自動ロールバック メカニズムを開始しました。</li><li>SDP メタデータの破損が原因で自動ロールバックに失敗しました。22:47 UTC (日本時間 AM 7:47) に、SDP システムを利用せずにサービス構成を手動で更新するプロセスを開始し、23:59 UTC (日本時間 AM 8:59) までにすべての操作が完了しました。</li><li>UTC 00:23 (日本時間 AM 9:23) までに、十分な数のバックエンドのサービス インスタンスが正常な状態に戻り、通常のサービス運用状態に回復しました。</li><li>いくつか残存する影響が生じていたすべてのサービス インスタンスは、02:25 UTC (日本時間 AM 11:25) までに復旧しました。</li></ul><h3 id="次のステップ"><a href="#次のステップ" class="headerlink" title="次のステップ:"></a>次のステップ:</h3><p>今回の影響を受けましたお客様に深くお詫び申し上げます。このようなインシデントが将来的に発生しないよう、Microsoft Azure プラットフォームと当社のプロセスを改善するための措置を継続的に講じています。今回のケースでは、対応策として以下が含まれます (ただし、これらに限定されません)。</p><p>以下は既に完了済みの内容となります。</p><ul><li>Azure AD バックエンド SDP システムの潜在的なコードの欠陥の修正。</li><li>破損から保護するために、最後の動作確認済み (last known-good) メタデータを復元できるように既存のロールバック システムを修正。</li><li>ロールバック操作の訓練の範囲と頻度を拡大。</li></ul><p>残りのステップは以下のとおりです。</p><ul><li>今回特定された類似の問題を防ぐために、Azure AD サービスのバックエンド SDP システムに追加の保護機能を適用。</li><li>将来的に同様の問題が発生した場合の影響を大幅に軽減するため最優先事項として、すべての主要サービスへの Azure AD バックアップ認証システムの展開を早急に実施。</li><li>問題が生じてから 15 分以内に影響を受けた顧客に一報する Azure の顧客通知の仕組みに Azure AD に対応したシナリオを追加。</li></ul><h3 id="フィードバックのお願い"><a href="#フィードバックのお願い" class="headerlink" title="フィードバックのお願い:"></a>フィードバックのお願い:</h3><p>Azure カスタマー・コミュニケーション・エクスペリエンスの向上のためのアンケートにご協力ください: <a href="https://aka.ms/AzurePIRSurvey">https://aka.ms/AzurePIRSurvey</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;いつも Azure Identity サポート チームのブログを参照いただきましてありがとうございます。&lt;/p&gt;
&lt;p&gt;今回は 9/28 に発生しました Azure Active Directory の障害について、RCA (Root Cause Analysis) レポー</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>最終サインイン日時を一括で取得する方法</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory/azure-ad-get-lastSignInDateTime/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory/azure-ad-get-lastSignInDateTime/</id>
    <published>2020-09-29T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.787Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの谷です。</p><p>以前の記事 <a href="https://github.com/jpazureid/get-last-signin-reports">Get last-sign-in activity reports</a> でユーザーの最終サインイン日時の取得をご紹介させていただきましたが、下記の制約がありました。</p><ul><li>サインイン ログの保存期間により、30 日以上前のサインイン日時は確認できません。  </li><li>サインインのログから一覧を取得しているため、厳密な ”最終アクセス日時” とは異なります。  </li></ul><p>新たに Microsoft Graph API の lastSignInDateTime プロパティを取得することで、上述の制約を解消し、実際に Azure AD に長期間サインインを行っていないユーザーを取得することが可能となりました。</p><p> Azure AD で非アクティブなユーザー アカウントを管理する<br> <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/reports-monitoring/howto-manage-inactive-user-accounts">https://docs.microsoft.com/ja-jp/azure/active-directory/reports-monitoring/howto-manage-inactive-user-accounts</a>  </p><p>上記 Beta API を利用し、組織内のユーザーとその最終サインイン日時、最後に利用したクラウド アプリケーションを一覧で CSV 形式ファイルで取得するまでを GitHub にサンプルとしてお纏めしました。  </p><p>具体的な設定手順も README.md に記載しておりますので、以下のページをご確認くださいませ。</p><ul><li><a href="https://github.com/jpazureid/get-last-signin-reports/tree/beta">Get last-sign-in activity reports (beta API 利用)</a></li></ul><p>なお、前述の制限がある従来のサンプルも、新たに設定手順をスクリーンショット付きで記載しておりますので、こちらもぜひご確認くださいませ。</p><ul><li><a href="https://github.com/jpazureid/get-last-signin-reports/tree/master">Get last-sign-in activity reports (v1.0 API 利用)</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの谷です。&lt;/p&gt;
&lt;p&gt;以前の記事 &lt;a href=&quot;https://github.com/jpazureid/get-last-signin-reports&quot;&gt;Get last-sign-in activity </summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://georgioush.github.io/jpazureid-test/tags/Azure-AD/"/>
    
    <category term="signin log" scheme="https://georgioush.github.io/jpazureid-test/tags/signin-log/"/>
    
    <category term="ログ取得" scheme="https://georgioush.github.io/jpazureid-test/tags/%E3%83%AD%E3%82%B0%E5%8F%96%E5%BE%97/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD Connect Sync Configuration Documenter 使用方法</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory-connect/azure-ad-connect-AADConnectConfigDocumenter/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory-connect/azure-ad-connect-AADConnectConfigDocumenter/</id>
    <published>2020-09-29T10:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.618Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの谷です。<br>Azure AD Connect Sync Configuration Documenter 使用方法をご案内します。<br><a href="/blog/master/README/">Readme</a> に記載の手順となります。<br>Azure AD Connect サーバーの移行やアップグレードに際し、設定変更内容や差分内容を確認する場合に参考にしてください。  </p><h2 id="Azure-AD-Connect-Sync-Configuration-Documenter-とは"><a href="#Azure-AD-Connect-Sync-Configuration-Documenter-とは" class="headerlink" title="Azure AD Connect Sync Configuration Documenter とは"></a>Azure AD Connect Sync Configuration Documenter とは</h2><p>Azure AD Connect の設定内容や同期ルールを比較するためのツールです。<br>各 Azure AD Connect にて設定情報をエクスポートし、HTML レポート ファイルで比較情報を取得することができます。  </p><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ol><li><p>比較情報を確認するサーバーにて <a href="https://github.com/Microsoft/AADConnectConfigDocumenter/releases">Azure AD Connect Configuration Documenter</a> をダウンロードします。<br>ページ内の AzureADConnectSyncDocumenter.zip をクリックしてダウンロードします。  </p></li><li><p>ダウンロードした AzureADConnectSyncDocumenter.zip を任意のディレクトリに展開します。</p></li><li><p>展開した AzureADConnectSyncDocumenter フォルダー配下の Data フォルダーに各サーバー用のフォルダーを作成します。<br>　 例) C:\temp\AzureADConnectSyncDocumenter\Data\AADCServer001 , C:\temp\AzureADConnectSyncDocumenter\Data\AADCServer002  </p></li><li><p>各 Azure AD Connect サーバーにて設定ファイルを取得します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-ADSyncServerConfiguration</span> <span class="literal">-Path</span> <span class="string">&quot;出力先へのパス&quot;</span></span><br></pre></td></tr></table></figure><p>(実行例)  </p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-ADSyncServerConfiguration</span> <span class="literal">-Path</span> <span class="string">&quot;C:\temp\AADC001&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>手順 4. で出力した下記のフォルダーを 3. で作成したフォルダーにサーバー毎にコピーします。<br>  Connectors<br>  GlobalSettings<br>  SynchronizationRules  </p></li><li><p>手順 2. で展開したフォルダー内の AzureADConnectSyncDocumenter-contoso.cmd をテキスト エディターで開きます。</p></li><li><p>下記箇所を手順 3. で作成したフォルダー名に合わせて、保存します。<br>AzureADConnectSyncDocumenterCmd.exe “Contoso\Pilot” “Contoso\Production”<br>例) AzureADConnectSyncDocumenterCmd.exe “AADCServer001” “AADCServer002”  </p></li><li><p>AzureADConnectSyncDocumenter-contoso.cmd のファイル名を AzureADConnectSyncDocumenter.cmd に変更します。  </p></li><li><p>下記コマンドを実行します。</p></li></ol><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">.\AzureADConnectSyncDocumenter.cmd</span><br></pre></td></tr></table></figure><ol start="10"><li>コマンド実行後に AzureADConnectSyncDocumenter\Report 配下に HTML ファイルが生成されます。</li><li>レポート内の Create / Update / Delete 項目で差分内容を確認します。<br>下記の “Only Show Changes” チェックを有効にすることで差分のみ表示可能となります。<br><img src="/jpazureid-test/azure-active-directory-connect/azure-ad-connect-AADConnectConfigDocumenter/AzureADConnectSyncDocumenter01.jpg"></li></ol><h2 id="差分内容につきまして"><a href="#差分内容につきまして" class="headerlink" title="差分内容につきまして"></a>差分内容につきまして</h2><p>Azure AD Connect のアップグレードでは既定の設定項目などが増えており、差分が生じる可能性があります。<br>各バージョンでの更新内容は <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/reference-connect-version-history">こちら</a> をご参照ください。  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの谷です。&lt;br&gt;Azure AD Connect Sync Configuration Documenter 使用方法をご案内します。&lt;br&gt;&lt;a href=&quot;/blog/master/README/&quot;&gt;Readm</summary>
      
    
    
    
    
    <category term="AAD Connect" scheme="https://georgioush.github.io/jpazureid-test/tags/AAD-Connect/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD Connect に関する FAQ</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory-connect/azureadconnect_faq/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory-connect/azureadconnect_faq/</id>
    <published>2020-09-24T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.630Z</updated>
    
    <content type="html"><![CDATA[<p> <br>Azure AD Connect (AADC) のお問い合わせが多いご質問について、Q&amp;A 形式でおまとめいたしました。<br>既存のドキュメントではカバーされていない動作や質問について今後も適宜内容を拡充していきますので、ご参照いただければと思います。  </p><h2 id="Q-AADC-の-Active-Stand-By-アクティブ-スタンバイ-の構成が行えるか？"><a href="#Q-AADC-の-Active-Stand-By-アクティブ-スタンバイ-の構成が行えるか？" class="headerlink" title="Q. AADC の Active / Stand By (アクティブ / スタンバイ) の構成が行えるか？"></a><strong>Q. AADC の Active / Stand By (アクティブ / スタンバイ) の構成が行えるか？</strong></h2><p><strong>A.</strong> いいえ。AADC はクラスター構成を実装していません。<br>AADC を同一フォレスト内で 2 台以上構成した場合でも各 AADC で死活監視を行う実装はありません。<br>冗長構成をご検討の場合はステージング モード機能をご利用ください。<br>詳細は<a href="/blog/azure-active-directory-connect/introduction-staging-server/">こちら</a> をご参照ください。  </p><h2 id="Q-AADC-をインストールする際のネットワーク要件は"><a href="#Q-AADC-をインストールする際のネットワーク要件は" class="headerlink" title="Q. AADC をインストールする際のネットワーク要件は?"></a><strong>Q. AADC をインストールする際のネットワーク要件は?</strong></h2><p><strong>A.</strong> <a href="/blog/azure-active-directory-connect/port-used-by-aadc/">Azure AD Connect サーバー - ウィルス対策ソフト除外項目 / 使用する通信ポート</a> をご参照ください。  </p><p>  </p><h2 id="Q-AADC-のバックアップ-リストア方法はありますか？"><a href="#Q-AADC-のバックアップ-リストア方法はありますか？" class="headerlink" title="Q. AADC のバックアップ / リストア方法はありますか？"></a><strong>Q. AADC のバックアップ / リストア方法はありますか？</strong></h2><p><strong>A.</strong> いいえ。AADC の構成情報については GUI 画面上から確認し、その情報を保存する方法のみとなります。1.5.4x.0 以降では異なるため、詳細は下記をご参照ください。<br> Azure AD Connect 設定の Export / Import<br> <a href="https://jpazureid.github.io/blog/azure-active-directory-connect/aadc-import-export-config/">https://jpazureid.github.io/blog/azure-active-directory-connect/aadc-import-export-config/</a></p><h2 id="Q-AADC-のダウングレードはできますか？"><a href="#Q-AADC-のダウングレードはできますか？" class="headerlink" title="Q. AADC のダウングレードはできますか？"></a><strong>Q. AADC のダウングレードはできますか？</strong></h2><p><strong>A.</strong> いいえ。ダウングレードは出来ません。<br>アップグレード後に以前のバージョンに戻したいなどの場合には、一度 AADC をアンインストールし、お客様にて保持されているアップグレード前のインストール ファイルでインストール、構成し直す必要があります。  </p><h2 id="Q-Azure-AD-Connect-の旧バージョンのインストール-ファイルを提供して欲しい。"><a href="#Q-Azure-AD-Connect-の旧バージョンのインストール-ファイルを提供して欲しい。" class="headerlink" title="Q. Azure AD Connect の旧バージョンのインストール ファイルを提供して欲しい。"></a><strong>Q. Azure AD Connect の旧バージョンのインストール ファイルを提供して欲しい。</strong></h2><p><strong>A.</strong> テクニカル サポートでは提供していません。  </p><h2 id="Q-AADC-からの同期エラーの通知メールを受信した。受信者はどこで設定できるのか？"><a href="#Q-AADC-からの同期エラーの通知メールを受信した。受信者はどこで設定できるのか？" class="headerlink" title="Q. AADC からの同期エラーの通知メールを受信した。受信者はどこで設定できるのか？"></a><strong>Q. AADC からの同期エラーの通知メールを受信した。受信者はどこで設定できるのか？</strong></h2><p><strong>A.</strong> 同期処理での問題について、通知は 2 通りあります。<br>それぞれ通知メールの送信元が異なります。<br> Azure AD Connect Health Agent : <a href="mailto:&#97;&#x7a;&#117;&#114;&#101;&#x2d;&#x6e;&#111;&#114;&#101;&#x70;&#x6c;&#x79;&#64;&#x6d;&#105;&#99;&#x72;&#x6f;&#x73;&#111;&#x66;&#x74;&#x2e;&#x63;&#x6f;&#109;">&#97;&#x7a;&#117;&#114;&#101;&#x2d;&#x6e;&#111;&#114;&#101;&#x70;&#x6c;&#x79;&#64;&#x6d;&#105;&#99;&#x72;&#x6f;&#x73;&#111;&#x66;&#x74;&#x2e;&#x63;&#x6f;&#109;</a><br> 同期エンジン : <a href="mailto:&#77;&#83;&#x4f;&#110;&#108;&#105;&#110;&#x65;&#x53;&#101;&#x72;&#118;&#x69;&#x63;&#x65;&#x73;&#x54;&#101;&#x61;&#109;&#x40;&#77;&#105;&#99;&#x72;&#111;&#x73;&#111;&#x66;&#x74;&#x4f;&#x6e;&#x6c;&#105;&#x6e;&#101;&#46;&#x63;&#111;&#109;">&#77;&#83;&#x4f;&#110;&#108;&#105;&#110;&#x65;&#x53;&#101;&#x72;&#118;&#x69;&#x63;&#x65;&#x73;&#x54;&#101;&#x61;&#109;&#x40;&#77;&#105;&#99;&#x72;&#111;&#x73;&#111;&#x66;&#x74;&#x4f;&#x6e;&#x6c;&#105;&#x6e;&#101;&#46;&#x63;&#111;&#109;</a><br> 各設定方法について、下記ドキュメントをご確認ください。  </p><ul><li>Azure AD Connect Health Agent 通知先設定手順<br>設定箇所 :  [Azure ポータル] - [Azure AD Connect] - [Azure AD Connect Health] - [同期エラー] - [通知設定]<br>設定項目 : 追加の電子メール受信者<br><a href="https://portal.azure.com/#blade/Microsoft_Azure_ADHybridHealth/AadHealthMenuBlade/SyncErros">https://portal.azure.com/#blade/Microsoft_Azure_ADHybridHealth/AadHealthMenuBlade/SyncErros</a>  </li></ul><p>  <a href="../azure-active-directory-connect/azureadconnect_faq/AADCH_alert.pdf">AADCH_alert (PDF)</a></p><ul><li>同期エンジン通知先設定手順<br>設定箇所 : [Azure ポータル] – [Azure Active Directory] –[通知の設定]<br>設定項目 : 連絡先の電子メール<br><a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Notifications">https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Notifications</a>  </li></ul><p>  <a href="../azure-active-directory-connect/azureadconnect_faq/SyncEngine_alert.pdf">SyncEngine_alert (PDF)</a></p><h2 id="Q-AADC-のサポート対応中のバージョン、サポート有効期間は？"><a href="#Q-AADC-のサポート対応中のバージョン、サポート有効期間は？" class="headerlink" title="Q. AADC のサポート対応中のバージョン、サポート有効期間は？"></a><strong>Q. AADC のサポート対応中のバージョン、サポート有効期間は？</strong></h2><p><strong>A.</strong> 現時点でリリース済みのすべてのバージョンがサポート対象です。<br>2020 年 11 月より非推奨プロセスが開始されます。<br>詳細については下記記事をご参照ください。  </p><p><a href="/blog/azure-active-directory-connect/how-to-upgrade/">Azure AD Connect アップグレード手順</a>  </p><h2 id="Q-AADC-をインストール時に既定で生成されるグループは？"><a href="#Q-AADC-をインストール時に既定で生成されるグループは？" class="headerlink" title="Q. AADC をインストール時に既定で生成されるグループは？"></a><strong>Q. AADC をインストール時に既定で生成されるグループは？</strong></h2><p><strong>A.</strong> 下記の 4 グループが生成されます。  </p><ol><li><strong>ADSyncAdmins</strong><br>本グループのメンバーは、Azure AD Connect 同期サービスマネージャーにおけるすべてのアクセス権を持ちます。<br>インストール ウィザードを実行したユーザーは、既定でこのグループに追加されます。     </li><li><strong>ADSyncBrowsers</strong><br>このグループのメンバーは、WMI を使ったパスワードのリセット時にユーザーの情報を集める権限を持ちます。    </li><li><strong>ADSyncOperators</strong><br>このグループのメンバーは、Azure AD Connect 同期サービス マネージャーを操作する権限を持ちます。<br>この操作には例えば次のようなものが含まれます。  </li></ol><ul><li>管理エージェントを実行する  </li><li>実行した結果（同期状況）の確認する  </li><li>実行履歴をファイルにエクスポートする<br>なお、このグループのメンバーは ADSyncBrowsers グループに所属している必要があります。    </li></ul><ol start="4"><li><strong>ADSyncPasswordReset</strong><br>このグループのメンバーは、WMI を通して行われるパスワード管理のすべての操作ができる権限を持ちます。<br>なお、このグループのメンバーは ADSyncBrowsers グループに所属している必要があります。</li></ol><p>  </p><h2 id="Q-AADC-の同期間隔を変更する方法は？"><a href="#Q-AADC-の同期間隔を変更する方法は？" class="headerlink" title="Q. AADC の同期間隔を変更する方法は？"></a><strong>Q. AADC の同期間隔を変更する方法は？</strong></h2><p><strong>A.</strong> 下記コマンドにて変更可能です。 </p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Set-ADSyncScheduler</span> <span class="literal">-CustomizedSyncCycleInterval</span> &lt;任意の時間&gt;  </span><br></pre></td></tr></table></figure><p>例 (60 分に設定する場合)</p><pre><code class="PowerShell">Set-ADSyncScheduler -CustomizedSyncCycleInterval 00:60:00  </code></pre><p> <br>最も高頻度に同期を行う間隔として 30 分間隔となります。<br>CustomizedSyncCycleInterval での設定値が 30 分よりも低い数値 (10 分間隔などに) 設定された場合では、その設定値は無視され、30 分間隔で処理されます。  </p><h2 id="Q-AADC-の定期同期を普段は停止しておき、運用の必要性が生じたタイミングだけ同期させても良いか？"><a href="#Q-AADC-の定期同期を普段は停止しておき、運用の必要性が生じたタイミングだけ同期させても良いか？" class="headerlink" title="Q. AADC の定期同期を普段は停止しておき、運用の必要性が生じたタイミングだけ同期させても良いか？"></a><strong>Q. AADC の定期同期を普段は停止しておき、運用の必要性が生じたタイミングだけ同期させても良いか？</strong></h2><p><strong>A.</strong> 定期的な同期が維持されるようにしてください。<br> <br>同期処理を長期間停止している前提で、改めて同期処理を開始しようとした際に、初回の Import 処理に時間がかかり且つ最終的に stopped-server-down で Import 処理が失敗する場合があります。<br>これは、数日間同期を行わない期間があった場合、処理されずに滞留していた情報があり、同期の再開時にまとめて処理されることに起因して AAD からの Delta Import 処理が AADC 内部で進まなくなる場合があるためです。<br> <br>数日のような長期にわたって同期を行わないことは想定されていないため、定期的な同期を維持してください。<br>どうしても長期的な同期停止後に同期を再開する必要がある場合は、下記コマンドにて完全同期を実施してください。<br> <br>今すぐ完全同期を開始する場合  </p><pre><code class="PowerShell">Start-AdSyncSyncCycle Initial  </code></pre><p> <br>次回のスケジュール同期を完全同期として実行する場合</p><pre><code class="PowerShell">Set-ADSyncScheduler -NextSyncCyclePolicyType Initial</code></pre><h2 id="Q-完全同期-Start-ADSyncSyncCycle-PolicyType-Initial-の所要時間は？"><a href="#Q-完全同期-Start-ADSyncSyncCycle-PolicyType-Initial-の所要時間は？" class="headerlink" title="Q. 完全同期 (Start-ADSyncSyncCycle -PolicyType:Initial) の所要時間は？"></a><strong>Q. 完全同期 (Start-ADSyncSyncCycle -PolicyType:Initial) の所要時間は？</strong></h2><p><strong>A.</strong> オブジェクト内容、同期ルール内容、サーバースペック、ネットワーク パフォーマンスに依存して正確な値を算出することは出来ません。<br>参考値となりますが、オンプレミス Active Directory で 2 万ユーザーではドメイン コントローラー &lt;=&gt; Azure AD Connect では約 30 MB , Azure AD Connect &lt;=&gt; Azure AD では約 240 MB の通信が生じていることが確認出来、30 分程度の時間を要しました。 (オブジェクト自体は必要最低限の情報となり、そのサイズ自体も所要時間に影響を及ぼすものとなります)<br>弊社過去事例からは、同期対象のオブジェクト数が 2 万程度の場合、完全同期が完了するまでに 1 ~ 3 時間ほどを要し、10 万オブジェクトほどの場合はおおよそ 4 ~ 9 時間を要したことを確認しています。   </p><h2 id="Q-Synchronization-Service-Manager-で-Operations-タブのみ表示されている-Connectors-などが表示されない-。"><a href="#Q-Synchronization-Service-Manager-で-Operations-タブのみ表示されている-Connectors-などが表示されない-。" class="headerlink" title="Q. Synchronization Service Manager で Operations タブのみ表示されている (Connectors などが表示されない) 。"></a><strong>Q. Synchronization Service Manager で Operations タブのみ表示されている (Connectors などが表示されない) 。</strong></h2><p><strong>A.</strong> サインインしているユーザーが ADSyncBrowse / ADSyncOperator グループにのみ所属していることが原因となります 。<br>Synchronization Rules Editor でも操作は制限され、読み取り権限 (Add ボタンは表示されますが、保存不可) のみとなります。  </p><p><img src="/jpazureid-test/azure-active-directory-connect/azureadconnect_faq/ssm_operations.jpg"></p><h2 id="Q-同期対象-OU-を個別に設定しているが、新規で-OU-を作成した場合には、同期対象となるのか？"><a href="#Q-同期対象-OU-を個別に設定しているが、新規で-OU-を作成した場合には、同期対象となるのか？" class="headerlink" title="Q. 同期対象 OU を個別に設定しているが、新規で OU を作成した場合には、同期対象となるのか？"></a><strong>Q. 同期対象 OU を個別に設定しているが、新規で OU を作成した場合には、同期対象となるのか？</strong></h2><p><strong>A.</strong> 作成した OU の親 OU が同期対象か否かで変わります。<br>  追加した OU の親 OU が同期対象であれば、新規で追加された OU も同期対象となり、逆に親 OU が同期対象外であれば、子 OU も同期対象外となります。<br>  ルート OU 直下の OU も同様となり、ルート OU が親 OU となります。  </p><h2 id="Q-同期対象-OU-を個別に設定しているが、オンプレミス側で-OU-を移動した場合には、同期対象となるのか？"><a href="#Q-同期対象-OU-を個別に設定しているが、オンプレミス側で-OU-を移動した場合には、同期対象となるのか？" class="headerlink" title="Q. 同期対象 OU を個別に設定しているが、オンプレミス側で OU を移動した場合には、同期対象となるのか？"></a><strong>Q. 同期対象 OU を個別に設定しているが、オンプレミス側で OU を移動した場合には、同期対象となるのか？</strong></h2><p><strong>A.</strong> 同期対象の状態は維持されます。<br>  例えば、親 OU / 子 OU 双方が同期対象状態となっている状態で、オンプレミス側で OU の配置を変更し、子 OU のみ非同期対象の OU 配下に移動した場合、子 OU の同期状態は維持されます。<br>  解除する必要がある場合には、Azure AD Connect インストール ウィザードから個別に選択を解除する必要があります。</p><h2 id="Q-Azure-AD-のみのクラウドユーザーをオンプレミス-Active-Directory-に書き戻せないか？"><a href="#Q-Azure-AD-のみのクラウドユーザーをオンプレミス-Active-Directory-に書き戻せないか？" class="headerlink" title="Q. Azure AD のみのクラウドユーザーをオンプレミス Active Directory に書き戻せないか？"></a><strong>Q. Azure AD のみのクラウドユーザーをオンプレミス Active Directory に書き戻せないか？</strong></h2><p><strong>A.</strong> クラウド ユーザーを書き戻す機能は実装していません。オンプレミス Active Directory 上で手動で作成し、ソフトマッチを行って同期ユーザーとしてご利用ください。  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt; &lt;br&gt;Azure AD Connect (AADC) のお問い合わせが多いご質問について、Q&amp;amp;A 形式でおまとめいたしました。&lt;br&gt;既存のドキュメントではカバーされていない動作や質問について今後も適宜内容を拡充していきますので、ご参照いただければと思います。 </summary>
      
    
    
    
    
    <category term="AAD Connect" scheme="https://georgioush.github.io/jpazureid-test/tags/AAD-Connect/"/>
    
  </entry>
  
  <entry>
    <title>ソフトマッチによる Azure AD (Office 365) 上のユーザーをオンプレミス Active Directory ユーザーと紐付ける方法</title>
    <link href="https://georgioush.github.io/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/"/>
    <id>https://georgioush.github.io/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/</id>
    <published>2020-09-22T15:00:00.000Z</published>
    <updated>2021-02-27T19:13:43.612Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの菊池です。</p><p>Azure AD 上のユーザーをオンプレミス Active Drectory ユーザーと紐づける方法として、ハードマッチとソフトマッチと呼ばれる方法があります。<br>今回はソフトマッチについてご紹介します。</p><h2 id="ソフトマッチとは"><a href="#ソフトマッチとは" class="headerlink" title="ソフトマッチとは ?"></a>ソフトマッチとは ?</h2><p>ソフトマッチとは、Azure AD 上のユーザーとオンプレミス AD 上のユーザーを proxyAddresses または UserPrincipalName (UPN) で紐づけて、同期させる手法のことをいいます。基本的にはユーザーを紐づける必要がある場合には、ソフトマッチを利用することを推奨します。<br>ソフトマッチができない場合にはハードマッチと呼ばれる方法で直接的に同期時にオブジェクトの一意性を確保するソースアンカーと呼ばれる ID 情報 (ImmutableID) を紐づけます。ハードマッチによる同期をおこなう手順については <a href="/blog/azure-active-directory-connect/upn-hard-match/">ハードマッチによる Azure AD (Office 365) 上のユーザーをオンプレミス Active Directory ユーザーと紐付ける方法</a> をご参照ください。</p><p>ソフトマッチする前と後の例：</p><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s2.png"></p><p>ハードマッチの例：</p><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s1.png"></p><h2 id="マッチングを行うことでできることと注意点"><a href="#マッチングを行うことでできることと注意点" class="headerlink" title="マッチングを行うことでできることと注意点"></a>マッチングを行うことでできることと注意点</h2><p>マッチングによって、すでに利用している Azure AD 上のアカウントにオンプレミス AD 上のアカウントを紐づけることができます。そのため、オンプレミス AD 側と同じ UPN (サインイン用 ID)、パスワードで Azure AD の認証が必要なアプリケーション (Office 365 など) を利用できるようになります。一方で、マッチング後はオンプレミス AD から Azure AD へ同期が行われるため、 Azure AD 側でのユーザー情報の変更はできなくなります。また、一度ソフトマッチで同期された場合、Azure AD 側のユーザーに ImmutableID が設定され、この値は削除できないため非同期に戻すことはできません。</p><h2 id="マッチング順位"><a href="#マッチング順位" class="headerlink" title="マッチング順位"></a>マッチング順位</h2><p>Azure AD Connect では、同期処理を行う際、以下の流れでオンプレミス AD 側のオブジェクトと Azure AD 側のオブジェクトのマッチングを確認します。</p><ol><li>ソースアンカー (ImmutableID) の値が同じオブジェクトがあるか -&gt; ハードマッチ</li><li>proxyAddresses/mail の値が同じオブジェクトがあるか -&gt; SMTP ソフトマッチ</li><li>UPN の値が同じオブジェクトがあるか -&gt; UPN ソフトマッチ</li></ol><p>マッチするオブジェクトがある場合は、そのオブジェクトに対して同期が行われます。<br>マッチするオブジェクトが無い場合は、Azure AD 側に新たにオブジェクトが作成されます。</p><p>以下、SMTP と UPN でソフトマッチをする手順について説明します。</p><hr><h2 id="ユーザーをソフトマッチする手順"><a href="#ユーザーをソフトマッチする手順" class="headerlink" title="ユーザーをソフトマッチする手順"></a>ユーザーをソフトマッチする手順</h2><h3 id="・-SMTP-ソフトマッチ"><a href="#・-SMTP-ソフトマッチ" class="headerlink" title="・ SMTP ソフトマッチ"></a>・ SMTP ソフトマッチ</h3><ol><li>オンプレミス AD 側の Domain Controller で Azure AD 上のユーザーと紐づけたいオンプレミス AD のユーザーのプロパティを開き、[Attribute Editor] にある [proxyAddresses] をダブルクリックする。</li></ol><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s3.png"></p><ol start="2"><li>紐づけたい Azure AD 上のユーザーのメールアドレスと同じ値をプライマリ アドレスとして登録する。</li></ol><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s4.png"></p><ol start="3"><li>同期対象の OU にユーザーを移動する。</li></ol><ol start="4"><li>Azure AD Connect で同期する。(start-adsyncsynccycle)</li></ol><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s5.png"></p><ol start="5"><li>Azure AD で、変更箇所が確認できる。ソフトマッチされた場合、[同期されたディレクトリ] が “はい” になり、ユーザーのプロファイル画面にある [ソース] が “Windows Server AD” になる。</li></ol><h4 id="・-mail-ソフトマッチ"><a href="#・-mail-ソフトマッチ" class="headerlink" title="・ mail ソフトマッチ"></a>・ mail ソフトマッチ</h4><p>SMTP ソフトマッチは、mail 属性でも行うことが可能です。　</p><ol><li>オンプレミス AD 側のドメイン コントローラーで Azure AD 上のユーザーと紐づけたいオンプレミス AD のユーザーの [E-mail] に、Azure AD 上のユーザーのメールアドレスを設定する。</li></ol><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s6.png"></p><ol start="2"><li><p>同期対象の OU にユーザーを移動する。</p></li><li><p>Azure AD Connect で同期する。(start-adsyncsynccycle)</p></li><li><p>Azure AD で、変更箇所が確認できる。ソフトマッチされた場合、[同期されたディレクトリ] が “はい” になり、ユーザーのプロファイル画面にある [ソース] が “Windows Server AD” になる。</p></li></ol><h3 id="・-UPN-ソフトマッチ"><a href="#・-UPN-ソフトマッチ" class="headerlink" title="・ UPN ソフトマッチ"></a>・ UPN ソフトマッチ</h3><p>UPN ソフトマッチは、 proxyAddresses が一致しておらず、オンプレミス AD 側、Azure AD 側で同じ UPN を持つユーザーがいる場合に有効です。</p><ol><li><p>オンプレミス AD 側のドメイン コントローラーで Azure AD 上のユーザーと紐づけたいオンプレミス AD のユーザーの UPN が同じであることを確認する。</p></li><li><p>紐づけるユーザーを同期対象の OU に移動する。</p></li><li><p>Azure AD Connect で同期する。(start-adsyncsynccycle)</p></li><li><p>Azure AD で、変更箇所が確認できる。ソフトマッチされた場合、[同期されたディレクトリ] が “はい” になり、ユーザーのプロファイル画面にある [ソース] が “Windows Server AD” になる。</p></li></ol><h2 id="シナリオ例"><a href="#シナリオ例" class="headerlink" title="シナリオ例"></a>シナリオ例</h2><h3 id="パターン-1"><a href="#パターン-1" class="headerlink" title="パターン 1"></a>パターン 1</h3><p><strong>Azure AD 上のユーザーの proxyAddresses と同じ UPN、プロキシ アドレスを持つユーザーがオンプレミス AD 上にいる場合：</strong></p><p>Azure AD 上のユーザーの proxyAddresses とオンプレミス AD 上のユーザーの proxyAddresses でマッチングされる。同期が行われても、Azure AD 上のユーザーの proxyAddresses と UPN の値に変更はない。</p><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s7.png"></p><h3 id="パターン-2"><a href="#パターン-2" class="headerlink" title="パターン 2"></a>パターン 2</h3><p><strong>Azure AD 上のユーザーと同じ UPN の値をもつ、ユーザーがオンプレミス AD 上にいる場合 (オンプレミス AD 上のユーザーは proxyAddresses を持っていない) ：</strong></p><p>Azure AD 上のユーザーの UPN とオンプレミス AD 上のユーザーの UPN でマッチングされる。同期が行われても、Azure AD 上のユーザーの proxyAddresses と UPN の値に変更はない。</p><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s8.png"></p><h3 id="パターン-3"><a href="#パターン-3" class="headerlink" title="パターン 3"></a>パターン 3</h3><p><strong>UPN と proxyAddresses の値が同じ Azure AD 上のユーザーと、そのユーザーと同じ proxyAddresses の値を持つが UPN の値は異なるオンプレミス AD 上にいるユーザーをソフトマッチする場合：</strong></p><p>Azure AD 上のユーザーの proxyAddresses とオンプレミス AD 上のユーザーの proxyAddresses でマッチングされ、Azure AD 上の UPN の値がオンプレミス AD 上の UPN の値に変化する。</p><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s9.png"></p><h3 id="パターン-4"><a href="#パターン-4" class="headerlink" title="パターン 4"></a>パターン 4</h3><p><strong>UPN と proxyAddresses の値が異なる Azure AD 上のユーザーと、そのユーザーの proxyAddresses と同じ UPN と proxyAddresses の値を持つオンプレミス AD 上にいるユーザーをソフトマッチする場合：</strong></p><p>Azure AD 上のユーザーの proxyAddresses とオンプレミス AD 上のユーザーの proxyAddresses でマッチングされ、Azure AD 上の UPN の値がオンプレミス AD 上の UPN の値に変化する。</p><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s10.png"></p><h3 id="パターン-5"><a href="#パターン-5" class="headerlink" title="パターン 5"></a>パターン 5</h3><p><strong>Azure AD 上のユーザーの proxyAddresses と同じ UPN、プロキシ アドレスを持つユーザーがオンプレミス AD 上にいるが、Azure AD 上のユーザーは一度すでに別のユーザーと同期済みで ImmutableID が生成されている場合：</strong></p><p>ImmutableID が Azure AD 側のユーザーにすでに生成されているのでソフトマッチはされない。マッチングしたい場合は、ハードマッチのみが有効であるため、オンプレミス AD 側のユーザーの sourceAnchor の値を Azure AD 側のユーザーの ImmutableID の値に揃える。</p><p><img src="/jpazureid-test/azure-active-directory-connect/aboutSoftMatching/s11.png"></p><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><h3 id="グループオブジェクト"><a href="#グループオブジェクト" class="headerlink" title="グループオブジェクト"></a>グループオブジェクト</h3><p>セキュリティグループ、配布グループ の proxyAddresses と オンプレ AD のグループ オブジェクトをマッチさせることが可能です。(※ Microsoft 365 グループはソフトマッチが行われません。) 注意点といたしまして、ソフトマッチ実施の際に、グループ オブジェクトのメンバーが Azure AD と オンプレミス AD で異なる場合は、オンプレミス AD のメンバー情報で上書きされます。</p><h3 id="管理者はソフトマッチされません"><a href="#管理者はソフトマッチされません" class="headerlink" title="管理者はソフトマッチされません"></a>管理者はソフトマッチされません</h3><p>オンプレミスの AD 上のユーザーと、管理ロールが割り当てられている Azure AD 上のユーザーをソフトマッチさせることはできません。そのため、ソフトマッチを行うためには、管理者ロールを一時的に外し、ソフトマッチを行ってから管理者ロールを割り当てなおします。詳しくは、<a href="https://docs.microsoft.com/ja-jp/azure/active-directory/hybrid/tshoot-connect-sync-errors#existing-admin-role-conflict">既存の管理者ロールの競合</a>をご覧ください。</p><p>上記内容が少しでも皆様の参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの菊池です。&lt;/p&gt;
&lt;p&gt;Azure AD 上のユーザーをオンプレミス Active Drectory ユーザーと紐づける方法として、ハードマッチとソフトマッチと呼ばれる方法があります。&lt;br&gt;今回はソ</summary>
      
    
    
    
    
    <category term="UPN" scheme="https://georgioush.github.io/jpazureid-test/tags/UPN/"/>
    
    <category term="AAD Connect" scheme="https://georgioush.github.io/jpazureid-test/tags/AAD-Connect/"/>
    
    <category term="Soft matching" scheme="https://georgioush.github.io/jpazureid-test/tags/Soft-matching/"/>
    
    <category term="SMTP" scheme="https://georgioush.github.io/jpazureid-test/tags/SMTP/"/>
    
  </entry>
  
</feed>
